<!DOCTYPE html>
<html>

<head>
    <link rel="icon" href="data:,">
    <title>–ö–∞—Ä—Ç–∞ –æ–±—ä–µ–∫—Ç–æ–≤ - –ê–ù–û "–°–ú–ì"</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#8B0000">

    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=52007aca-39bd-4a9c-87ef-4d9b730aeb71"
        type="text/javascript"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #f0f2f5;
            /* üî• –í–ê–ñ–ù–û –î–õ–Ø –°–í–ê–ô–ü–û–í –ù–ê –ú–û–ë–ò–õ–¨–ù–´–• */
            touch-action: pan-y;
            overscroll-behavior: none;
        }

        .hidden {
            display: none !important;
        }

        /* üî• Custom Dropdown Styles (Reassign) */
        .custom-select-container {
            position: relative;
            font-family: 'Inter', sans-serif;
            margin-top: 5px;
        }

        .select-selected {
            background-color: #fff;
            border: 2px solid #6b46c1;
            /* Purple accent like reference */
            border-radius: 8px;
            padding: 12px 15px;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            color: #4a5568;
            transition: all 0.2s;
        }

        .select-selected:after {
            content: "";
            width: 0;
            height: 0;
            border: 6px solid transparent;
            border-color: #6b46c1 transparent transparent transparent;
            margin-top: 5px;
        }

        .select-selected.select-arrow-active:after {
            border-color: transparent transparent #6b46c1 transparent;
            margin-top: -5px;
        }

        .select-items {
            position: absolute;
            background-color: #fff;
            top: 110%;
            left: 0;
            right: 0;
            z-index: 9999;
            border: 2px solid #6b46c1;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            display: none;
            max-height: 250px;
            overflow-y: auto;
        }

        .select-show {
            display: block;
            animation: fadeIn 0.15s ease-out;
        }

        .select-items div {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #edf2f7;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #2d3748;
            transition: background 0.15s;
        }

        .select-items div:last-child {
            border-bottom: none;
        }

        .select-items div:hover {
            background-color: #ebf4ff;
            color: #2b6cb0;
        }

        .select-items div.same-as-selected {
            background-color: #ebf4ff;
            font-weight: 600;
            color: #2b6cb0;
        }

        .select-items div.disabled-option {
            color: #a0aec0;
            cursor: not-allowed;
            background-color: #f7fafc;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* üî• –°–¢–ò–õ–ò –õ–û–ì–ò–ù–ê */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 20px;
        }

        .login-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .login-header h2 {
            color: #8B0000;
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .login-header p {
            font-size: 0.9rem;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
            font-size: 0.9rem;
        }

        .form-group select,
        .form-group input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group select:focus,
        .form-group input:focus {
            border-color: #8B0000;
            outline: none;
        }

        .login-button {
            background: linear-gradient(135deg, #1f6fb2, #3498db);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .login-button:hover {
            background: linear-gradient(135deg, #2f86c9, #3498db);
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
        }

        /* üî• –ß–ï–ö–ë–û–ö–° –ó–ê–ü–û–ú–ù–ò–¢–¨ –ü–ê–†–û–õ–¨ */
        .remember-password {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 10px 0;
        }

        .remember-password input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin: 0;
            appearance: none;
            -webkit-appearance: none;
            border: 2px solid #333;
            border-radius: 3px;
            background: white;
            cursor: pointer;
            position: relative;
        }

        .remember-password input[type="checkbox"]:checked {
            background: white;
            border-color: #333;
        }

        .remember-password input[type="checkbox"]:checked::after {
            content: "‚úï";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #000;
            font-size: 12px;
            font-weight: bold;
        }

        .remember-password label {
            margin-bottom: 0;
            font-weight: normal;
            color: #555;
            font-size: 14px;
        }

        /* üî• –°–¢–ò–õ–ò –ß–ï–ö–ë–û–ö–°–û–í –í –§–ò–õ–¨–¢–†–ê–• */
        .checkbox-item input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #333;
            border-radius: 3px;
            background: white;
            cursor: pointer;
            position: relative;
            margin-right: 8px;
        }

        .checkbox-item input[type="checkbox"]:checked {
            background: white;
            border-color: #333;
        }

        .checkbox-item input[type="checkbox"]:checked::after {
            content: "‚úï";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #000;
            font-size: 14px;
            font-weight: bold;
        }

        .checkbox-item input[type="checkbox"]:hover {
            border-color: #666;
        }

        /* üî• –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° */
        .user-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        /* üî• –£–ë–ò–†–ê–ï–ú –°–¢–ê–†–´–ï –ü–ê–ù–ï–õ–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø */
        .admin-controls,
        .inspector-controls,
        .work-day-status {
            display: none !important;
        }

        .container {
            display: flex;
            height: 100vh;
            flex-direction: row;
        }

        /* üî• –ü–ï–†–ï–î–ï–õ–ê–ù–ù–´–ô –°–ê–ô–î–ë–ê–† */
        .sidebar {
            width: 400px;
            height: 100vh;
            background: white;
            padding: 15px;
            border-right: 2px solid #dee2e6;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        /* üî• –ö–ù–û–ü–ö–ê –°–ö–†–´–¢–ò–Ø –°–ê–ô–î–ë–ê–†–ê */
        .sidebar-toggle {
            position: absolute;
            top: 50%;
            right: -15px;
            transform: translateY(-50%);
            background: #8B0000;
            color: white;
            border: none;
            width: 15px;
            height: 60px;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            z-index: 101;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
        }

        .sidebar.collapsed {
            transform: translateX(-385px);
        }

        .sidebar.collapsed .sidebar-toggle {
            right: -40px;
        }

        .map-container {
            flex: 1;
            position: relative;
            height: 100vh;
            transition: margin-left 0.3s ease;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .header {
            background: #8B0000;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: left;
        }

        /* üî• –ù–û–í–´–ï –°–ï–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –í –°–ê–ô–î–ë–ê–†–ï */
        .control-section {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
        }

        .control-section-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* üî• –ö–ù–û–ü–ö–ò –§–ò–õ–¨–¢–†–û–í (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∫–∞–∫ "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ—Ö") */
        .control-button,
        .list-control-button {
            padding: 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: bold;
            text-align: center;
            background: linear-gradient(135deg, #1f6fb2, #3498db);
            color: white;
            transition: all 0.3s ease;
            flex: 1;
        }

        /* üî• –ê–î–ú–ò–ù–°–ö–ò–ï –ö–ù–û–ü–ö–ò (—Ç–∞–∫–æ–π –∂–µ —Å—Ç–∏–ª—å, –Ω–æ –º–µ–Ω—å—à–µ) */
        .admin-btn,
        .inspector-btn,
        .close-day-btn {
            padding: 6px 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: bold;
            text-align: center;
            color: white;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            width: 100%;
            margin-bottom: 4px;
        }

        /* –•–æ–≤–µ—Ä-—ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ */
        .control-button:hover,
        .list-control-button:hover,
        .admin-btn:hover {
            background: linear-gradient(135deg, #2f86c9, #3498db);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* üî• –¶–í–ï–¢–ê –î–õ–Ø –†–ê–ó–ù–´–• –¢–ò–ü–û–í –ö–ù–û–ü–û–ö */
        .admin-btn {
            background: linear-gradient(135deg, #1f6fb2, #3498db);
        }

        .admin-btn:hover {
            background: linear-gradient(135deg, #2f86c9, #3498db);
        }

        .inspector-btn {
            background: #90EE90;
            color: #006400;
        }

        .inspector-btn:hover {
            background: #7CFC00;
            color: #006400;
        }

        .close-day-btn {
            background: #FFB6C1;
            color: #8B0000;
        }

        .close-day-btn:hover {
            background: #FF69B4;
            color: #8B0000;
        }

        .close-day-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #FFB6C1;
            color: #8B0000;
        }

        .close-day-btn:disabled:hover {
            background: #FFB6C1;
            color: #8B0000;
            transform: none;
            box-shadow: none;
        }

        /* üî• –°–ï–¢–ö–ê –î–õ–Ø –ê–î–ú–ò–ù–°–ö–ò–• –ö–ù–û–ü–û–ö */
        .control-buttons-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 6px;
            margin-bottom: 8px;
        }

        /* üî• –ö–ù–û–ü–ö–ò –í –§–ò–õ–¨–¢–†–ê–• */
        .control-buttons,
        .list-control-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .work-day-indicator {
            padding: 8px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.8rem;
            text-align: center;
            margin-top: 8px;
            border: 2px solid;
        }

        .work-day-indicator.open {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }

        .work-day-indicator.closed {
            background: #f8d7da;
            color: #721c24;
            border-color: #f1b0b7;
        }

        .filter-section {
            margin-bottom: 15px;
        }

        .filter-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.9rem;
        }

        .checkbox-group {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 8px;
            border-radius: 5px;
            background: white;
        }

        .checkbox-item {
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            padding: 4px;
            font-size: 0.85rem;
        }

        .checkbox-item input {
            margin-right: 6px;
        }

        .color-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
            display: inline-block;
        }

        .inspector-icon {
            margin-right: 6px;
            font-size: 14px;
        }

        .inspector-counter {
            margin-left: auto;
            font-size: 10px;
            font-weight: bold;
            color: #666;
            background: #f8f9fa;
            padding: 2px 5px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
            min-width: 25px;
            text-align: center;
        }

        .inspector-counter.completed {
            color: #27ae60;
            background: #d4edda;
            border-color: #c3e6cb;
        }

        .inspector-counter.admin {
            color: #00FF7F;
            background: #e6fff2;
            border-color: #00FF7F;
        }

        .inspector-counter.inactive {
            color: #999;
            background: #f0f0f0;
            border-color: #ddd;
        }

        #orgLogo {
            width: 28px;
            height: 28px;
            object-fit: contain;
            display: block;
            border-radius: 4px;
        }

        /* üî• –°–ß–ï–¢–ß–ò–ö–ò –î–õ–Ø –°–ü–ò–°–ö–û–í */
        .list-counter {
            font-size: 10px;
            font-weight: bold;
            color: #666;
            background: #f8f9fa;
            padding: 2px 5px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
            margin-left: 6px;
        }

        .search-box {
            width: 100%;
            padding: 8px;
            margin-bottom: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .control-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .control-button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #3498db;
            color: white;
            font-size: 0.85rem;
        }

        .control-button:hover {
            background: #2980b9;
        }

        /* üî• –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –§–ò–õ–¨–¢–†–û–í –°–ü–ò–°–ö–û–í */
        .list-control-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .list-control-button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #3498db;
            color: white;
            font-size: 0.85rem;
        }

        .list-control-button:hover {
            background: #2980b9;
        }

        .stats {
            background: #34495e;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.85rem;
            text-align: center;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #1f6fb2, #3498db);
            color: white;
            border: none;
            padding: 12px;
            /* Increased padding to match login button */
            border-radius: 8px;
            /* Matching radius */
            cursor: pointer;
            width: 100%;
            margin-bottom: 12px;
            font-size: 0.9rem;
            /* Slightly larger text */
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: linear-gradient(135deg, #2f86c9, #3498db);
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
        }

        .refresh-btn.force {
            background: #e67e22;
        }

        .refresh-btn.force:hover {
            background: #d35400;
        }

        .notification {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 12px 15px;
            border-radius: 5px;
            color: white;
            z-index: 1000;
            font-weight: bold;
            max-width: 280px;
            font-size: 0.9rem;
        }

        .notification.success {
            background: #27ae60;
        }

        .notification.error {
            background: #e74c3c;
        }

        /* üî• –¢–ê–ë–´ –ò –°–ü–ò–°–ö–ò –û–ë–™–ï–ö–¢–û–í */
        .tab-buttons {
            display: flex;
            margin-bottom: 12px;
            border-bottom: 2px solid #dee2e6;
        }

        .tab-button {
            flex: 1;
            padding: 8px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: bold;
            color: #6c757d;
            border-bottom: 2px solid transparent;
        }

        .tab-button.active {
            color: #3498db;
            border-bottom: 2px solid #3498db;
        }

        .tab-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .tab-pane {
            flex: 1;
            display: none;
            flex-direction: column;
        }

        .tab-pane.active {
            display: flex;
        }

        .objects-list {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 15px;
            background: white;
        }

        .objects-list-title {
            background: #34495e;
            color: white;
            padding: 8px;
            font-weight: bold;
            text-align: center;
            border-radius: 5px 5px 0 0;
            font-size: 0.9rem;
        }

        .object-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
            font-size: 0.85rem;
        }

        .object-item:hover {
            background: #f8f9fa;
        }

        .object-item:last-child {
            border-bottom: none;
        }

        .object-id {
            font-weight: bold;
            color: #2c3e50;
            margin-right: 6px;
        }

        .object-address {
            flex: 1;
            font-size: 0.8rem;
            color: #555;
        }

        .object-inspector {
            font-size: 0.75rem;
            color: #7f8c8d;
            margin-top: 2px;
        }

        .object-status {
            margin-left: 8px;
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 8px;
        }

        /* üî• –°–¢–ò–õ–ò –ë–ê–õ–õ–£–ù–û–í –ò –ö–ù–û–ü–û–ö */
        .coordinates-btn {
            background: #9b59b6;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin: 2px;
            flex: 1;
        }

        .coordinates-btn:hover {
            background: #8e44ad;
        }

        .checklist-btn {
            background: #e67e22;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin: 2px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            flex: 1;
        }

        .checklist-btn:hover {
            background: #d35400;
        }

        .yandex-disk-btn {
            background: #ffcc00;
            color: #000;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin: 2px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            flex: 1;
            font-weight: bold;
        }

        .yandex-disk-btn:hover {
            background: #e6b800;
        }

        .button-group {
            display: flex;
            gap: 4px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .entry-exit-buttons {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }

        .entry-exit-buttons button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .entry-btn {
            background: linear-gradient(135deg, #1f6fb2, #3498db);
            color: white;
        }

        .entry-btn:hover {
            background: linear-gradient(135deg, #2f86c9, #3498db);
        }

        .exit-btn {
            background: #27ae60;
            color: white;
        }

        .exit-btn:hover {
            background: #219a52;
        }

        .cancel-entry-btn {
            background: #e74c3c;
            color: white;
        }

        .cancel-entry-btn:hover {
            background: #c0392b;
        }

        .reassign-select {
            width: 100%;
            padding: 6px;
            border: 2px solid #3498db;
            border-radius: 4px;
            margin-top: 5px;
            font-size: 0.8rem;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin: 4px 0;
            color: white;
        }

        .status-new {
            background: #e74c3c;
        }

        .status-completed {
            background: #27ae60;
        }

        .status-active {
            background: #3498db;
        }

        .entry-warning {
            background: #fff3cd;
            color: #856404;
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #ffeaa7;
            margin-top: 5px;
            font-size: 0.75rem;
            text-align: center;
        }

        /* üî• –°–¢–ò–õ–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ò–ù–°–ü–ï–ö–¢–û–†–ê–ú–ò */
        .inspector-management-menu {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -55%);
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            display: none;
            flex-direction: column;
            gap: 12px;
            width: 95%;
            max-width: 600px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .filter-access-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            text-align: center;
            font-size: 1rem;
        }

        .filter-access-section {
            margin-bottom: 12px;
        }

        .filter-access-section-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #555;
            font-size: 0.85rem;
        }

        .filter-access-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.85rem;
        }

        .filter-access-all {
            border-top: 2px solid #ddd;
            padding-top: 8px;
            margin-top: 8px;
        }

        .filter-access-buttons,
        .inspector-management-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            position: sticky;
            bottom: 0;
            background: white;
            padding: 12px 0;
            border-top: 2px solid #ddd;
        }

        .filter-access-buttons button,
        .inspector-management-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .save-access-btn,
        .save-management-btn {
            background: #27ae60;
            color: white;
        }

        .save-access-btn:hover,
        .save-management-btn:hover {
            background: #219a52;
        }

        .cancel-access-btn,
        .cancel-management-btn {
            background: #95a5a6;
            color: white;
        }

        .cancel-access-btn:hover,
        .cancel-management-btn:hover {
            background: #7f8c8d;
        }

        .accordion {
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 8px;
        }

        .accordion-header {
            background: #f8f9fa;
            padding: 10px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 0.85rem;
        }

        .accordion-header:hover {
            background: #e9ecef;
        }

        .accordion-content {
            padding: 12px;
            border-top: 1px solid #ddd;
            display: none;
        }

        .accordion-content.active {
            display: block;
        }

        .search-management {
            width: 100%;
            padding: 8px;
            margin-bottom: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.85rem;
        }

        .management-section {
            margin-bottom: 12px;
        }

        .management-section-title {
            font-weight: bold;
            margin-bottom: 6px;
            color: #555;
            font-size: 0.85rem;
        }

        .management-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .color-preview {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid #ddd;
        }

        /* üî• –ö–†–ê–°–ò–í–ê–Ø –ö–ù–û–ü–ö–ê –ü–†–ò–ú–ï–ù–ò–¢–¨ –ò–ó–ú–ï–ù–ï–ù–ò–Ø */
        .apply-changes-btn {
            background: linear-gradient(135deg, #27ae60, #219a52);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
            width: 100%;
            margin-top: 8px;
        }

        .apply-changes-btn:hover {
            background: linear-gradient(135deg, #219a52, #1e8449);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(39, 174, 96, 0.4);
        }

        .apply-changes-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(39, 174, 96, 0.3);
        }

        .select-all-btn {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            margin-bottom: 8px;
            width: 100%;
        }

        .select-all-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 5px;
        }

        .color-option {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: all 0.2s;
        }

        .color-option:hover {
            transform: scale(1.1);
            border-color: #333;
        }

        .color-option.selected {
            border-color: #333;
            transform: scale(1.2);
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }

        .icon-select,
        .status-select {
            width: 100%;
            padding: 6px;
            border: 2px solid #3498db;
            border-radius: 4px;
            margin-top: 5px;
            font-size: 0.85rem;
        }

        /* üî• –ú–û–ë–ò–õ–¨–ù–´–ô –†–ï–ñ–ò–ú - –ö–ù–û–ü–ö–ê –ü–ê–ù–ï–õ–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø */
        .mobile-toggle-btn {
            position: fixed;
            top: 100px;
            right: 25px;
            background: linear-gradient(135deg, #1f6fb2, #3498db);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            z-index: 1001;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: none;
        }

        .mobile-toggle-btn:hover {
            background: linear-gradient(135deg, #2f86c9, #3498db);
        }

        /* üî• –ë–õ–û–ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø */
        .user-info {
            position: fixed;
            top: 60px;
            right: 30px;
            background: white;
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .mobile-toggle-btn:hover {
            background: #2980b9;
        }

        .balloon-content {
            width: 90vw;
            max-width: 1200px;
            padding: 16px;
            background: #ffffff;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25);
            clip-path: polygon(16px 0, calc(100% - 16px) 0, 100% 16px, 100% calc(100% - 16px), calc(100% - 16px) 100%, 16px 100%, 0 calc(100% - 16px), 0 16px);
        }

        .balloon-content .button-group {
            width: 100%;
        }

        .workday-modal {
            position: fixed;
            inset: 0;
            display: none;
            z-index: 10001;
        }

        /* üî• iOS 26 LIQUID GLASS NOTIFICATIONS */
        .notification-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999999;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* Force centering of children */
            gap: 12px;
            pointer-events: none;
            width: auto;
            /* Fit content but max out */
            max-width: 90%;
        }

        .notification {
            position: relative;
            /* Ultra-Premium Liquid Glass */
            background: rgba(255, 255, 255, 0.45);
            /* More transparent */
            backdrop-filter: blur(50px) saturate(200%);
            /* Maximum blur */
            -webkit-backdrop-filter: blur(50px) saturate(200%);

            border: 1px solid rgba(255, 255, 255, 0.6);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);

            /* Complex shadow stack for "Thick Liquid" look */
            box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.15),
                /* Deep smooth drop shadow */
                inset 0 0 0 1px rgba(255, 255, 255, 0.5),
                /* Sharp inner rim */
                inset 0 10px 20px rgba(255, 255, 255, 0.5),
                /* Top highlight */
                inset 0 -10px 20px rgba(0, 0, 0, 0.05);
            /* Bottom depth */

            color: #1f2937;
            padding: 12px 30px;
            /* Wider padding */
            border-radius: 60px;
            /* Fully rounded pill */
            font-size: 0.95rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            animation: slideDownFade 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            /* Eloquent bounce */
            pointer-events: auto;
            transition: transform 0.3s ease, opacity 0.3s ease;
            cursor: grab;
            user-select: none;
            min-width: 320px;
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.5);
        }

        .notification.swipe-out {
            transform: translateY(-100px) scale(0.9);
            opacity: 0;
        }

        .notification-icon {
            font-size: 1.4rem;
            flex-shrink: 0;
        }

        @keyframes slideDownFade {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .workday-modal.hidden {
            display: none;
        }

        .workday-modal:not(.hidden) {
            display: block;
        }

        .workday-modal__backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 0;
        }

        .workday-modal__card {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -55%);
            width: 520px;
            max-width: 95%;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.25);
            padding: 16px;
            z-index: 1;
        }

        .workday-modal__close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
        }

        .workday-modal__content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .workday-actions {
            display: flex;
            gap: 10px;
        }

        .workday-actions .btn {
            flex: 1;
            padding: 10px 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: #fff;
        }

        .btn-secondary {
            background: #f0f3f6;
            color: #2c3e50;
        }

        .workday-comment {
            width: 100%;
            min-height: 72px;
            resize: vertical;
            border-radius: 10px;
            border: 1px solid #dfe6e9;
            padding: 10px;
        }

        .inspector-btn[disabled] {
            opacity: 0.55;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* üî• –ê–î–ê–ü–¢–ò–í–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–´–• */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: 100vh;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 1000;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                border-right: none;
                overflow-y: auto;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .sidebar-toggle {
                display: none;
            }

            .map-container {
                margin-left: 0 !important;
                height: 100vh;
            }

            .mobile-toggle-btn {
                display: block;
            }

            .user-info {
                top: 60px;
                right: 10px;
            }

            .inspector-management-menu {
                width: 98%;
                max-width: 98%;
            }

            .balloon-content {
                width: 95vw;
                max-width: 95vw;
                padding: 12px;
            }
        }

        .mgmt-tabs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }

        .mgmt-tab-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #1f6fb2, #3498db);
            color: #fff;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .mgmt-tab-btn:hover {
            background: linear-gradient(135deg, #2f86c9, #3498db);
        }

        .mgmt-tab-btn.active {
            background: linear-gradient(135deg, #1f6fb2, #3498db);
            color: #fff;
        }

        .mgmt-section {
            display: none;
        }

        .mgmt-section.active {
            display: block;
        }

        /* üî• –£–õ–£–ß–®–ï–ù–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–´–• –£–°–¢–†–û–ô–°–¢–í */
        @media (max-width: 480px) {
            .login-container {
                padding: 20px;
            }

            .login-header h2 {
                font-size: 1.3rem;
            }

            .login-header p {
                font-size: 0.8rem;
            }

            .user-info {
                padding: 6px 10px;
                font-size: 0.8rem;
            }

            .logout-btn {
                padding: 4px 8px;
                font-size: 0.75rem;
            }

            .sidebar {
                padding: 12px;
            }

            .header {
                padding: 10px;
                margin-bottom: 12px;
            }

            .control-buttons-grid {
                grid-template-columns: 1fr;
            }

            .inspector-management-menu {
                padding: 12px;
                width: 98%;
            }

            .balloon-content {
                max-width: 220px;
                padding: 6px;
            }

            .object-card {
                max-height: calc(100vh - 100px);
                padding-bottom: 16px;
            }
        }

        .object-details {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1500;
        }

        .object-details--visible {
            display: flex;
        }

        .object-details.hidden {
            display: none;
        }

        .object-details__backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
        }

        .object-details__card {
            position: relative;
            background: #ffffff;
            border-radius: 22px;
            width: min(560px, 96vw);
            max-height: 90vh;
            overflow: hidden;
            padding: 30px 32px 34px;
            box-shadow: 0 28px 60px rgba(0, 0, 0, 0.25);
            z-index: 1;
            animation: objectDetailsIn 0.25s ease;
        }

        .object-details__content {
            max-height: calc(90vh - 90px);
            overflow-y: auto;
            margin-top: 12px;
            padding-right: 24px;
            scrollbar-gutter: stable;
            position: relative;
        }

        .object-details__content {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .object-details__content::-webkit-scrollbar {
            width: 0;
            height: 0;
        }

        .object-details__close {
            position: absolute;
            top: 18px;
            right: 18px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: #f2f4f8;
            color: #2c3e50;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease, transform 0.2s ease;
        }

        .object-details__close:hover {
            background: #e3e6ed;
            transform: scale(1.05);
        }

        body.object-details-open {
            overflow: hidden;
        }

        @keyframes objectDetailsIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .object-card {
            display: flex;
            flex-direction: column;
            gap: 18px;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 12px;
        }

        .object-card {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .object-card::-webkit-scrollbar {
            width: 0;
            height: 0;
        }

        .object-card__header {
            display: flex;
            justify-content: flex-start;
            align-items: flex-start;
            gap: 18px;
            position: relative;
            padding-right: 80px;
        }

        .object-card__title {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .object-card__emoji {
            font-size: 30px;
        }

        .object-card__name {
            font-size: 1.25rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 2px;
        }

        .object-card__meta {
            font-size: 0.85rem;
            color: #7f8c8d;
        }

        .object-card__badge {
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            position: absolute;
            top: -2px;
            right: 70px;
            margin: 0;
            pointer-events: none;
        }

        .object-card__badge--new {
            background: #fdecea;
            color: #c0392b;
        }

        .object-card__badge--active {
            background: #e8f4fd;
            color: #1f6fb2;
        }

        .object-card__badge--completed {
            background: #e7f9ef;
            color: #1e8449;
        }

        .object-card__info {
            display: grid;
            gap: 12px;
            background: #f7f9fb;
            padding: 16px 18px;
            border-radius: 16px;
        }

        .object-card__row {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .object-card__label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #95a5a6;
            letter-spacing: 0.05em;
        }

        .object-card__value {
            font-size: 0.95rem;
            color: #2c3e50;
            font-weight: 600;
            line-height: 1.4;
        }

        .object-card__actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        /* üî• –°–í–ê–ô–ü-–•–õ–Ø–°–¢–ò–ö –î–õ–Ø –ë–ê–õ–£–ù–ê */
        .balloon-handle {
            flex: 0 0 auto;
            /* –ù–µ —Å–∂–∏–º–∞—Ç—å—Å—è */
            width: 100%;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            padding-bottom: 5px;
            touch-action: none;
            /* –í–∞–∂–Ω–æ –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ —Å–≤–∞–π–ø–∞ */
            opacity: 0.8;
            background: #fff;
            z-index: 10;
            border-top: 1px solid #f0f0f0;
            /* Slight separator */
        }

        .balloon-handle span {
            width: 50px;
            height: 5px;
            background-color: #bdc3c7;
            border-radius: 10px;
            display: block;
        }

        .balloon-handle:active span {
            background-color: #95a5a6;
        }

        .object-card__actions--primary .object-card__button {
            flex: 1 1 100%;
        }

        /* üî• –ú–û–î–ê–õ –°–û–ì–õ–ê–°–û–í–ê–ù–ò–Ø –†–ê–ë–û–ß–ï–ì–û –î–ù–Ø (–û–ë–ù–û–í–õ–ï–ù–ù–´–ô) */
        .workday-modal {
            position: fixed;
            inset: 0;
            display: none;
            z-index: 10001;
        }

        .workday-modal:not(.hidden) {
            display: block;
        }

        .workday-modal__backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 0;
        }

        .workday-modal__card {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 520px;
            max-width: 95%;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.25);
            padding: 16px;
            z-index: 1;
        }

        .workday-modal__close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
        }

        .workday-modal__content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .workday-actions {
            display: flex;
            gap: 10px;
        }

        .workday-actions .btn {
            flex: 1;
            padding: 10px 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: #fff;
        }

        .btn-secondary {
            background: #f0f3f6;
            color: #2c3e50;
        }

        /* üî• –ù–û–í–´–ô –î–ò–ó–ê–ô–ù –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–Ø –†–ê–ë–û–ß–ï–ì–û –î–ù–Ø (BUBBLE SWITCH) */
        .workday-control-wrapper {
            position: relative;
            display: flex;
            width: 100%;
            height: 44px;
            background: linear-gradient(180deg, #3a8fe8 0%, #2d6fc2 100%);
            border-radius: 22px;
            /* –ó–∞–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ –∫—Ä–∞—è pill-shape */
            padding: 2px;
            box-sizing: border-box;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 10px;
        }

        .workday-bg-bubble {
            position: absolute;
            top: 2px;
            left: 2px;
            width: calc(50% - 2px);
            height: calc(100% - 4px);
            background: #ecf0f1;
            /* –°–µ—Ä—ã–π (–∏–ª–∏ –±–µ–ª—ã–π off-white) –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è */
            border-radius: 20px;
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            /* –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä—É–∂–∏–Ω—ã */
            z-index: 1;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .workday-btn {
            flex: 1;
            position: relative;
            z-index: 2;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            color: transparent;
            /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–Ω–∞ —Å–∏–Ω–µ–º —Ñ–æ–Ω–µ) */
            transition: color 0.2s ease, opacity 0.2s ease;
            outline: none;
            user-select: none;
            /* –ß—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –Ω–µ –≤—ã–¥–µ–ª—è–ª—Å—è –ø—Ä–∏ —Å–≤–∞–π–ø–µ */
            -webkit-user-select: none;
            pointer-events: none;
            /* –ß—Ç–æ–±—ã –∫–ª–∏–∫–∏ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ —Å–∫–≤–æ–∑—å —Ç–µ–∫—Å—Ç –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä/—Å–≤–∞–π–ø (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ –ª—É—á—à–µ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–ª–∏–∫) */
            /* –í–µ—Ä–Ω–µ–º pointer-events: auto –¥–ª—è –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏, –µ—Å–ª–∏ —Å–≤–∞–π–ø –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç */
            pointer-events: auto;
        }

        /* –ö–æ–≥–¥–∞ –∫–Ω–æ–ø–∫–∞ –Ω–∞–¥ –ø—É–∑—ã—Ä–µ–º (–∞–∫—Ç–∏–≤–Ω–∞—è) - —Ç–µ–∫—Å—Ç —Ç–µ–º–Ω—ã–π –∏ –í–ò–î–ò–ú–´–ô */
        .workday-btn.active-text {
            color: #2c3e50;
            opacity: 1;
        }

        /* –ö–æ–≥–¥–∞ –∫–Ω–æ–ø–∫–∞ –Ω–∞ —Å–∏–Ω–µ–º —Ñ–æ–Ω–µ - —Ç–µ–∫—Å—Ç –ü–û–õ–ù–û–°–¢–¨–Æ –ü–†–û–ó–†–ê–ß–ù–´–ô (–∫–∞–∫ –ø—Ä–æ—Å–∏–ª —é–∑–µ—Ä) */
        .workday-btn.inactive-text {
            color: transparent;
            opacity: 0;
        }

        .workday-btn:disabled {
            cursor: default;
        }

        .work-day-indicator {
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            width: 100%;
            display: block;
            margin-top: 10px;
            font-weight: 600;
            box-sizing: border-box;
        }

        /* üî• –°–¢–ò–õ–ò–ó–û–í–ê–ù–ù–´–ô –ò–ù–î–ò–ö–ê–¢–û–† –†–ê–ë–û–ß–ï–ì–û –î–ù–Ø */
        .work-day-indicator {
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            width: 100%;
            display: block;
            margin-top: 10px;
            font-weight: 600;
            box-sizing: border-box;
        }

        .object-card__button {
            flex: 1 1 calc(50% - 10px);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 14px;
            border-radius: 12px;
            border: none;
            background: #f0f3f6;
            color: #2c3e50;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
            text-decoration: none;
        }

        .object-card__button:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(44, 62, 80, 0.15);
        }

        .object-card__button--primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: #ffffff;
        }

        .object-card__button--primary:hover {
            background: linear-gradient(135deg, #2f86c9, #2474a7);
        }

        .object-card__button--accent {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: #ffffff;
        }

        .object-card__button--accent:hover {
            background: linear-gradient(135deg, #e38c0a, #d66d19);
        }

        .object-card__button--warning {
            background: #ffe08a;
            color: #8a6d1f;
        }

        .object-card__button--warning:hover {
            background: #ffd24d;
        }

        .object-card__button--danger {
            background: #fde1e1;
            color: #c0392b;
        }

        .object-card__button--danger:hover {
            background: #f8c9c9;
        }

        .object-card__button--plain {
            background: #ffffff;
            color: #2c3e50;
            border: 1px solid #dfe6e9;
        }

        .object-card__notice {
            padding: 12px 15px;
            border-radius: 14px;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .object-card__notice--warning {
            background: #fff4e5;
            color: #c27c0e;
        }

        .object-card__notice--info {
            background: #e9f2ff;
            color: #2465c5;
        }

        .object-card__notice--muted {
            background: #f4f6f7;
            color: #7f8c8d;
            text-align: center;
        }

        .object-card__link {
            margin-top: 6px;
            background: none;
            border: none;
            color: #1f6fb2;
            font-size: 0.85rem;
            cursor: pointer;
            text-decoration: underline;
        }

        .object-card__section--reassign {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .object-card__select {
            width: 100%;
            border-radius: 12px;
            border: 1px solid #dfe6e9;
            padding: 12px;
            font-size: 0.9rem;
            background: #ffffff;
            color: #2c3e50;
        }

        .object-card__select--primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: #ffffff;
            border: none;
        }

        .object-card__select--primary option {
            color: #2c3e50;
            background: #ffffff;
        }

        .object-card__spacer {
            height: 56px;
            flex: 0 0 auto;
        }

        @media (max-width: 768px) {
            .object-details {
                align-items: center;
                justify-content: center;
            }

            .object-details__card {
                width: 95vw;
                height: 80vh;
                border-radius: 18px;
                padding: 18px 18px 24px;
            }

            .object-card__actions .object-card__button {
                flex: 1 1 100%;
            }

            .object-card__header {
                flex-direction: column;
                align-items: stretch;
                gap: 6px;
                padding-right: 0;
            }

            .object-card__title {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .object-card__title>div {
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                gap: 2px;
                width: auto;
            }

            .object-card__name {
                display: block;
            }

            .object-card__meta {
                display: block;
                margin-left: 0;
            }

            .object-card__badge {
                position: static;
                align-self: flex-end;
                white-space: nowrap;
            }
        }

        @media (max-width: 480px) {
            .object-details__card {
                padding: 24px 18px 28px;
            }

            .object-details__close {
                top: 14px;
                right: 14px;
            }

            .object-card__spacer {
                height: 96px;
            }
        }

        /* üî• MOBILE SWIPE HANDLE & SIDEBAR LOGIC */
        .mobile-toggle-btn {
            display: none !important;
        }

        .sidebar-handle {
            position: fixed;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            width: 8px;
            /* –¢–æ–Ω–∫–∞—è –ø–æ–ª–æ—Å–∫–∞ –∫–∞–∫ –Ω–∞ iPhone */
            height: 80px;
            background-color: rgba(44, 62, 80, 0.4);
            border-radius: 0 6px 6px 0;
            z-index: 9999;
            cursor: pointer;
            backdrop-filter: blur(2px);
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, background-color 0.3s ease, opacity 0.3s ease;
            touch-action: none;
            /* –í–∞–∂–Ω–æ –¥–ª—è —Å–≤–∞–π–ø–æ–≤ */
        }

        /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–æ–Ω—É –∫–ª–∏–∫–∞/—Ç–∞—á–∞ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º –ø—Å–µ–≤–¥–æ—ç–ª–µ–º–µ–Ω—Ç–æ–º */
        .sidebar-handle::after {
            content: '';
            position: absolute;
            top: -20px;
            bottom: -20px;
            left: 0;
            right: -20px;
        }

        .sidebar-handle:hover,
        .sidebar-handle:active {
            background-color: rgba(52, 152, 219, 0.8);
            width: 10px;
        }

        .sidebar-handle.hidden {
            transform: translateY(-50%) translateX(-20px);
            opacity: 0;
            pointer-events: none;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è —Å–∞–π–¥–±–∞—Ä–∞ */
        .sidebar {
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            will-change: transform;
            z-index: 10001;
            /* –ü–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
        }

        @media (max-width: 768px) {

            /* –°–∫—Ä—ã–≤–∞–µ–º —Å–∞–π–¥–±–∞—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100%;
                width: 100%;
                /* üî• –ü–û–õ–ù–ê–Ø –®–ò–†–ò–ù–ê –ù–ê –ú–û–ë–ò–õ–¨–ù–´–• */
                transform: translateX(-110%);
                /* –ü–æ–ª–Ω–æ–µ —Å–∫—Ä—ã—Ç–∏–µ */
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }
        }

        @media (min-width: 769px) {
            .sidebar-handle {
                display: none;
            }
        }

        /* üî• –°–¢–ò–õ–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ò–ù–°–ü–ï–ö–¢–û–†–ê–ú–ò */
        .inspector-management-menu {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0 !important;
            height: 100% !important;
            min-height: 100vh;
            /* Fallback */
            width: 400px;
            background: white;
            padding: 20px;
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1);
            z-index: 20002;
            display: flex;
            flex-direction: column;
            gap: 15px;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        @media (max-width: 768px) {
            .inspector-management-menu {
                width: 100vw;
                max-width: none;
                padding: 15px;
                height: 100dvh !important;
                /* Modern mobile height */
            }
        }

        /* Ensure it covers sidebar if sidebar is 400px */
        @media (min-width: 769px) {
            .inspector-management-menu {
                width: 400px;
            }
        }

        .inspector-management-menu.active {
            transform: translateX(0);
        }

        .inspector-management-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .close-management-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #2c3e50;
            cursor: pointer;
            padding: 0 5px;
            line-height: 1;
        }

        .close-management-btn:hover {
            color: #e74c3c;
        }

        #inspectorManagementContent {
            flex: 1;
            overflow-y: auto;
            scrollbar-width: none;
            padding-right: 5px;
        }

        #inspectorManagementContent::-webkit-scrollbar {
            width: 6px;
        }

        #inspectorManagementContent::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        .management-group {
            margin-bottom: 20px;
            border: 1px solid #f0f2f5;
            border-radius: 12px;
            padding: 10px;
        }

        .management-group-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: #95a5a6;
            margin-bottom: 10px;
            font-weight: bold;
            letter-spacing: 0.05em;
            padding-left: 5px;
        }

        .accordion {
            background: white;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #f0f2f5;
            overflow: hidden;
            transition: box-shadow 0.2s ease, transform 0.2s ease;
        }

        .accordion:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .accordion-header {
            background: white;
            padding: 14px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 0.9rem;
            color: #2c3e50;
        }

        .accordion-header:hover {
            background: #f8f9fa;
        }

        .accordion-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .accordion-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #bdc3c7;
            font-size: 0.8rem;
        }

        .status-icon-header {
            font-size: 1rem;
        }

        .accordion-content {
            padding: 16px;
            border-top: 1px solid #f0f2f5;
            display: none;
            background: #fafbfc;
        }

        .accordion-content.active {
            display: block;
        }

        .search-management {
            width: 100%;
            padding: 10px;
            margin-bottom: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        /************************************************/
        /* CUSTOM SELECT & COLOR PALETTE & BUTTONS      */
        /************************************************/

        .custom-select-container {
            position: relative;
            width: 100%;
        }

        .select-selected {
            background-color: #ffffff;
            border: 1px solid #dfe6e9;
            border-radius: 12px;
            padding: 12px 16px;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            font-weight: 500;
            color: #2c3e50;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }

        .select-selected:hover {
            border-color: #bdc3c7;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .select-selected.select-arrow-active {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .select-items {
            position: relative;
            background-color: #ffffff;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid #f0f2f5;
            overflow-y: auto;
            max-height: 300px;
            display: none;
            margin-top: 8px;
        }

        .select-items.select-show {
            display: block;
        }

        .select-items div {
            padding: 12px 16px;
            cursor: pointer;
            user-select: none;
            font-size: 0.9rem;
            color: #2c3e50;
            border-bottom: 1px solid #f9f9f9;
        }

        .select-items div:hover {
            background-color: #f8f9fa;
            color: #3498db;
        }

        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: all 0.2s;
        }

        .color-option:hover {
            transform: scale(1.1);
            border-color: #333;
        }

        .color-option.selected {
            border-color: #333;
            transform: scale(1.2);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .management-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
        }

        .management-tabs .tab-btn {
            flex: 1;
            background: linear-gradient(180deg, #3a8fe8 0%, #2d6fc2 100%);
            color: #fff;
            border: none;
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .management-tabs .tab-btn:hover {
            background: #2f86c9;
        }

        .apply-changes-btn {
            background: linear-gradient(135deg, #27ae60, #219a52);
            color: white;
            border: none;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
            width: 100%;
            margin-top: 15px;
        }

        .apply-changes-btn:hover {
            background: linear-gradient(135deg, #219a52, #1e8449);
            transform: translateY(-2px);
        }

        @media (max-width: 480px) {
            .inspector-management-menu {
                width: 100%;
                padding: 15px;
            }
        }

        /* üî• SIDE DRAWER (ADD OBJECT) - STYLES FROM PROJECT 1 (Fixed Z-Index) */
        .side-drawer {
            position: fixed;
            top: 0;
            left: -400px;
            width: 400px;
            height: 100%;
            background: #fff;
            z-index: 99999 !important;
            /* üî• FORCE TOP LAYER */
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .side-drawer.active {
            left: 0;
        }

        .side-drawer-header {
            padding: 20px;
            background: #fff;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .side-drawer-title {
            font-weight: 700;
            font-size: 18px;
            color: #1a1a1a;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .side-drawer-title::before {
            content: 'üìã';
            font-size: 20px;
        }

        .side-drawer-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s;
        }

        .side-drawer-close:hover {
            color: #333;
        }

        .side-drawer-search {
            padding: 15px 20px;
            background: #fff;
            border-bottom: 1px solid #f0f0f0;
        }

        .side-drawer-search input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background: #f9f9f9;
            transition: all 0.2s;
            outline: none;
        }

        .side-drawer-search input:focus {
            background: #fff;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .side-drawer-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            background: #f9f9f9;
        }

        .add-object-item {
            padding: 15px 20px;
            background: #fff;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-object-item:hover {
            background: #f0f9ff;
            padding-left: 25px;
        }

        .add-object-title {
            font-weight: 700;
            font-size: 15px;
            color: #1f2937;
            margin-bottom: 6px;
        }

        .add-object-badge {
            display: inline-block;
            background: #e0f2fe;
            color: #0369a1;
            font-size: 11px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            margin-bottom: 8px;
        }

        .add-object-address {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.4;
        }

        .add-object-btn {
            margin-top: 10px;
            padding: 10px 12px;
            background: linear-gradient(180deg, #3a8fe8 0%, #2d6fc2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            width: 100%;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(58, 143, 232, 0.2);
        }

        .add-object-btn:hover {
            background: linear-gradient(180deg, #3f96ef 0%, #2a63af 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(58, 143, 232, 0.3);
        }

        @media (max-width: 768px) {
            .side-drawer {
                width: 100%;
                left: -100%;
            }

            .side-drawer.active {
                left: 0;
            }
        }

        /* üî• Custom Work Day Slider Styles */
        .workday-iphone-slider {
            position: relative;
            width: 100%;
            height: 50px;
            background-color: #95a5a6 !important;
            /* Gray (Closed) by default */
            border-radius: 25px;
            display: flex;
            cursor: pointer;
            transition: background-color 0.3s ease;
            overflow: hidden;
            margin-bottom: 15px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            /* üî• UX FIXES */
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
            touch-action: pan-y;
        }

        .workday-iphone-slider.open {
            background-color: #27ae60 !important;
            /* Green (Open) */
        }

        .workday-bg-bubble {
            position: absolute;
            top: 4px;
            left: 4px;
            width: calc(50% - 8px);
            height: calc(100% - 8px);
            background-color: white;
            border-radius: 21px;
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            pointer-events: none;
        }

        .workday-iphone-slider.open .workday-bg-bubble {
            transform: translateX(calc(100% + 8px));
            /* Slide to right */
        }

        .workday-btn {
            flex: 1;
            z-index: 2;
            opacity: 0;
            /* Invisible buttons */
            cursor: pointer;
            background: transparent;
            border: none;
        }
    </style>
</head>

<body>
    <!-- üî• –°–í–ê–ô–ü-–•–õ–Ø–°–¢–ò–ö –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–´–• -->
    <div id="mobileSidebarHandle" class="sidebar-handle" onclick="toggleMobileSidebar()"></div>

    <!-- üî• –ú–ï–ù–Æ –õ–û–ì–ò–ù–ê -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-container">
            <div class="login-header">
                <h1
                    style="font-family: 'Inter', sans-serif; font-size: 3rem; font-weight: 800; color: #1f6fb2; letter-spacing: -2px; margin: 0; text-transform: lowercase;">
                    m-pro</h1>
            </div>
            <div class="login-form">
                <div class="form-group">
                    <label for="userSelect">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                    <select id="userSelect">
                        <option value="">-- –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–æ–≤... --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="passwordInput">–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="passwordInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <!-- üî• –ß–ï–ö–ë–û–ö–° –ó–ê–ü–û–ú–ù–ò–¢–¨ –ü–ê–†–û–õ–¨ -->
                <div class="remember-password">
                    <input type="checkbox" id="rememberPassword">
                    <label for="rememberPassword">üíæ –ó–∞–ø–æ–º–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</label>
                </div>
                <button class="login-button" onclick="login()">–í–æ–π—Ç–∏</button>
                <!-- üî• –ö–ù–û–ü–ö–ê –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ò–ù–°–ü–ï–ö–¢–û–†–û–í -->
                <button class="refresh-btn" onclick="refreshInspectorsList()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                    —Å–ø–∏—Å–æ–∫ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–æ–≤</button>
            </div>
        </div>
    </div>

    <!-- üî• –ö–ù–û–ü–ö–ê –ú–û–ë–ò–õ–¨–ù–û–ô –ü–ê–ù–ï–õ–ò -->
    <button class="mobile-toggle-btn" id="mobileToggleBtn" onclick="toggleMobileSidebar()">üì± –ü–∞–Ω–µ–ª—å</button>

    <!-- üî• –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° -->






    <!-- üî• –ú–ï–ù–Æ –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ò–ù–°–ü–ï–ö–¢–û–†–ê–ú–ò -->
    <div class="inspector-management-menu" id="inspectorManagementMenu">
        <div class="inspector-management-header">
            <div class="filter-access-title" style="margin:0;">üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–∞–º–∏</div>
            <button class="close-management-btn" onclick="toggleInspectorsManagement()">√ó</button>
        </div>

        <input type="text" class="search-management" id="searchManagement" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–∞–º..."
            onkeyup="filterManagementInspectors()">

        <div id="inspectorManagementContent"></div>
    </div>

    <!-- üî• –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ô–ù–ï–† -->
    <div class="container" id="mainContainer" style="display: none;">
        <!-- üî• –°–ê–ô–î–ë–ê–† –° –í–°–ï–ú–ò –≠–õ–ï–ú–ï–ù–¢–ê–ú–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø -->
        <div class="sidebar" id="sidebar" style="display: flex; flex-direction: column;">
            <!-- üî• –ö–ù–û–ü–ö–ê –°–ö–†–´–¢–ò–Ø –°–ê–ô–î–ë–ê–†–ê -->
            <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">‚óÄ</button>

            <!-- üî• m-pro BRANDING -->
            <h1
                style="font-family: 'Inter', sans-serif; font-size: 2.2rem; font-weight: 800; background: linear-gradient(135deg, #1f6fb2, #3498db); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -1.5px; margin: 0 0 15px 0; text-transform: lowercase; text-align: center;">
                m-pro</h1>
            <div id="sidebarUserInfo"
                style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 12px; padding: 12px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; color: #2c3e50; font-weight: 600; font-size: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            </div>



            <!-- üî• –°–ï–ö–¶–ò–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –†–ê–ë–û–ß–ò–ú –î–ù–ï–ú (–î–õ–Ø –ò–ù–°–ü–ï–ö–¢–û–†–û–í) -->
            <div class="control-section" id="workDaySection" style="display: none;">
                <div class="control-section-title">üìÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—á–∏–º –¥–Ω–µ–º</div>
                <div class="workday-iphone-slider" id="workDayControlWrapper">
                    <div class="workday-bg-bubble" id="workDayBubble"></div>
                </div>
                <div class="work-day-indicator closed" id="workDayIndicator">–°—Ç–∞—Ç—É—Å: –î–µ–Ω—å –∑–∞–∫—Ä—ã—Ç</div>
            </div>

            <!-- üî• –°–ï–ö–¶–ò–Ø –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê -->
            <div class="control-section" id="adminSection" style="display: none;">
                <div class="control-section-title">‚öôÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏</div>
                <div class="control-buttons-grid">
                    <button class="admin-btn" onclick="toggleInspectorsHomes()">–ò–Ω—Å–ø–µ–∫—Ç–æ—Ä—ã</button>
                    <button class="admin-btn" id="managementBtn"
                        onclick="toggleInspectorsManagement()">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
                    <button class="admin-btn" onclick="openAddObjectList()">–°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤</button>

                </div>
            </div>

            <!-- üî• –¢–ê–ë–´ -->
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('filters')">–§–∏–ª—å—Ç—Ä—ã</button>
                <button class="tab-button" id="objectsTabBtn" onclick="switchTab('objects')"
                    style="display: none;">–°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤</button>
            </div>

            <div class="tab-content">
                <!-- üî• –í–ö–õ–ê–î–ö–ê –§–ò–õ–¨–¢–†–û–í -->
                <div class="tab-pane active" id="filters-tab">
                    <div class="filter-section">
                        <div class="filter-title">üîç –ü–æ–∏—Å–∫ –æ–±—ä–µ–∫—Ç–∞</div>
                        <input type="text" id="searchInput" class="search-box"
                            placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–æ—á–∫–∏ –∏–ª–∏ –∞–¥—Ä–µ—Å..." onkeyup="updateFilters()">
                    </div>

                    <div class="filter-section" id="inspectorsFilterSection" style="display: none;">
                        <div class="filter-title">üë§ –§–∏–ª—å—Ç—Ä –ø–æ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–∞–º</div>
                        <input type="text" id="searchInspectors" class="search-box"
                            placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–∞–º..." onkeyup="filterInspectorsList()">
                        <div class="control-buttons">
                            <!-- üî• –ó–ê–ú–ï–ù–ê –ö–ù–û–ü–û–ö –ù–ê –ß–ï–ö–ë–û–ö–° "–í–°–ï –ò–ù–°–ü–ï–ö–¢–û–†–´" -->
                            <div class="checkbox-item master-checkbox">
                                <input type="checkbox" id="selectAllInspectors"
                                    onchange="toggleAllInspectors(this.checked)">
                                <label for="selectAllInspectors">–í—Å–µ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä—ã</label>
                            </div>
                        </div>
                        <div class="checkbox-group" id="inspectorsList">
                            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–æ–≤...</div>
                        </div>
                    </div>

                    <div class="filter-section">
                        <div class="filter-title">üìã –§–∏–ª—å—Ç—Ä –ø–æ —Å–ø–∏—Å–∫–∞–º</div>
                        <div class="list-control-buttons">
                            <!-- üî• –ó–ê–ú–ï–ù–ê –ö–ù–û–ü–û–ö –ù–ê –ß–ï–ö–ë–û–ö–° "–í–°–ï –°–ü–ò–°–ö–ò" -->
                            <div class="checkbox-item master-checkbox">
                                <input type="checkbox" id="selectAllLists" onchange="toggleAllLists(this.checked)">
                                <label for="selectAllLists">–í—Å–µ —Å–ø–∏—Å–∫–∏</label>
                            </div>
                        </div>
                        <div class="checkbox-group" id="listsList">
                            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–æ–≤...</div>
                        </div>
                    </div>

                    <div class="filter-section">
                        <div class="filter-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="showHidden" onchange="updateFilters(); saveFilterState();">
                            <label for="showHidden"> –ú–û–ù–ò–¢–û–†–ò–ù–ì –ó–ê–í–ï–†–®–ï–ù ‚úÖ </label>
                        </div>
                    </div>


                </div>



                <!-- üî• –í–´–ï–ó–ñ–ê–Æ–©–ï–ï –ú–ï–ù–Æ –°–ü–ò–°–ö–ê –û–ë–™–ï–ö–¢–û–í (add_object) -->
                <div class="tab-pane" id="objects-tab">
                    <div class="filter-section">
                        <div class="filter-title">üîç –ü–æ–∏—Å–∫ –≤ —Å–ø–∏—Å–∫–µ</div>
                        <input type="text" id="searchListInput" class="search-box"
                            placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–æ—á–∫–∏ –∏–ª–∏ –∞–¥—Ä–µ—Å..." onkeyup="updateObjectsList()">
                    </div>
                    <div class="objects-list">
                        <div class="objects-list-title">üìã –°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤</div>
                        <div id="objectsListContent">
                            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤...</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- üî• –í–´–•–û–î (–ü–ï–†–ï–ù–ï–°–ï–ù –í–ù–ò–ó –ú–ï–ù–Æ) -->
            <div style="margin-top: auto; padding: 10px;">
                <button class="object-card__button object-card__button--danger" onclick="logout()"
                    style="width: 100%; justify-content: center;">üö™ –í—ã–π—Ç–∏</button>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>

            <!-- üî• MAP SEARCH CONTROL -->
            <div id="mapSearchControl" class="map-search-control">
                <button id="mapSearchToggle" class="map-search-btn" onclick="toggleMapSearch()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="11" cy="11" r="7" stroke="black" stroke-width="2" />
                        <line x1="21" y1="21" x2="16.65" y2="16.65" stroke="black" stroke-width="2"
                            stroke-linecap="round" />
                    </svg>
                </button>
                <div id="mapSearchBar" class="map-search-bar hidden">
                    <input type="text" id="mapSearchInput" placeholder="ID (—Ç–æ—á–Ω–æ) –∏–ª–∏ –∞–¥—Ä–µ—Å..."
                        onkeydown="handleMapSearchKey(event)">
                    <button id="mapSearchClear" class="map-search-clear" onclick="clearMapSearch()">‚úï</button>
                </div>
            </div>
        </div>
    </div>

    <div class="object-details hidden" id="objectDetailsOverlay">
        <div class="object-details__backdrop"></div>
        <div class="object-details__card" role="dialog" aria-modal="true">
            <button class="object-details__close" type="button" onclick="closeObjectDetails()">‚úï</button>
            <div class="object-details__content" id="objectDetailsContent"></div>
        </div>
    </div>



    <div class="workday-modal hidden" id="workDayApprovalOverlay">
        <div class="workday-modal__backdrop"></div>
        <div class="workday-modal__card" role="dialog" aria-modal="true">
            <button class="workday-modal__close" type="button" onclick="closeWorkDayApproval()">‚úï</button>
            <div class="workday-modal__content" id="workDayApprovalContent"></div>
        </div>
    </div>

    <style>
        .object-details__card {
            will-change: transform;
            /* üî• Optimize for swipe */
            transition: transform 0.1s;
            /* Base transition */
        }

        /* üî• MAP SEARCH STYLES - LIQUID GLASS & IOS */
        .map-search-control {
            position: absolute;
            bottom: 160px !important;
            /* Back to bottom, lifted up */
            top: auto !important;
            right: 20px;
            z-index: 2000;
            display: flex;
            align-items: center;
            flex-direction: row-reverse;
            gap: 12px;
        }

        .map-search-btn {
            width: 50px;
            height: 50px;
            /* Liquid Glass Logic */
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
            padding: 0;
        }

        .map-search-btn:active {
            transform: scale(0.92);
            background: rgba(255, 255, 255, 0.8);
        }

        .map-search-bar {
            /* Liquid Glass Logic */
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            height: 50px;
            border-radius: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            padding: 0 16px;
            width: 0;
            opacity: 0;
            overflow: hidden;
            transition: width 0.35s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s;
            pointer-events: none;
        }

        .map-search-bar.active {
            width: 280px;
            opacity: 1;
            pointer-events: all;
        }

        #mapSearchInput {
            border: none;
            background: transparent;
            outline: none;
            flex: 1;
            font-size: 16px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            font-weight: 500;
            min-width: 0;
            color: #000;
            padding-right: 8px;
        }

        #mapSearchInput::placeholder {
            color: rgba(0, 0, 0, 0.5);
        }

        .map-search-clear {
            background: rgba(0, 0, 0, 0.1);
            border: none;
            color: rgba(0, 0, 0, 0.6);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .map-search-clear:hover {
            background: rgba(0, 0, 0, 0.2);
            color: #000;
        }

        .map-search-bar.active {
            width: 280px;
            opacity: 1;
            pointer-events: all;
        }

        #mapSearchInput {
            border: none;
            outline: none;
            flex: 1;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            min-width: 0;
            /* Flex fix */
            color: #2c3e50;
        }

        .map-search-clear {
            background: none;
            border: none;
            color: #95a5a6;
            cursor: pointer;
            font-size: 1.1rem;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        }

        /* üî• NOTIFICATIONS STYLES */
        .notification-container {
            position: fixed;
            z-index: 100000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        /* üîÑ YANDEX SPINNER */
        .yandex-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: currentColor;
            border-radius: 50%;
            animation: yandex-spin 0.8s linear infinite;
            vertical-align: middle;
            margin-right: 6px;
        }

        @keyframes yandex-spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* üìä YANDEX PROGRESS BAR */
        .yandex-progress-container {
            margin-top: 8px;
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 2px;
            overflow: hidden;
        }

        .yandex-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            border-radius: 2px;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }


        .notification {
            background: rgba(255, 255, 255, 0.6);
            /* High transparency for Glass Effect */
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            border-radius: 18px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.95rem;
            color: #1d1d1f;
            font-weight: 500;
            pointer-events: auto;
            transform-origin: center top;
            animation: notif-slide-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: fit-content;
            max-width: 90vw;
        }

        .notification-icon {
            font-size: 1.4rem;
        }

        @keyframes notif-slide-in {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .notification.swipe-out {
            transition: transform 0.3s ease, opacity 0.3s ease;
            transform: translateY(-50px) scale(0.9);
            opacity: 0;
        }

        /* üì± MOBILE: Top Center */
        @media (max-width: 768px) {
            .notification-container {
                top: 15px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                align-items: center;
            }

            .notification {
                width: 100%;
                justify-content: center;
            }

            .map-search-control {
                bottom: 85px !important;
                /* Lowered by ~2cm for Mobile */
            }
        }

        /* üíª DESKTOP: TOP CENTER (Gap Center - 65%) */
        @media (min-width: 769px) {
            .notification-container {
                top: 20px;
                /* Final Nudge Right (+2% -> 65%) */
                left: 65%;
                transform: translateX(-50%);
                right: auto;
                align-items: center;
            }

            .notification {
                width: 400px;
                /* Fixed width */
                padding: 18px 24px;
                font-size: 1rem;
                justify-content: center;
            }
        }
        }
    </style>
    <script type="text/javascript">
        // üî• –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyU797HPV7MCvo03P5JvTQg0fUJncKlOx8Hdl-yqxHfEY7NpDBLGhTRoitSSTA9pGzE/exec';

        // üî• YANDEX DISK CONFIGURATION (–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π)
        const YANDEX_OAUTH_TOKEN = 'y0__xCtoIulqveAAhjinD0gyIzumRaVmdCKk27u3ItXUoc6rNG4XSwS7w';
        const YANDEX_ROOT_PATH = '–û—Å–º–æ—Ç—Ä—ã –æ–±—ä–µ–∫—Ç–æ–≤ –ê–ù–û –°–ú–ì';

        // üî• –ö–õ–Æ–ß–ò –î–õ–Ø LOCALSTORAGE
        const SESSION_KEY = 'map_session';
        const REMEMBER_ME_KEY = 'remember_password';
        const SAVED_PASSWORDS_KEY = 'saved_passwords';
        const WORK_DAY_STATUS_KEY = 'work_day_status';
        const WORK_DAY_START_TIME_KEY = 'work_day_start_time';
        const INSPECTORS_CACHE_KEY = 'inspectors_cache';
        const INSPECTORS_CACHE_TIMESTAMP = 'inspectors_cache_timestamp';

        // üî• –õ–û–ö–ê–õ–¨–ù–´–ô –ö–≠–® –ù–ê–°–¢–†–û–ï–ö –ò–ù–°–ü–ï–ö–¢–û–†–û–í
        function loadInspectorsCache() {
            try {
                const raw = localStorage.getItem(INSPECTORS_CACHE_KEY);
                return raw ? JSON.parse(raw) : {};
            } catch (_) { return {}; }
        }

        function saveInspectorsCache(cache) {
            try {
                localStorage.setItem(INSPECTORS_CACHE_KEY, JSON.stringify(cache));
                localStorage.setItem(INSPECTORS_CACHE_TIMESTAMP, String(Date.now()));
            } catch (_) { }
        }

        function upsertInspectorCache(inspector, config) {
            const cache = loadInspectorsCache();
            cache[inspector] = { color: config.color, icon: config.icon, status: config.status };
            saveInspectorsCache(cache);
        }

        function mergeLocalInspectorConfig() {
            const cache = loadInspectorsCache();
            const normalize = (s) => (s || '').toLowerCase().trim();
            const serverKeysByNorm = {};
            Object.keys(window.INSPECTORS_CONFIG || {}).forEach(k => { serverKeysByNorm[normalize(k)] = k; });
            Object.keys(cache).forEach(name => {
                const serverKey = serverKeysByNorm[normalize(name)] || name;
                if (!window.INSPECTORS_CONFIG[serverKey]) window.INSPECTORS_CONFIG[serverKey] = {};
                const localCfg = cache[name] || {};
                window.INSPECTORS_CONFIG[serverKey].color = window.INSPECTORS_CONFIG[serverKey].color || localCfg.color;
                window.INSPECTORS_CONFIG[serverKey].icon = window.INSPECTORS_CONFIG[serverKey].icon || localCfg.icon;
                window.INSPECTORS_CONFIG[serverKey].status = window.INSPECTORS_CONFIG[serverKey].status || localCfg.status;
            });
        }
        const FILTERS_STATE_KEY = 'filters_state'; // <-- –≠–¢–û –ù–û–í–´–ô –ö–õ–Æ–ß

        // üî• –ù–ê–°–¢–†–û–ô–ö–ò –°–ï–°–°–ò–ò
        const SESSION_TIMEOUT = 24 * 60 * 60 * 1000; // 24 —á–∞—Å–∞

        // üî• –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
        let currentUser = null;
        let userAccessRights = '–ò–Ω—Å–ø–µ–∫—Ç–æ—Ä';
        let objectsData = [];
        let map, objectManager, activeObjectsLayer, inspectorsHomesLayer;
        let showInspectorsHomes = false;
        let isWorkDayOpen = false;
        let workDayStartTimeServer = null;
        let availableIcons = {};
        let availableColors = [];

        let activeMenu = null;
        let isSidebarCollapsed = false;
        let autoRefreshTimer = null;

        // üî• –°–û–•–†–ê–ù–ï–ù–ò–ï –°–û–°–¢–û–Ø–ù–ò–Ø –§–ò–õ–¨–¢–†–û–í
        function saveFilterState() {
            try {
                const filterState = {
                    inspectors: getSelectedInspectors(),
                    lists: getSelectedLists(),
                    showHidden: document.getElementById('showHidden').checked,
                    timestamp: Date.now()
                };
                localStorage.setItem(FILTERS_STATE_KEY, JSON.stringify(filterState));
                console.log('‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
                try { saveGlobalFilters(filterState); } catch (_) { }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤:', error);
            }
        }

        // üî• –ó–ê–ì–†–£–ó–ö–ê –°–û–°–¢–û–Ø–ù–ò–Ø –§–ò–õ–¨–¢–†–û–í
        function loadFilterState() {
            try {
                const saved = localStorage.getItem(FILTERS_STATE_KEY);
                if (saved) {
                    const filterState = JSON.parse(saved);
                    applyFilterState(filterState);
                    console.log('‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ (–ª–æ–∫–∞–ª—å–Ω–æ)');
                    return true;
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤:', error);
            }
            return false;
        }

        function applyFilterState(filterState) {
            const inspectorCheckboxes = document.querySelectorAll('#inspectorsList input[type="checkbox"]');
            inspectorCheckboxes.forEach(checkbox => {
                const inspector = checkbox.id.replace('insp_', '');
                checkbox.checked = filterState.inspectors.includes(inspector);
            });
            const listCheckboxes = document.querySelectorAll('#listsList input[type="checkbox"]');
            listCheckboxes.forEach(checkbox => {
                const list = checkbox.id.replace('list_', '');
                checkbox.checked = filterState.lists.includes(list);
            });
            document.getElementById('showHidden').checked = !!filterState.showHidden;
        }

        function saveGlobalFilters(state) {
            const callbackName = 'saveGlobalFilters_' + Date.now();
            const url = `${SCRIPT_URL}?action=saveGlobalFilters&state=${encodeURIComponent(JSON.stringify(state))}&callback=${callbackName}`;
            const script = document.createElement('script');
            window[callbackName] = function (result) { try { delete window[callbackName]; } catch (_) { } };
            script.src = url;
            script.onerror = function () { try { delete window[callbackName]; } catch (_) { } };
            document.head.appendChild(script);
        }

        function loadFiltersFromServerAndApply() {
            const callbackName = 'getGlobalFilters_' + Date.now();
            const url = `${SCRIPT_URL}?action=getGlobalFilters&callback=${callbackName}`;
            const script = document.createElement('script');
            window[callbackName] = function (result) {
                try { delete window[callbackName]; } catch (_) { }
                if (result && result.success && result.state) {
                    applyFilterState(result.state);
                    localStorage.setItem(FILTERS_STATE_KEY, JSON.stringify(result.state));
                    updateFilters();
                    console.log('‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ (—Å–µ—Ä–≤–µ—Ä)');
                }
            };
            script.src = url;
            script.onerror = function () { try { delete window[callbackName]; } catch (_) { } };
            document.head.appendChild(script);
        }

        // üî• –°–ë–†–û–° –§–ò–õ–¨–¢–†–û–í –ö –°–û–°–¢–û–Ø–ù–ò–Æ "–ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ"
        function resetFiltersToDefault() {
            // üî• –í–´–ë–ò–†–ê–ï–ú –í–°–ï–• –ò–ù–°–ü–ï–ö–¢–û–†–û–í (–∫—Ä–æ–º–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö)
            const inspectorCheckboxes = document.querySelectorAll('#inspectorsList input[type="checkbox"]');
            inspectorCheckboxes.forEach(checkbox => {
                const inspector = checkbox.id.replace('insp_', '');
                const style = getInspectorStyle(inspector);
                checkbox.checked = (style.status === 'active') && (inspector !== 'Admin');
            });

            // üî• –í–´–ë–ò–†–ê–ï–ú –í–°–ï –°–ü–ò–°–ö–ò
            const listCheckboxes = document.querySelectorAll('#listsList input[type="checkbox"]');
            listCheckboxes.forEach(checkbox => {
                checkbox.checked = true;
            });

            // üî• –°–ë–†–ê–°–´–í–ê–ï–ú –ß–ï–ö–ë–û–ö–° "–ú–û–ù–ò–¢–û–†–ò–ù–ì"
            document.getElementById('showHidden').checked = false;

            console.log('‚úÖ –§–∏–ª—å—Ç—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã –∫ —Å–æ—Å—Ç–æ—è–Ω–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
            saveFilterState();
            updateFilters();
        }

        // üî• –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï
        document.addEventListener('DOMContentLoaded', function () {
            console.log('üü° –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Å—Å–∏—é...');

            // –í—Å–µ–≥–¥–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–µ–∂–∏—Ö –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–æ–≤
            loadInspectorsFromServer();

            // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Å—Å–∏—é
            if (restoreSession()) {
                console.log('‚úÖ –°–µ—Å—Å–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
            ymaps.ready(initMap);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —Å–∞–π–¥–±–∞—Ä–∞
            document.getElementById('map').addEventListener('click', function () {
                if (checkMobileDevice() && document.getElementById('sidebar').classList.contains('mobile-open')) {
                    toggleMobileSidebar();
                }
            });
        });

        // üî• –ü–†–û–í–ï–†–ö–ê –ú–û–ë–ò–õ–¨–ù–û–ì–û –£–°–¢–†–û–ô–°–¢–í–ê
        function checkMobileDevice() {
            return window.innerWidth <= 768;
        }

        // üî• –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –°–ê–ô–î–ë–ê–†–ê (–î–ï–°–ö–¢–û–ü)
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('sidebarToggle');

            isSidebarCollapsed = !isSidebarCollapsed;

            if (isSidebarCollapsed) {
                sidebar.classList.add('collapsed');
                toggleBtn.innerHTML = '‚ñ∂';
            } else {
                sidebar.classList.remove('collapsed');
                toggleBtn.innerHTML = '‚óÄ';
            }
        }

        // üî• –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –ú–û–ë–ò–õ–¨–ù–û–ì–û –°–ê–ô–î–ë–ê–†–ê
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('mobileToggleBtn');

            if (sidebar.classList.contains('mobile-open')) {
                sidebar.classList.remove('mobile-open');
                toggleBtn.textContent = 'üì± –ü–∞–Ω–µ–ª—å';
            } else {
                sidebar.classList.add('mobile-open');
                toggleBtn.textContent = '‚úï –ó–∞–∫—Ä—ã—Ç—å';
            }
        }

        // üî• –°–ò–°–¢–ï–ú–ê –°–ï–°–°–ò–ô –ò –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò
        function saveSession() {
            if (currentUser) {
                const sessionData = {
                    user: currentUser,
                    role: userAccessRights,
                    timestamp: Date.now()
                };
                localStorage.setItem(SESSION_KEY, JSON.stringify(sessionData));
                console.log('‚úÖ –°–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
            }
        }

        function restoreSession() {
            try {
                const sessionData = localStorage.getItem(SESSION_KEY);
                if (sessionData) {
                    const session = JSON.parse(sessionData);
                    const sessionAge = Date.now() - session.timestamp;

                    if (sessionAge < SESSION_TIMEOUT) {
                        console.log('üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Å—Å–∏—é –¥–ª—è:', session.user);

                        currentUser = session.user;
                        userAccessRights = session.role;

                        showMainInterface();
                        loadData();
                        return true;
                    } else {
                        console.log('‚ùå –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞');
                        clearSession();
                    }
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏:', error);
                clearSession();
            }
            return false;
        }

        function clearSession() {
            localStorage.removeItem(SESSION_KEY);
            currentUser = null;
            userAccessRights = '–ò–Ω—Å–ø–µ–∫—Ç–æ—Ä';
        }

        // üî• –°–ò–°–¢–ï–ú–ê "–ó–ê–ü–û–ú–ù–ò–¢–¨ –ü–ê–†–û–õ–¨"
        function savePassword(username, password) {
            try {
                const rememberMe = document.getElementById('rememberPassword').checked;

                if (rememberMe && username && password) {
                    localStorage.setItem(REMEMBER_ME_KEY, 'true');

                    const savedPasswords = getSavedPasswords();
                    savedPasswords[username] = password;
                    localStorage.setItem(SAVED_PASSWORDS_KEY, JSON.stringify(savedPasswords));

                    console.log('‚úÖ –ü–∞—Ä–æ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω –¥–ª—è:', username);
                } else {
                    clearSavedPassword(username);
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è:', error);
            }
        }

        function getSavedPasswords() {
            try {
                const saved = localStorage.getItem(SAVED_PASSWORDS_KEY);
                return saved ? JSON.parse(saved) : {};
            } catch (error) {
                return {};
            }
        }

        function getSavedPassword(username) {
            try {
                const savedPasswords = getSavedPasswords();
                return savedPasswords[username] || null;
            } catch (error) {
                return null;
            }
        }

        function clearSavedPassword(username) {
            try {
                const savedPasswords = getSavedPasswords();
                if (savedPasswords[username]) {
                    delete savedPasswords[username];
                    localStorage.setItem(SAVED_PASSWORDS_KEY, JSON.stringify(savedPasswords));
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è:', error);
            }
        }

        function autoFillLoginForm() {
            const userSelect = document.getElementById('userSelect');
            const passwordInput = document.getElementById('passwordInput');
            const rememberCheckbox = document.getElementById('rememberPassword');

            if (userSelect.value) {
                const savedPassword = getSavedPassword(userSelect.value);
                if (savedPassword) {
                    passwordInput.value = savedPassword;
                    rememberCheckbox.checked = true;
                } else {
                    passwordInput.value = '';
                    rememberCheckbox.checked = localStorage.getItem(REMEMBER_ME_KEY) === 'true';
                }
            }
        }

        // üî• –°–ò–°–¢–ï–ú–ê –†–ê–ë–û–ß–ï–ì–û –î–ù–Ø
        function saveWorkDayStatus(isOpen, startTime = null) {
            try {
                localStorage.setItem(WORK_DAY_STATUS_KEY, isOpen ? 'open' : 'closed');
                if (isOpen) {
                    if (startTime) {
                        localStorage.setItem(WORK_DAY_START_TIME_KEY, startTime);
                    }
                } else {
                    localStorage.removeItem(WORK_DAY_START_TIME_KEY);
                }
                console.log('‚úÖ –°—Ç–∞—Ç—É—Å —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω:', isOpen ? '–æ—Ç–∫—Ä—ã—Ç' : '–∑–∞–∫—Ä—ã—Ç');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è:', error);
            }
        }

        function getWorkDayStatus() {
            try {
                const status = localStorage.getItem(WORK_DAY_STATUS_KEY);
                const startTime = localStorage.getItem(WORK_DAY_START_TIME_KEY);

                return {
                    isOpen: status === 'open',
                    startTime: startTime
                };
            } catch (error) {
                return { isOpen: false, startTime: null };
            }
        }

        function clearWorkDayStatus() {
            try {
                localStorage.removeItem(WORK_DAY_STATUS_KEY);
                localStorage.removeItem(WORK_DAY_START_TIME_KEY);
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è:', error);
            }
        }

        // üî• –ó–ê–ì–†–£–ó–ö–ê –ò–ù–°–ü–ï–ö–¢–û–†–û–í - –ë–ï–ó –ö–≠–®–ê
        function loadInspectorsFromServer() {
            const callbackName = 'inspectorsLoginCallback_' + Date.now();
            window[callbackName] = function (data) {
                delete window[callbackName];

                if (data.success && data.inspectorsData) {
                    updateUserSelect(data.inspectorsData);
                    console.log('‚úÖ –ò–Ω—Å–ø–µ–∫—Ç–æ—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –º–≥–Ω–æ–≤–µ–Ω–Ω–æ:', Object.keys(data.inspectorsData).length);
                } else {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–æ–≤');
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–∑–æ–≤—ã—Ö –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                    const userSelect = document.getElementById('userSelect');
                    userSelect.innerHTML = '<option value="">-- –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ --</option>';
                }
            };

            const url = SCRIPT_URL + '?action=getData&callback=' + callbackName;
            const script = document.createElement('script');
            script.src = url;
            script.onerror = function () {
                delete window[callbackName];
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–æ–≤');
                const userSelect = document.getElementById('userSelect');
                userSelect.innerHTML = '<option value="">-- –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ --</option>';
            };
            document.head.appendChild(script);
        }

        function refreshInspectorsList() {
            loadInspectorsFromServer();
            const logoEl = document.getElementById('orgLogo');
            if (logoEl) {
                const DEFAULT_SVG = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyOCIgaGVpZ2h0PSIyOCI+PHJlY3Qgd2lkdGg9IjI4IiBoZWlnaHQ9IjI4IiByeD0iNCIgZmlsbD0iI2IxMDAwMCIvPjwvc3ZnPg==';
                logoEl.src = window.ORG_LOGO_BASE64 || DEFAULT_SVG;
                (function () {
                    const names = [
                        'WhatsApp Image 2025-11-11 at 17.47.04.png',
                        'WhatsApp Image 2025-11-11 at 17.47.04.jpg',
                        'WhatsApp Image 2025-11-11 at 17.47.04.jpeg',
                        'WhatsApp Image 2025-11-11 at 17.47.04.webp'
                    ];
                    const load = function (i) {
                        if (i >= names.length) return;
                        const path = encodeURI(names[i]);
                        const tryImg = () => {
                            const img = new Image();
                            img.onload = function () { logoEl.src = path; };
                            img.onerror = function () { fetchAsBase64(); };
                            img.src = path;
                        };
                        const fetchAsBase64 = () => {
                            fetch(path)
                                .then(r => r.ok ? r.blob() : Promise.reject())
                                .then(blob => {
                                    const reader = new FileReader();
                                    reader.onloadend = function () { window.ORG_LOGO_BASE64 = reader.result; logoEl.src = reader.result; };
                                    reader.readAsDataURL(blob);
                                })
                                .catch(() => load(i + 1));
                        };
                        tryImg();
                    };
                    load(0);
                })();
            }
            showNotification('üîÑ –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–æ–≤...', 'success');
        }

        function updateUserSelect(inspectorsData) {
            const userSelect = document.getElementById('userSelect');
            userSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–∞ --</option>';

            Object.keys(inspectorsData).forEach(inspector => {
                const option = document.createElement('option');
                option.value = inspector;
                option.textContent = inspector;
                userSelect.appendChild(option);
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è
            userSelect.addEventListener('change', autoFillLoginForm);

            console.log('‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', Object.keys(inspectorsData).length);
        }

        // üî• –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê
        function showMainInterface() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'flex';
            document.getElementById('mainContainer').style.display = 'flex';

            const userInfoText = document.getElementById('sidebarUserInfo');
            if (userInfoText) {
                const style = getInspectorStyle(currentUser);
                userInfoText.textContent = `${style.icon} ${userAccessRights}: ${currentUser}`;
            }

            // üî• –ü–û–ö–ê–ó–´–í–ê–ï–ú –°–û–û–¢–í–ï–¢–°–¢–í–£–Æ–©–ò–ï –°–ï–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø
            if (userAccessRights === '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä' || userAccessRights === '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä') {
                document.getElementById('adminSection').style.display = 'block';
                document.getElementById('workDaySection').style.display = 'none'; // üî• –Ø–≤–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º
            } else {
                document.getElementById('adminSection').style.display = 'none'; // üî• –Ø–≤–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º
                document.getElementById('workDaySection').style.display = 'block';
                updateWorkDayButtons();
                checkWorkDayStatus();
            }

            // üî• –°–ö–†–´–í–ê–ï–ú –ö–ù–û–ü–ö–£ –ú–û–ë–ò–õ–¨–ù–û–ô –ü–ê–ù–ï–õ–ò –ù–ê –î–ï–°–ö–¢–û–ü–ï
            if (!checkMobileDevice()) {
                document.getElementById('mobileToggleBtn').style.display = 'none';
            }

        }

        function login() {
            const userSelect = document.getElementById('userSelect');
            const passwordInput = document.getElementById('passwordInput');
            const selectedUser = userSelect.value;
            const enteredPassword = passwordInput.value;

            if (!selectedUser) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return;
            }

            if (!enteredPassword) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
                return;
            }

            console.log('üü° –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è –¥–ª—è:', selectedUser);

            const callbackName = 'verifyPasswordCallback_' + Date.now();
            window[callbackName] = function (result) {
                console.log('üü° –û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);
                delete window[callbackName];

                if (result && result.success) {
                    console.log('‚úÖ –£–°–ü–ï–®–ù–´–ô –õ–û–ì–ò–ù!');
                    currentUser = selectedUser;
                    userAccessRights = result.accessRights || '–ò–Ω—Å–ø–µ–∫—Ç–æ—Ä';

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä–æ–ª—å –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ "–ó–∞–ø–æ–º–Ω–∏—Ç—å"
                    savePassword(selectedUser, enteredPassword);

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é
                    saveSession();

                    showMainInterface();
                    loadData();
                    showNotification(`‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${currentUser} (${userAccessRights})`, 'success');
                } else {
                    console.log('‚ùå –û–®–ò–ë–ö–ê –õ–û–ì–ò–ù–ê');
                    alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å! ' + (result.message || ''));
                    passwordInput.value = '';
                    passwordInput.focus();
                }
            };

            const url = SCRIPT_URL + '?action=verifyPassword&inspector=' + encodeURIComponent(selectedUser) + '&password=' + encodeURIComponent(enteredPassword.trim()) + '&callback=' + callbackName;
            const script = document.createElement('script');
            script.src = url;
            script.onerror = function () {
                delete window[callbackName];
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            };
            document.head.appendChild(script);
        }

        function logout() {
            clearSession();
            stopAutoRefresh();
            document.getElementById('loginOverlay').style.display = 'flex';
            document.getElementById('mainContainer').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('adminSection').style.display = 'none';
            document.getElementById('workDaySection').style.display = 'none';
            document.getElementById('passwordInput').value = '';
            showInspectorsHomes = false;
            if (inspectorsHomesLayer) inspectorsHomesLayer.removeAll();
            closeAllMenus();
        }

        function startAutoRefresh() {
            try { stopAutoRefresh(); } catch (_) { }
            autoRefreshTimer = setInterval(() => {
                if (currentUser) {
                    loadData();
                    try { loadFiltersFromServerAndApply(); } catch (_) { }
                    try { checkWorkDayStatus(); } catch (_) { }
                }
            }, 60000);
        }

        function stopAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
            }
        }

        // üî• –ö–ê–†–¢–ê –ò –î–ê–ù–ù–´–ï
        function initMap() {
            console.log('üü° Yandex Maps ready');
            map = new ymaps.Map("map", {
                center: [55.7558, 37.6173],
                zoom: 10
            });

            objectManager = new ymaps.ObjectManager({
                clusterize: false,
                gridSize: 64
            });

            activeObjectsLayer = new ymaps.ObjectManager({
                clusterize: false,
                gridSize: 64
            });

            // üî• –ò—Å–ø–æ–ª—å–∑—É–µ–º GeoObjectCollection –≤–º–µ—Å—Ç–æ ObjectManager (–±–æ–ª–µ–µ –Ω–∞–¥—ë–∂–Ω–æ –¥–ª—è –Ω–µ–±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ–±—ä–µ–∫—Ç–æ–≤)
            inspectorsHomesLayer = new ymaps.GeoObjectCollection();

            // üî• –£–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –ù–ê–°–¢–†–û–ô–ö–ò –ë–ê–õ–õ–£–ù–û–í
            objectManager.objects.options.set({
                balloonMaxWidth: 1200,
                balloonMinWidth: 600,
                balloonPanelMaxMapArea: 0,
                openBalloonOnClick: false
            });

            activeObjectsLayer.objects.options.set({
                balloonMaxWidth: 1200,
                balloonMinWidth: 600,
                balloonPanelMaxMapArea: 0,
                openBalloonOnClick: false
            });

            objectManager.objects.events.add('click', function (e) {
                const objectId = e.get('objectId');
                showObjectBalloon(objectId);
            });

            activeObjectsLayer.objects.events.add('click', function (e) {
                const objectId = e.get('objectId');
                showObjectBalloon(objectId);
            });

            map.geoObjects.add(objectManager);
            map.geoObjects.add(activeObjectsLayer);
            map.geoObjects.add(inspectorsHomesLayer);

            // üî• –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ò–ó–ú–ï–ù–ï–ù–ò–Ø –ú–ê–°–®–¢–ê–ë–ê –î–õ–Ø –ê–î–ê–ü–¢–ê–¶–ò–ò –ë–ê–õ–õ–£–ù–û–í
            map.events.add('boundschange', function () {
                const zoom = map.getZoom();
                updateBalloonSize(zoom);
            });

            // üî• FORCE INITIAL RENDER
            if (typeof objectsData !== 'undefined' && objectsData.length > 0) {
                updateMap();
            }
        }

        // üî• –§–£–ù–ö–¶–ò–Ø –ê–î–ê–ü–¢–ê–¶–ò–ò –†–ê–ó–ú–ï–†–ê –ë–ê–õ–õ–£–ù–û–í –ü–û–î –ú–ê–°–®–¢–ê–ë
        function updateBalloonSize(zoom) {
            let balloonWidth = 300;
            let balloonMinWidth = 250;

            if (zoom > 15) {
                balloonWidth = 280;
                balloonMinWidth = 230;
            } else if (zoom < 10) {
                balloonWidth = 320;
                balloonMinWidth = 270;
            }

            objectManager.objects.options.set({
                balloonMaxWidth: balloonWidth,
                balloonMinWidth: balloonMinWidth
            });

            activeObjectsLayer.objects.options.set({
                balloonMaxWidth: balloonWidth,
                balloonMinWidth: balloonMinWidth
            });
        }

        function loadData() {
            if (!currentUser) return;

            // üî• CACHE STRATEGY: –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
            const CACHE_KEY = 'MPRO_DATA_CACHE_V2';
            let hasCache = false;
            try {
                const cached = localStorage.getItem(CACHE_KEY);
                if (cached) {
                    const data = JSON.parse(cached);
                    if (data && data.success) {
                        console.log('üü¢ Data loaded from CACHE');
                        processServerData(data); // –†–µ–Ω–¥–µ—Ä–∏–º —Å—Ä–∞–∑—É
                        hasCache = true;
                    }
                }
            } catch (e) { console.error('Cache load error', e); }

            // –ï—Å–ª–∏ –∫—ç—à–∞ –Ω–µ—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            if (!hasCache) {
                console.log('üü° –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞...');
                showLoading('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google –¢–∞–±–ª–∏—Ü—ã...');
            } else {
                console.log('üü° –§–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...');
            }

            const callbackName = 'jsonpCallback_' + Date.now();
            window[callbackName] = function (data) {
                console.log('üü° –ü–æ–ª—É—á–µ–Ω—ã —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞'); //, data);
                delete window[callbackName];

                if (data.success && data.points) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à
                    try { localStorage.setItem(CACHE_KEY, JSON.stringify(data)); } catch (e) { }

                    processServerData(data);
                    // showNotification(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.points.length} –æ–±—ä–µ–∫—Ç–æ–≤`, 'success'); // üî• –û–¢–ö–õ–Æ–ß–ê–ï–ú –ù–ê–ó–û–ô–õ–ò–í–û–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–ï
                    console.log(`‚úÖ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: ${data.points.length} –æ–±—ä–µ–∫—Ç–æ–≤`);
                } else {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', data);
                    if (!hasCache) {
                        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    }
                }
            };

            // üî• –î–û–ë–ê–í–õ–Ø–ï–ú TIMESTAMP –î–õ–Ø –û–ë–•–û–î–ê –ö–≠–®–ê –ë–†–ê–£–ó–ï–†–ê
            const timestamp = Date.now();
            const random = Math.random().toString(36).substring(7);
            const url = SCRIPT_URL + '?action=getData&callback=' + callbackName + '&_=' + timestamp + '&r=' + random;

            // console.log('üü° –ó–∞–ø—Ä–æ—Å –∫ URL:', url);
            const script = document.createElement('script');
            script.src = url;

            script.onerror = function () {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞');
                delete window[callbackName];
                if (!hasCache) {
                    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
                }
            };

            document.head.appendChild(script);
        }

        function processServerData(data) {
            // üî• –í–û–ó–í–†–ê–©–ê–ï–ú –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ï ID (–±–µ–∑ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≤ —Å—Ç—Ä–æ–∫–∏!)
            objectsData = data.points;
            window.addedObjects = data.addedObjects || [];

            // üî• –°–û–•–†–ê–ù–Ø–ï–ú –õ–û–ö–ê–õ–¨–ù–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø, –ö–û–¢–û–†–´–ï –ë–´–õ–ò –°–î–ï–õ–ê–ù–´ –ù–ï–î–ê–í–ù–û (–≤ —Ç–µ—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 10 —Å–µ–∫—É–Ω–¥)
            const recentChanges = window.RECENT_INSPECTOR_CHANGES || {};
            const now = Date.now();
            const serverConfig = data.inspectorsConfig || {};
            const mergedConfig = { ...serverConfig };

            // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å –Ω–µ–¥–∞–≤–Ω–∏–º–∏ –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
            Object.keys(recentChanges).forEach(inspector => {
                const change = recentChanges[inspector];
                if (now - change.timestamp < 30000) { // 30 —Å–µ–∫—É–Ω–¥ (—É–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
                    console.log(`üîÑ –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–µ–¥–∞–≤–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è ${inspector}:`, change.config);
                    mergedConfig[inspector] = {
                        ...(mergedConfig[inspector] || {}),
                        ...change.config
                    };
                }
            });

            console.log('üìä –ó–∞–≥—Ä—É–∂–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–æ–≤:', Object.keys(mergedConfig).length, '–∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–æ–≤');

            // üî• –õ–û–ì–ò–†–£–ï–ú –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Æ –î–õ–Ø –û–¢–õ–ê–î–ö–ò
            Object.keys(mergedConfig).forEach(insp => {
                const cfg = mergedConfig[insp];
                if (cfg && cfg.color) {
                    console.log(`  - ${insp}: —Ü–≤–µ—Ç=${cfg.color}, –∏–∫–æ–Ω–∫–∞=${cfg.icon}, —Å—Ç–∞—Ç—É—Å=${cfg.status}`);
                }
            });

            window.INSPECTORS_CONFIG = mergedConfig;
            try { localStorage.removeItem(INSPECTORS_CACHE_KEY); localStorage.removeItem(INSPECTORS_CACHE_TIMESTAMP); } catch (_) { }
            window.INSPECTOR_HOMES = data.inspectorsHomes || {};
            availableIcons = data.availableIcons || {};
            availableColors = data.availableColors || [];
            (function () {
                var EXTRA_COLORS = ['#e74c3c', '#ff6b6b', '#ff9f43', '#f1c40f', '#2ecc71', '#1abc9c', '#3498db', '#9b59b6', '#8e44ad', '#34495e', '#7f8c8d', '#fd79a8', '#e84393', '#6c5ce7', '#0984e3', '#00b894', '#55efc4', '#ffeaa7', '#fab1a0', '#fdcb6e'];
                var set = {};
                availableColors.forEach(function (c) { set[c] = 1; });
                EXTRA_COLORS.forEach(function (c) { if (!set[c]) availableColors.push(c); });
                var EXTRA_ICONS = { star: '‚≠ê', pin: 'üìç', shield: 'üõ°Ô∏è', build: 'üèóÔ∏è', worker: 'üë∑', house: 'üè†', police: 'üöì', fire: 'üî•', anchor: '‚öì', leaf: 'üçÉ', light: 'üí°', tool: 'üõ†Ô∏è', rocket: 'üöÄ', diamond: 'üî∑', square: 'üî∂' };
                for (var k in EXTRA_ICONS) { if (availableIcons[k] === undefined) availableIcons[k] = EXTRA_ICONS[k]; }
                var EXTRA_EMOJIS = ['üòÅ', 'ü•π', 'ü§£', 'ü•≤', 'üòá', 'üôÇ', 'üòç', 'ü•∞', 'üòò', 'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü•∏', 'ü§©', 'ü•≥', 'üôÇ‚Äç‚ÜïÔ∏è', 'ü•∫', 'üò≠', 'üò§', 'üò°', 'ü§¨', 'ü§Ø', 'ü•∂', 'ü•µ', 'ü´£', 'ü§≠', 'ü´°', 'ü´†', 'ü§´', 'üòê', 'ü•±', 'üò¥', 'ü§§', 'üòµ', 'üòµ‚Äçüí´', 'ü§ê', 'ü•¥', 'ü§¢', 'ü§Æ', 'üò∑', 'ü§í', 'ü§ï', 'ü§ë', 'ü§†', 'üòà', 'üëø', 'üëπ', 'üë∫', 'ü§°', 'üí©', 'üëª', 'üíÄ', '‚ò†Ô∏è', 'üëΩ', 'ü§ñ', 'üéÉ', 'ü´∞', 'ü´∂', 'ü§û', '‚úåÔ∏è', 'üëä', 'ü§ù', 'ü§å', 'ü´µ', 'ü´¶', 'üß†', 'üëÅÔ∏è', 'ü§¥', 'ü¶π‚Äç‚ôÇÔ∏è', 'üßû‚Äç‚ôÇÔ∏è', 'üßû', 'üßú', 'üôÜ‚Äç‚ôÇÔ∏è', 'ü§¶‚Äç‚ôÇÔ∏è', 'üôã‚Äç‚ôÇÔ∏è', 'üßñ‚Äç‚ôÇÔ∏è', 'üßë‚Äçü¶Ω', 'üßë‚Äçü¶º', 'üëë', '‚õëÔ∏è', 'ü¶∫', 'üï∂Ô∏è', 'üêØ', 'ü¶Å', 'üêΩ', 'üêÆ', 'üê∑', 'üê∏', 'üêµ', 'üôà', 'üôâ', 'üôä', 'üêí', 'üêî', 'üê§', 'üê£', 'üê•', 'ü¶Ö', 'ü¶â', 'üê∫', 'ü¶Ñ', 'ü´é', 'üêù', 'üï∑Ô∏è', 'üï∏Ô∏è', 'ü¶Ç', 'üê¢', 'ü¶ñ', 'üêô', 'üê°', 'üê†', 'üêü', 'üê¨', 'üê≥', 'üêã', 'ü¶à', 'ü¶≠', 'ü¶ç', 'ü¶ß', 'ü™Ω', 'ü¶¶', 'üå™Ô∏è', 'üî•', 'üåà', 'üí´', '‚≠ê', '‚ú®', '‚ö°', 'üçå', 'üçë', 'üå∂Ô∏è', 'üçì', 'ü••', 'üç≠', 'üç¨', 'üç´', 'ü•É', 'üç∫', 'üçª', 'üç∑', 'üçæ', 'ü§º', 'üöÄ', 'üíµ', 'üí∏', 'üí∞', 'üí≥', 'üíé', 'üí£', 'üß®', 'üî™', 'ü¶†', 'üè¥‚Äç‚ò†Ô∏è'];
                EXTRA_EMOJIS.forEach(function (em, idx) { var key = 'emoji_' + idx; if (availableIcons[key] === undefined) availableIcons[key] = em; });
            })();


            console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –æ–±—ä–µ–∫—Ç–æ–≤:', objectsData.length);
            console.log('‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–æ–≤:', Object.keys(window.INSPECTORS_CONFIG).length);

            initInterface();
            updateMap();
            updateObjectsList();
        }



        // üî• –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –°–ß–ï–¢–ß–ò–ö–û–í –°–ü–ò–°–ö–û–í
        function calculateListStats() {
            const stats = {};
            const selectedInspectors = getSelectedInspectors(); // üî• –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–æ–≤

            objectsData.forEach(obj => {
                // üî• –£–ß–ò–¢–´–í–ê–ï–ú –¢–û–õ–¨–ö–û –û–ë–™–ï–ö–¢–´ –í–´–ë–†–ê–ù–ù–´–• –ò–ù–°–ü–ï–ö–¢–û–†–û–í
                if (selectedInspectors.length > 0 && !selectedInspectors.includes(obj.inspector)) {
                    return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±—ä–µ–∫—Ç—ã –Ω–µ–≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–æ–≤
                }

                if (!stats[obj.list]) {
                    stats[obj.list] = {
                        total: 0,
                        completed: 0,
                        active: 0
                    };
                }

                stats[obj.list].total++;

                if (obj.exitTime && obj.exitTime !== '') {
                    stats[obj.list].completed++;
                }
                if (obj.entryTime && !obj.exitTime) {
                    stats[obj.list].active++;
                }
            });

            return stats;
        }

        function initInterface() {
            console.log('üü° ========== –ù–ê–ß–ê–õ–û –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê ==========');

            // üî• –°–ö–†–´–í–ê–ï–ú –í–ö–õ–ê–î–ö–£ "–°–ü–ò–°–û–ö –û–ë–™–ï–ö–¢–û–í" –¢–û–õ–¨–ö–û –î–õ–Ø –ò–ú–ü–ï–†–ê–¢–û–†–ê
            const objectsBtn = document.getElementById('objectsTabBtn');
            if (objectsBtn) {
                if (userAccessRights === '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä') {
                    objectsBtn.style.display = 'none';
                } else {
                    objectsBtn.style.display = '';
                }
            }

            // üî• –°–ö–†–´–í–ê–ï–ú –§–ò–õ–¨–¢–† –ü–û –ò–ù–°–ü–ï–ö–¢–û–†–ê–ú –î–õ–Ø –û–ë–´–ß–ù–´–• –ò–ù–°–ü–ï–ö–¢–û–†–û–í
            const inspectorsFilter = document.getElementById('inspectorsFilterSection');
            if (inspectorsFilter) {
                if (userAccessRights === '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä' || userAccessRights === '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä') {
                    inspectorsFilter.style.display = '';
                } else {
                    inspectorsFilter.style.display = 'none';
                }
            }

            const uniqueLists = [...new Set((userAccessRights === '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä' || userAccessRights === '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'
                ? objectsData
                : objectsData.filter(o => isSameInspector(o.inspector, currentUser))
            ).map(obj => obj.list).filter(Boolean))].sort();

            // üî• –û–ë–ù–û–í–õ–Ø–ï–ú –ò–ö–û–ù–ö–£ –ò –ò–ú–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø (—Ç–∞–∫ –∫–∞–∫ –∫–æ–Ω—Ñ–∏–≥ –º–æ–≥ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –ø–æ–∑–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏)
            const userInfoText = document.getElementById('sidebarUserInfo');
            if (userInfoText && currentUser) {
                const style = getInspectorStyle(currentUser);
                userInfoText.textContent = `${style.icon} ${userAccessRights}: ${currentUser}`;
            }
            const inspectorStats = calculateInspectorStats();
            const listStats = calculateListStats();

            const inspectorsList = document.getElementById('inspectorsList');
            inspectorsList.innerHTML = '';

            // üî• –í–ö–õ–Æ–ß–ê–ï–ú ADMIN –¢–û–õ–¨–ö–û –î–õ–Ø –ò–ú–ü–ï–†–ê–¢–û–†–ê
            let allSystemInspectors = (userAccessRights === '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä' || userAccessRights === '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä')
                ? Object.keys(window.INSPECTORS_CONFIG || {}).filter(inspector => inspector !== '–Æ—Å—É–ø–æ–≤ –ê—Ä—Ç—É—Ä –†—É—Å–ª–∞–Ω–æ–≤–∏—á')
                : [currentUser];

            // üî• –ï–°–õ–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ù–ï –ò–ú–ü–ï–†–ê–¢–û–† - –ò–°–ö–õ–Æ–ß–ê–ï–ú ADMIN –ò–ó –§–ò–õ–¨–¢–†–û–í
            if (userAccessRights !== '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä') {
                allSystemInspectors = allSystemInspectors.filter(inspector => inspector !== 'Admin');
            }

            allSystemInspectors.forEach(inspector => {
                const style = getInspectorStyle(inspector);
                const stats = inspectorStats[inspector] || { total: 0, completed: 0, active: 0 };

                const hasAccessToObjects = userAccessRights === '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä' ||
                    userAccessRights === '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' ||
                    isSameInspector(inspector, currentUser);

                if (hasAccessToObjects) {
                    const checkbox = document.createElement('div');
                    checkbox.className = 'checkbox-item';

                    checkbox.innerHTML = `
                <input type="checkbox" id="insp_${inspector}" onchange="onInspectorChange()" 
                       ${isSameInspector(inspector, currentUser) ? 'checked' : ''}>
                <span class="inspector-icon">${style.icon}</span>
                <span class="color-dot" style="background-color: ${style.color}"></span>
                <label for="insp_${inspector}">
                    ${inspector}
                </label>
                <span class="inspector-counter ${inspector === 'Admin' ? 'admin' : ''} 
                      ${style.status !== 'active' ? 'inactive' : ''}">
                    ${stats.completed}/${stats.total}
                </span>
            `;
                    inspectorsList.appendChild(checkbox);
                }
            });

            const listsList = document.getElementById('listsList');
            listsList.innerHTML = '';

            uniqueLists.forEach(list => {
                const stats = listStats[list] || { total: 0, completed: 0, active: 0 };
                const checkbox = document.createElement('div');
                checkbox.className = 'checkbox-item';
                checkbox.innerHTML = `
            <input type="checkbox" id="list_${list}" onchange="onListChange()" checked>
            <label for="list_${list}">
                ${list} 
                <span class="list-counter">(${stats.completed}/${stats.total})</span>
            </label>
        `;
                listsList.appendChild(checkbox);
            });

            setTimeout(() => {
                updateInspectorCounters();

                // üî• –ó–ê–ì–†–£–ó–ö–ê –°–û–•–†–ê–ù–ï–ù–ù–´–• –§–ò–õ–¨–¢–†–û–í –ò–õ–ò –£–°–¢–ê–ù–û–í–ö–ê –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ
                if (!loadFilterState()) {
                    resetFiltersToDefault(); // –µ—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö - —Å—Ç–∞–≤–∏–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                }

                updateFilters();
                updateMasterCheckboxes();
            }, 100);
        }

        function getInspectorStyle(inspector) {
            if (!inspector) {
                return {
                    color: '#808080',
                    icon: 'üë®‚Äçüíº',
                    status: 'active',
                    accessRights: '–ò–Ω—Å–ø–µ–∫—Ç–æ—Ä'
                };
            }

            const config = window.INSPECTORS_CONFIG ? window.INSPECTORS_CONFIG[inspector] : null;
            if (config) {
                // üî• –ò–°–ü–û–õ–¨–ó–£–ï–ú –¢–û–õ–¨–ö–û –°–û–•–†–ê–ù–ï–ù–ù–´–ï –ó–ù–ê–ß–ï–ù–ò–Ø, –ë–ï–ó FALLBACK!
                let iconValue = config.icon;
                if (iconValue && typeof iconValue === 'string' && availableIcons && availableIcons[iconValue]) {
                    iconValue = availableIcons[iconValue];
                }
                if (!iconValue || typeof iconValue !== 'string' || /^[\d\.-]+$/.test(iconValue) || iconValue.length > 5) {
                    iconValue = 'üë®‚Äçüíº'; // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–∫–æ–Ω–∫–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–µ–≤–∞–ª–∏–¥–Ω–∞—è
                }

                // üî• –í–ê–ñ–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ü–≤–µ—Ç, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω –ø—É—Å—Ç–æ–π (–Ω–æ –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å)
                // Fallback —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ü–≤–µ—Ç –≤–æ–æ–±—â–µ –Ω–µ –∑–∞–¥–∞–Ω –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
                const fallback = getDeterministicFallbackStyle(inspector);
                return {
                    color: (config.color && config.color.trim()) ? config.color : fallback.color,
                    icon: iconValue,
                    status: config.status || 'active',
                    accessRights: config.accessRights || '–ò–Ω—Å–ø–µ–∫—Ç–æ—Ä'
                };
            }

            // üî• HARDCODED ADMIN STYLE
            if (inspector === 'Admin') {
                return {
                    color: '#3498db', // Blue
                    icon: '‚≠ê', // Star
                    status: 'active',
                    accessRights: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'
                };
            }

            // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤–æ–æ–±—â–µ –Ω–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback
            return getDeterministicFallbackStyle(inspector);
        }

        function getDeterministicFallbackStyle(inspector) {
            const name = String(inspector || '').trim();
            const colors = Array.isArray(availableColors) && availableColors.length ? availableColors : ['#3498db', '#e74c3c', '#2ecc71', '#f1c40f', '#9b59b6', '#1abc9c', '#34495e', '#e67e22'];
            let hash = 0;
            for (let i = 0; i < name.length; i++) { hash = ((hash << 5) - hash) + name.charCodeAt(i); hash |= 0; }
            const idx = Math.abs(hash) % colors.length;
            const color = colors[idx];
            return { color, icon: 'üë®‚Äçüíº', status: 'active', accessRights: '–ò–Ω—Å–ø–µ–∫—Ç–æ—Ä' };
        }

        function calculateInspectorStats(selectedLists = null) {
            const stats = {};

            objectsData.forEach(obj => {
                if (selectedLists && selectedLists.length > 0 && !selectedLists.includes(obj.list)) {
                    return;
                }

                if (!stats[obj.inspector]) {
                    stats[obj.inspector] = {
                        total: 0,
                        completed: 0,
                        active: 0
                    };
                }

                stats[obj.inspector].total++;

                if (obj.exitTime && obj.exitTime !== '') {
                    stats[obj.inspector].completed++;
                }
                if (obj.entryTime && !obj.exitTime) {
                    stats[obj.inspector].active++;
                }
            });

            return stats;
        }

        function hasFilterAccessToInspector(targetInspector) {
            return userAccessRights === '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä' || userAccessRights === '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
        }

        function isSameInspector(objInspector, userInspector) {
            if (!objInspector || !userInspector) return false;
            return objInspector.toLowerCase().trim() === userInspector.toLowerCase().trim();
        }

        function updateInspectorCounters() {
            const selectedLists = getSelectedLists();
            const inspectorStats = calculateInspectorStats(selectedLists.length > 0 ? selectedLists : null);

            const inspectorCheckboxes = document.querySelectorAll('#inspectorsList input[type="checkbox"]');
            inspectorCheckboxes.forEach(checkbox => {
                const inspector = checkbox.id.replace('insp_', '');
                const stats = inspectorStats[inspector] || { total: 0, completed: 0, active: 0 };
                const counterElement = checkbox.parentNode.querySelector('.inspector-counter');

                if (counterElement) {
                    counterElement.textContent = `${stats.completed}/${stats.total}`;

                    if (stats.total > 0 && stats.completed === stats.total) {
                        counterElement.classList.add('completed');
                    } else {
                        counterElement.classList.remove('completed');
                    }
                }
            });
        }

        // üî• –î–û–ë–ê–í–õ–Ø–ï–ú –§–£–ù–ö–¶–ò–Æ –û–ë–ù–û–í–õ–ï–ù–ò–Ø –°–ß–ï–¢–ß–ò–ö–û–í –°–ü–ò–°–ö–û–í
        function updateListCounters() {
            const listStats = calculateListStats(); // üî• –¢–µ–ø–µ—Ä—å —É—á–∏—Ç—ã–≤–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–æ–≤
            const listCheckboxes = document.querySelectorAll('#listsList input[type="checkbox"]');

            listCheckboxes.forEach(checkbox => {
                const list = checkbox.id.replace('list_', '');
                const stats = listStats[list] || { total: 0, completed: 0, active: 0 };
                const counterElement = checkbox.parentNode.querySelector('.list-counter');

                if (counterElement) {
                    counterElement.textContent = `(${stats.completed}/${stats.total})`;
                }
            });
        }



        // üî• –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ò –ö–ê–†–¢–ê
        function getSelectedInspectors() {
            const selected = [];
            const checkboxes = document.querySelectorAll('#inspectorsList input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                selected.push(checkbox.id.replace('insp_', ''));
            });
            return selected;
        }

        function getSelectedLists() {
            const selected = [];
            const checkboxes = document.querySelectorAll('#listsList input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                selected.push(checkbox.id.replace('list_', ''));
            });
            return selected;
        }

        function getFilteredObjects() {
            const selectedInspectors = getSelectedInspectors();
            const selectedLists = getSelectedLists();
            const showHidden = document.getElementById('showHidden').checked;
            const searchText = document.getElementById('searchInput').value.toLowerCase();

            if (userAccessRights === '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä' || userAccessRights === '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä') {
                return objectsData.filter(obj => {
                    if (selectedLists.length === 0) return false;
                    if (!selectedLists.includes(obj.list)) return false;
                    if (selectedInspectors.length > 0 && !selectedInspectors.includes(obj.inspector)) return false;

                    if (searchText &&
                        !obj.id.toString().toLowerCase().includes(searchText) &&
                        !obj.address.toLowerCase().includes(searchText)) {
                        return false;
                    }

                    const isCompleted = !!obj.exitTime;
                    if (!showHidden && isCompleted) {
                        return false;
                    }

                    return true;
                });
            }

            return objectsData.filter(obj => {
                if (selectedInspectors.length === 0) return false;
                if (!selectedInspectors.includes(obj.inspector)) return false;
                if (selectedLists.length === 0) return false;
                if (!selectedLists.includes(obj.list)) return false;

                const hasAccessToObject = userAccessRights === '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä' ||
                    userAccessRights === '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' ||
                    isSameInspector(obj.inspector, currentUser) ||
                    hasFilterAccessToInspector(obj.inspector);

                if (!hasAccessToObject) {
                    return false;
                }

                const isCompleted = !!obj.exitTime;
                if (!showHidden && isCompleted) {
                    return false;
                }

                return true;
            });
        }

        let updateMapTimer = null;

        function updateMap() {
            // üî• GUARD CLAUSE: Simple and Safe
            // If the map components don't exist yet, we just stop.
            // The data is still safely in 'objectsData', and initMap will call us later.
            if (typeof objectManager === 'undefined' || !objectManager ||
                typeof activeObjectsLayer === 'undefined' || !activeObjectsLayer) {
                return;
            }

            // üî• DEBOUNCE: Prevent double updates
            if (updateMapTimer) clearTimeout(updateMapTimer);
            updateMapTimer = setTimeout(() => {
                performMapUpdate();
            }, 100);
        }

        function performMapUpdate() {
            if (objectsData.length === 0) {
                try { objectManager.removeAll(); activeObjectsLayer.removeAll(); } catch (e) { }
                console.log('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ');
                return;
            }

            const filteredObjects = getFilteredObjects();
            console.log('üü° –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã —Å', filteredObjects.length, '–æ–±—ä–µ–∫—Ç–∞–º–∏ (Smart Update)');

            // 1. –°–æ–∑–¥–∞–µ–º Map —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
            const existingObjects = new Set();
            try {
                if (objectManager.objects) objectManager.objects.each(obj => existingObjects.add(obj.id));
                if (activeObjectsLayer.objects) activeObjectsLayer.objects.each(obj => existingObjects.add(obj.id));
            } catch (e) { console.error(e); }

            // 2. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–µ —Ñ–∏—á–∏
            const objectsToRemove = new Set(existingObjects);
            const featuresToAdd = [];
            const activeFeaturesToAdd = [];

            filteredObjects.forEach(obj => {
                const id = obj.id;

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏ —Å—Ç–∏–ª—å
                const isNew = !obj.entryTime && !obj.exitTime;
                const isActive = obj.entryTime && !obj.exitTime;
                const isCompleted = !!obj.exitTime;
                const style = getInspectorStyle(obj.inspector);

                let preset = 'islands#dotIcon'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - –¥–µ–≤—è—Ç–∫–∞ —Å —Ç–æ—á–∫–æ–π (–∫–∞–∫ –±—ã–ª–æ)
                let iconContent = undefined;
                let iconColor = style.color;
                let iconSize = [30, 30]; // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–∞–∑–º–µ—Ä
                let targetLayer = objectManager;

                if (isActive) {
                    preset = 'islands#circleIcon'; // –¢–æ—á–∫–∞ –≤ —Ä–∞–±–æ—Ç–µ - –∫—Ä—É–∂–æ–∫
                    iconSize = [50, 50]; // –ü–æ–±–æ–ª—å—à–µ
                    targetLayer = activeObjectsLayer;
                } else if (isCompleted) {
                    preset = 'islands#greenMedicalIcon'; // –í—ã–ø–æ–ª–Ω–µ–Ω–∞ - –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∫—Ä–µ—Å—Ç
                    iconContent = undefined;           // –ö–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –Ω—É–∂–µ–Ω –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–µ—Å–µ—Ç–∞
                    iconColor = style.color;     // –¶–≤–µ—Ç –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–∞
                } else {
                    // –ù–æ–≤–∞—è —Ç–æ—á–∫–∞ - –ø—Ä–æ—Å—Ç–æ –¥–µ–≤—è—Ç–∫–∞
                    const isImperial = obj.inspector === 'Admin' ||
                        (window.INSPECTORS_CONFIG[obj.inspector] &&
                            window.INSPECTORS_CONFIG[obj.inspector].accessRights === '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä');
                    // –ï—Å–ª–∏ –∏–º–ø–µ—Ä–∞—Ç–æ—Ä - –∑–≤–µ–∑–¥–æ—á–∫–∞, –∏–Ω–∞—á–µ –æ–±—ã—á–Ω–∞—è –¥–µ–≤—è—Ç–∫–∞
                    if (isImperial) preset = 'islands#blueStarIcon';
                }

                // –§–æ—Ä–º–∏—Ä—É–µ–º Feature
                const feature = {
                    type: 'Feature',
                    id: id,
                    geometry: {
                        type: 'Point',
                        coordinates: [parseFloat(obj.latitude), parseFloat(obj.longitude)]
                    },
                    properties: {
                        hintContent: getHintContent(obj),
                        balloonContent: getBalloonContent(obj, style.icon),
                        inspector: obj.inspector,
                        list: obj.list,
                        address: obj.address,
                        checklistLink: obj.checklistLink,
                        yandexDiskLink: obj.yandexDiskLink,
                        iconContent: iconContent
                    },
                    options: {
                        preset: preset,
                        iconColor: iconColor,
                        iconSize: iconSize
                    }
                };

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –æ–±—ä–µ–∫—Ç –Ω–∞ –∫–∞—Ä—Ç–µ
                if (existingObjects.has(id)) {
                    // –û–±—ä–µ–∫—Ç —É–∂–µ –µ—Å—Ç—å. –ü—Ä–æ–≤–µ—Ä–∏–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ –æ–Ω –≤–∏–∑—É–∞–ª—å–Ω–æ?
                    // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã: –µ—Å–ª–∏ —Å–ª–æ–π —Ç–æ—Ç –∂–µ, –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –Ω–µ—Ç - –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º.
                    // –ù–æ Yandex ObjectManager –Ω–µ –¥–∞–µ—Ç –ø—Ä–æ—Å—Ç–æ —Å–º–µ–Ω–∏—Ç—å —Å–ª–æ–π.

                    const existingInOM = objectManager.objects.getById(id);
                    const existingInActive = activeObjectsLayer.objects.getById(id);

                    let needsRecreate = false;

                    // –ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ active, –∞ –æ–Ω –≤ –æ–±—ã—á–Ω–æ–º (–∏–ª–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç)
                    if (isActive && !existingInActive) needsRecreate = true;
                    if (!isActive && existingInActive) needsRecreate = true;

                    if (!needsRecreate) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–π—Å—Ç–≤–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞ (—á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–Ω—Ç –±–∞–ª–ª—É–Ω–∞ –æ–±–Ω–æ–≤–∏–ª—Å—è)
                        const targetManager = isActive ? activeObjectsLayer : objectManager;
                        try {
                            // –û–±–Ω–æ–≤–ª—è–µ–º properties (–±–∞–ª–ª—É–Ω, —Ö–∏–Ω—Ç)
                            targetManager.objects.setObjectProperties(id, feature.properties);
                            // –û–±–Ω–æ–≤–ª—è–µ–º options (–∏–∫–æ–Ω–∫–∞, —Ü–≤–µ—Ç - –≤–¥—Ä—É–≥ —Å–º–µ–Ω–∏–ª—Å—è —Å—Ç–∞—Ç—É—Å –∏–ª–∏ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä)
                            targetManager.objects.setObjectOptions(id, feature.options);
                        } catch (e) {
                            console.warn('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞', id, e);
                        }

                        // –£–±–∏—Ä–∞–µ–º –∏–∑ —Å–ø–∏—Å–∫–∞ "–Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ"
                        objectsToRemove.delete(id);
                        return; // –ë–æ–ª—å—à–µ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º —Å —ç—Ç–∏–º –æ–±—ä–µ–∫—Ç–æ–º
                    }
                }

                // –ï—Å–ª–∏ –º—ã –∑–¥–µ—Å—å - –æ–±—ä–µ–∫—Ç–∞ –Ω–µ—Ç –∏–ª–∏ –µ–≥–æ –Ω–∞–¥–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å
                if (isActive) {
                    activeFeaturesToAdd.push(feature);
                } else {
                    featuresToAdd.push(feature);
                }

                // –ï—Å–ª–∏ –æ–Ω –±—ã–ª –≤ existing (–Ω–æ –º—ã —Ä–µ—à–∏–ª–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å), –æ–Ω –æ—Å—Ç–∞–ª—Å—è –≤ objectsToRemove, 
                // —Ç–∞–∫ —á—Ç–æ –æ–Ω —É–¥–∞–ª–∏—Ç—Å—è –≤ –∫–æ–Ω—Ü–µ, –∞ –Ω–æ–≤—ã–π –¥–æ–±–∞–≤–∏—Ç—Å—è. –í—Å—ë –≤–µ—Ä–Ω–æ.
            });

            // 3. –£–¥–∞–ª—è–µ–º –∏—Å—á–µ–∑–Ω—É–≤—à–∏–µ –æ–±—ä–µ–∫—Ç—ã (–∏–ª–∏ —Ç–µ, —á—Ç–æ —Ç—Ä–µ–±—É—é—Ç –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è)
            const toRemoveArray = Array.from(objectsToRemove);
            if (toRemoveArray.length > 0) {
                // console.log('–£–¥–∞–ª—è–µ–º –æ–±—ä–µ–∫—Ç–æ–≤:', toRemoveArray.length);
                try { objectManager.remove(toRemoveArray); } catch (e) { }
                try { activeObjectsLayer.remove(toRemoveArray); } catch (e) { }
            }

            // 4. –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
            if (featuresToAdd.length > 0) {
                // console.log('–î–æ–±–∞–≤–ª—è–µ–º –æ–±—ã—á–Ω—ã—Ö:', featuresToAdd.length);
                objectManager.add({
                    type: 'FeatureCollection',
                    features: featuresToAdd
                });
            }
            if (activeFeaturesToAdd.length > 0) {
                // console.log('–î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö:', activeFeaturesToAdd.length);
                activeObjectsLayer.add({
                    type: 'FeatureCollection',
                    features: activeFeaturesToAdd
                });
            }


            updateInspectorCounters();

            if (document.getElementById('objects-tab').classList.contains('active')) {
                updateObjectsList();
            }
        }

        function getHintContent(obj) {
            const isActive = obj.entryTime && !obj.exitTime;
            const isCompleted = !!obj.exitTime;
            if (isActive) return `üîµ –ê–ö–¢–ò–í–ù–ê –¢–æ—á–∫–∞ ‚Ññ${obj.id} (${obj.list || '–ë–µ–∑ —Å–ø–∏—Å–∫–∞'})`;
            if (isCompleted) return `‚úÖ –í–´–ü–û–õ–ù–ï–ù–ê –¢–æ—á–∫–∞ ‚Ññ${obj.id} (${obj.list || '–ë–µ–∑ —Å–ø–∏—Å–∫–∞'})`;
            return `üü° –¢–æ—á–∫–∞ ‚Ññ${obj.id} (${obj.list || '–ë–µ–∑ —Å–ø–∏—Å–∫–∞'})`;
        }

        // üî• –£–õ–£–ß–®–ï–ù–ù–û–ï –¢–û–ß–ï–ß–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–ê–†–¢–´ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
        function updateSinglePointOnMap(objectId, newStatus) {
            const object = objectsData.find(obj => obj.id == objectId); // üî• –ò–°–ü–†–ê–í–õ–ï–ù–û: == –≤–º–µ—Å—Ç–æ ===
            if (!object) return;

            console.log(`üîÑ –¢–æ—á–µ—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ—á–∫–∏ ${objectId} -> ${newStatus}`);

            // üî• –£–î–ê–õ–Ø–ï–ú –ò–ó –í–°–ï–• –°–õ–û–ï–í –°–†–ê–ó–£ (–†–û–ë–ê–°–¢–ù–´–ô –ú–ï–¢–û–î)
            // –°–Ω–∞—á–∞–ª–∞ —è–≤–Ω–æ —É–¥–∞–ª—è–µ–º –ø–æ ID (–¥–ª—è –≤–µ—Ä–Ω–æ—Å—Ç–∏)
            try { objectManager.remove(objectId); } catch (_) { }
            try { activeObjectsLayer.remove(objectId); } catch (_) { }

            // –ó–∞—Ç–µ–º –ø—Ä–æ—Ö–æ–¥–∏–º –∏—Ç–µ—Ä–∞—Ç–æ—Ä–æ–º –∏ —É–¥–∞–ª—è–µ–º –≤—Å—ë, —á—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ —ç—Ç–æ—Ç ID (—Å—Ç—Ä–æ–≥–æ –∏ –Ω–µ —Å—Ç—Ä–æ–≥–æ)
            const targetId = objectId;
            let removedCount = 0;

            const removeResult1 = [];
            objectManager.objects.each(function (obj) {
                if (obj.id == targetId) removeResult1.push(obj);
            });
            removeResult1.forEach(obj => {
                objectManager.objects.remove(obj);
                removedCount++;
            });

            const removeResult2 = [];
            activeObjectsLayer.objects.each(function (obj) {
                if (obj.id == targetId) removeResult2.push(obj);
            });
            removeResult2.forEach(obj => {
                activeObjectsLayer.objects.remove(obj);
                removedCount++;
            });

            console.log(`üßπ –£–¥–∞–ª–µ–Ω–æ –æ–±—ä–µ–∫—Ç–æ–≤: ${removedCount} –¥–ª—è ID: ${targetId}`);

            const existedActive = false; // –ú—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç, —Ç–∞–∫ —á—Ç–æ –Ω–µ –≤–∞–∂–Ω–æ –≥–¥–µ –æ–Ω –±—ã–ª

            const style = getInspectorStyle(object.inspector);
            console.log(`üé® –°—Ç–∏–ª—å –¥–ª—è –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–∞ ${object.inspector}: color=${style.color}, icon=${style.icon}`);

            let feature;

            if (newStatus === 'active') {
                // üîµ –ê–ö–¢–ò–í–ù–ê–Ø –¢–û–ß–ö–ê - –ö–†–£–ñ–û–ö
                feature = {
                    type: 'Feature',
                    id: object.id,
                    geometry: {
                        type: 'Point',
                        coordinates: [parseFloat(object.latitude), parseFloat(object.longitude)]
                    },
                    properties: {
                        hintContent: `üîµ –ê–ö–¢–ò–í–ù–ê –¢–æ—á–∫–∞ ‚Ññ${object.id} (${object.list || '–ë–µ–∑ —Å–ø–∏—Å–∫–∞'})`,
                        balloonContent: getBalloonContent(object, style.icon),
                        inspector: object.inspector,
                        list: object.list,
                        address: object.address,
                        checklistLink: object.checklistLink,
                        yandexDiskLink: object.yandexDiskLink,
                        iconContent: undefined
                    },
                    options: {
                        preset: 'islands#circleIcon', // –ö—Ä—É–∂–æ–∫
                        iconColor: style.color,
                        iconSize: [50, 50]
                    }
                };
                if (!existedActive) {
                    activeObjectsLayer.add({ type: 'FeatureCollection', features: [feature] });
                }

            } else if (newStatus === 'completed') {
                // ‚úÖ –í–´–ü–û–õ–ù–ï–ù–ù–ê–Ø –¢–û–ß–ö–ê - –î–ï–í–Ø–¢–ö–ê –° –ü–õ–Æ–°–ò–ö–û–ú
                feature = {
                    type: 'Feature',
                    id: object.id,
                    geometry: {
                        type: 'Point',
                        coordinates: [parseFloat(object.latitude), parseFloat(object.longitude)]
                    },
                    properties: {
                        hintContent: `‚úÖ –í–´–ü–û–õ–ù–ï–ù–ê –¢–æ—á–∫–∞ ‚Ññ${object.id} (${object.list || '–ë–µ–∑ —Å–ø–∏—Å–∫–∞'})`,
                        balloonContent: getBalloonContent(object, style.icon),
                        inspector: object.inspector,
                        list: object.list,
                        address: object.address,
                        checklistLink: object.checklistLink,
                        yandexDiskLink: object.yandexDiskLink,
                        iconContent: undefined // –ö–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –Ω—É–∂–µ–Ω –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–µ—Å–µ—Ç–∞
                    },
                    options: {
                        preset: 'islands#greenMedicalIcon', // –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∫—Ä–µ—Å—Ç
                        iconColor: style.color,
                        iconSize: [30, 30]
                    }
                };
                objectManager.add({ type: 'FeatureCollection', features: [feature] });

            } else if (newStatus === 'new') {
                // üü° –ù–û–í–ê–Ø –¢–û–ß–ö–ê - –°–¢–ê–ù–î–ê–†–¢–ù–ê–Ø –ú–ï–¢–ö–ê
                const isImperial = object.inspector === 'Admin' ||
                    (window.INSPECTORS_CONFIG[object.inspector] &&
                        window.INSPECTORS_CONFIG[object.inspector].accessRights === '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä');
                const markerType = isImperial ? 'islands#blueStarIcon' : 'islands#dotIcon'; // –í–µ—Ä–Ω—É–ª–∏ dotIcon

                feature = {
                    type: 'Feature',
                    id: object.id,
                    geometry: {
                        type: 'Point',
                        coordinates: [parseFloat(object.latitude), parseFloat(object.longitude)]
                    },
                    properties: {
                        hintContent: `üü° –¢–æ—á–∫–∞ ‚Ññ${object.id} (${object.list || '–ë–µ–∑ —Å–ø–∏—Å–∫–∞'})`,
                        balloonContent: getBalloonContent(object, style.icon),
                        inspector: object.inspector,
                        list: object.list,
                        address: object.address,
                        checklistLink: object.checklistLink,
                        yandexDiskLink: object.yandexDiskLink,
                        iconContent: undefined
                    },
                    options: {
                        preset: markerType,
                        iconColor: style.color,
                        iconSize: [30, 30]
                    }
                };
                objectManager.add({ type: 'FeatureCollection', features: [feature] });
            }

            console.log('‚úÖ –¢–æ—á–µ—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ:', objectId, newStatus);

            // üî• –û–ë–ù–û–í–õ–Ø–ï–ú –ë–ê–õ–õ–£–ù –ï–°–õ–ò –û–ù –û–¢–ö–†–´–¢
            // üî• –û–ë–ù–û–í–õ–Ø–ï–ú –ë–ê–õ–õ–£–ù/–û–í–ï–†–õ–ï–ô –ï–°–õ–ò –û–ù –û–¢–ö–†–´–¢
            setTimeout(() => {
                // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π –æ–≤–µ—Ä–ª–µ–π
                if (window.CURRENT_OPEN_OBJECT_ID && window.CURRENT_OPEN_OBJECT_ID == objectId) {
                    const overlay = document.getElementById('objectDetailsOverlay');
                    if (overlay && overlay.classList.contains('object-details--visible')) {
                        renderObjectDetails(object);
                    }
                }

                // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –±–∞–ª—É–Ω –Ø–Ω–¥–µ–∫—Å–∞ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
                try {
                    const activeBalloon = objectManager.objects.balloon.getData() || (activeObjectsLayer && activeObjectsLayer.objects.balloon.getData());
                    if (activeBalloon && activeBalloon.feature && activeBalloon.feature.id == objectId) {
                        showObjectBalloon(objectId);
                    }
                } catch (e) { }
            }, 50);
        }

        function showObjectBalloon(objectId) {
            if (window.resetObjectCardTransform) window.resetObjectCardTransform();
            openObjectDetails(objectId);
        }

        function getBalloonContent(obj, icon) {
            const isNew = !obj.entryTime && !obj.exitTime;
            const isActive = obj.entryTime && !obj.exitTime;
            const isCompleted = !!obj.exitTime;
            const coordinates = `${obj.latitude}, ${obj.longitude}`;

            let badgeClass = 'object-card__badge object-card__badge--new';
            let badgeText = '–ù–æ–≤–∞—è';
            if (isActive) { badgeClass = 'object-card__badge object-card__badge--active'; badgeText = '–í —Ä–∞–±–æ—Ç–µ'; }
            else if (isCompleted) { badgeClass = 'object-card__badge object-card__badge--completed'; badgeText = '–í—ã–ø–æ–ª–Ω–µ–Ω–∞'; }

            const checklistButton = obj.checklistLink ?
                `<a href="${obj.checklistLink}" target="_blank" class="object-card__button object-card__button--primary">üìù –ß–µ–∫-–ª–∏—Å—Ç</a>` : '';
            const yandexDiskButton = obj.yandexDiskLink ?
                `<button type="button" class="object-card__button object-card__button--primary" data-yandex-object="${obj.id}" data-yandex-link="${obj.yandexDiskLink}">üìÅ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫</button>` : '';

            const canMarkEntryExit = (userAccessRights === '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä' || userAccessRights === '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä') ||
                isSameInspector(obj.inspector, currentUser);

            let entrySection = '';
            let notices = '';
            if (!isCompleted) {
                if (isNew && canMarkEntryExit) {
                    const canEnter = canInspectorEnterObject(obj.inspector, obj.id);
                    if (canEnter.canEnter) {
                        entrySection = `<div class="object-card__actions"><button class="object-card__button object-card__button--primary" onclick="markEntry('${obj.id}')">üö™ –í—Ö–æ–¥</button></div>`;
                    } else {
                        entrySection = `<div class="object-card__actions"><button class="object-card__button object-card__button--primary" disabled>üö™ –í—Ö–æ–¥</button></div>`;
                        notices += `<div class="object-card__notice object-card__notice--warning">${canEnter.message}</div>`;
                        if (canEnter.activeObjectId) {
                            const activeObj = objectsData.find(o => o.id == canEnter.activeObjectId);
                            if (activeObj) {
                                notices += `<button class="object-card__link" onclick="map.setCenter([${activeObj.latitude}, ${activeObj.longitude}], 17); openObjectDetails('${activeObj.id}');">üìç –ü–µ—Ä–µ–π—Ç–∏ –∫ –∞–∫—Ç–∏–≤–Ω–æ–º—É –æ–±—ä–µ–∫—Ç—É ${canEnter.activeObjectId}</button>`;
                            }
                        }
                    }
                } else if (isActive && canMarkEntryExit) {
                    entrySection = `<div class="object-card__actions"><button class="object-card__button object-card__button--danger" onclick="markExit('${obj.id}')">üö™ –í—ã—Ö–æ–¥</button></div>`;
                    if (userAccessRights === '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä' || userAccessRights === '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä') {
                        entrySection += `<div class="object-card__actions"><button class="object-card__button object-card__button--danger" onclick="cancelEntry('${obj.id}')">–û—Ç–º–µ–Ω–∏—Ç—å –≤—Ö–æ–¥</button></div>`;
                    }
                } else if (!canMarkEntryExit) {
                    notices += `<div class="object-card__notice object-card__notice--info">‚ö†Ô∏è –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä—É: ${obj.inspector}</div>`;
                }
            } else {
                notices += `<div class="object-card__notice object-card__notice--muted">üö´ –î–µ–π—Å—Ç–≤–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</div>`;
            }

            const reassignSelect = (userAccessRights === '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä' || (userAccessRights === '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' && !isCompleted)) ? `
                <div class="object-card__section object-card__section--reassign">
                  <label class="object-card__label">–ü–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–∏—Ç—å –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–∞</label>
                  
                  <div class="custom-select-container" id="customReassign_${obj.id}">
                    <div class="select-selected" onclick="toggleReassignDropdown('${obj.id}')">
                        ${obj.inspector ?
                    (() => {
                        const s = getInspectorStyle(obj.inspector);
                        return `<span>${s.icon} ${obj.inspector}</span>`;
                    })()
                    : '<span>-- –í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–∞ --</span>'
                }
                    </div>
                    <div class="select-items">
                        ${Array.from(new Set(['Admin', ...Object.keys(window.INSPECTOR_HOMES || {})])).sort().map(inspector => {
                    const style = getInspectorStyle(inspector);
                    const statusText = style.status !== 'active' ? ` (${getStatusText(style.status)})` : '';
                    const isCurrent = obj.inspector === inspector;
                    const isDisabled = (style.status !== 'active' && inspector !== 'Admin');
                    const divClass = isCurrent ? 'same-as-selected' : (isDisabled ? 'disabled-option' : '');
                    const clickAction = isDisabled ? '' : `selectReassignOption('${obj.id}', '${inspector}', '${style.icon} ${inspector}')`;

                    return `
                                <div class="${divClass}" onclick="${clickAction}">
                                    <span>${style.icon} ${inspector}${statusText}</span>
                                    ${isCurrent ? '<span>‚Üê —Ç–µ–∫—É—â–∏–π</span>' : ''}
                                </div>`;
                }).join('')}
                    </div>
                  </div>

                </div>
              ` : '';

            const inspectorDisplay = obj.inspector || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω';

            return `
                <div class="object-card">
                    <div class="object-card__header">
                        <div class="object-card__title">
                            <span class="object-card__emoji">${icon || 'üìç'}</span>
                            <div>
                                <div class="object-card__name">–¢–æ—á–∫–∞ ‚Ññ${obj.id}</div>
                                <div class="object-card__meta">${obj.list || '–ë–µ–∑ —Å–ø–∏—Å–∫–∞'}</div>
                            </div>
                        </div>
                        <span class="${badgeClass}">${badgeText}</span>
                    </div>

                    <div class="object-card__info">
                        <div class="object-card__row">
                            <span class="object-card__label">–ê–¥—Ä–µ—Å</span>
                            <span class="object-card__value">${obj.address || '‚Äî'}</span>
                        </div>
                        <div class="object-card__row">
                            <span class="object-card__label">–ò–Ω—Å–ø–µ–∫—Ç–æ—Ä</span>
                            <span class="object-card__value">${inspectorDisplay}</span>
                        </div>
                    </div>

                    <div class="object-card__actions">
                        <button class="object-card__button object-card__button--primary" onclick="copyCoordinates('${coordinates}')">üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</button>
                        ${checklistButton}
                        ${yandexDiskButton}
                    </div>
                    ${entrySection}
                    ${notices}
                    ${reassignSelect}
                    <div class="object-card__spacer"></div>
                </div>
            `;
        }

        function renderObjectDetails(object) {
            const content = document.getElementById('objectDetailsContent');
            if (!content) return;
            const style = getInspectorStyle(object.inspector);
            content.innerHTML = getBalloonContent(object, style.icon);

            // üî• –û–ë–ï–°–ü–ï–ß–ò–í–ê–ï–ú –ì–ò–ë–ö–ò–ô –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø content
            content.style.display = 'flex';
            content.style.flexDirection = 'column';
            content.style.height = '100%';
            content.style.overflow = 'hidden';

            // –ù–∞—Ö–æ–¥–∏–º –∫–∞—Ä—Ç–æ—á–∫—É –∏ –¥–µ–ª–∞–µ–º –µ—ë —Å–∫—Ä–æ–ª–ª—è—â–µ–π—Å—è
            const card = content.querySelector('.object-card');
            if (card) {
                card.style.flex = '1 1 auto';
                card.style.overflowY = 'auto';
                card.style.maxHeight = 'none'; // –£–±–∏—Ä–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ, —Ç–∞–∫ –∫–∞–∫ flex —Å–∞–º –æ–≥—Ä–∞–Ω–∏—á–∏—Ç
                card.style.paddingBottom = '0'; // –û—Ç—Å—Ç—É–ø –±—É–¥–µ—Ç —É —Ö–ª—è—Å—Ç–∏–∫–∞
            }

            // üî• –î–û–ë–ê–í–õ–Ø–ï–ú –•–õ–Ø–°–¢–ò–ö (–¢–ï–ü–ï–†–¨ –û–ù –í–ù–ï –ö–ê–†–¢–û–ß–ö–ò)
            const handle = document.createElement('div');
            handle.className = 'balloon-handle';
            handle.innerHTML = '<span></span>';
            handle.onclick = closeObjectDetails;

            content.appendChild(handle);
            initBalloonSwipe(handle);

            const holder = document.createElement('div');
            holder.id = 'checklistFormContainer';
            content.appendChild(holder);
            const uploader = document.createElement('div');
            uploader.id = 'photoUploaderContainer';
            content.appendChild(uploader);

            // üî• –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ù–û–ü–ö–ò –Ø–ù–î–ï–ö–°.–î–ò–°–ö
            initYandexDiskButtons();
        }

        // üî• –õ–û–ì–ò–ö–ê –°–í–ê–ô–ü–ê –ë–ê–õ–£–ù–ê
        function initBalloonSwipe(element) {
            let startY = 0;

            element.addEventListener('touchstart', e => {
                if (e.changedTouches.length > 0) {
                    startY = e.changedTouches[0].clientY;
                }
            }, { passive: true });

            element.addEventListener('touchend', e => {
                if (e.changedTouches.length > 0) {
                    const endY = e.changedTouches[0].clientY;
                    const diff = endY - startY;

                    // –°–≤–∞–π–ø –í–í–ï–†–• –∏–ª–∏ –í–ù–ò–ó (> 50px) –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –±–∞–ª—É–Ω
                    if (Math.abs(diff) > 50) {
                        closeObjectDetails();
                    }
                }
            }, { passive: true });
        }

        function openObjectDetails(objectId) {
            const object = objectsData.find(obj => obj.id == objectId);
            const overlay = document.getElementById('objectDetailsOverlay');
            if (!object || !overlay) return;
            try {
                if (objectManager && objectManager.objects && objectManager.objects.balloon) {
                    objectManager.objects.balloon.close();
                }
                if (activeObjectsLayer && activeObjectsLayer.objects && activeObjectsLayer.objects.balloon) {
                    activeObjectsLayer.objects.balloon.close();
                }
            } catch (_) { }
            renderObjectDetails(object);
            window.CURRENT_OPEN_OBJECT_ID = objectId; // üî• –ó–ê–ü–û–ú–ò–ù–ê–ï–ú –û–¢–ö–†–´–¢–´–ô –û–ë–™–ï–ö–¢
            overlay.classList.add('object-details--visible');
            overlay.classList.remove('hidden');
            document.body.classList.add('object-details-open');
        }

        function closeObjectDetails() {
            window.CURRENT_OPEN_OBJECT_ID = null; // üî• –°–ë–†–ê–°–´–í–ê–ï–ú
            const overlay = document.getElementById('objectDetailsOverlay');
            if (!overlay) return;
            overlay.classList.remove('object-details--visible');
            overlay.classList.add('hidden');
            document.body.classList.remove('object-details-open');
        }

        document.addEventListener('DOMContentLoaded', function () {
            const overlay = document.getElementById('objectDetailsOverlay');
            if (overlay) {
                const backdrop = overlay.querySelector('.object-details__backdrop');
                if (backdrop) {
                    backdrop.addEventListener('click', function () { closeObjectDetails(); });
                }
            }
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    closeObjectDetails();
                }
            });
        });

        function checkInspectorActiveObject(inspector) {
            if (!inspector) return null;

            const activeObject = objectsData.find(obj =>
                obj.inspector === inspector &&
                obj.entryTime &&
                !obj.exitTime
            );

            return activeObject;
        }

        function canInspectorEnterObject(inspector, objectId) {
            if (userAccessRights === '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä' || userAccessRights === '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä') {
                return { canEnter: true };
            }

            const activeObject = checkInspectorActiveObject(inspector);

            if (activeObject) {
                if (activeObject.id == objectId) {
                    return { canEnter: false, message: '–í—ã —É–∂–µ –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –Ω–∞ —ç—Ç–æ–º –æ–±—ä–µ–∫—Ç–µ' };
                } else {
                    return {
                        canEnter: false,
                        message: `–ù–µ–ª—å–∑—è –≤–æ–π—Ç–∏ –Ω–∞ –æ–±—ä–µ–∫—Ç ${objectId}. –°–Ω–∞—á–∞–ª–∞ –∑–∞–≤–µ—Ä—à–∏—Ç–µ –æ–±—ä–µ–∫—Ç ${activeObject.id}`,
                        activeObjectId: activeObject.id
                    };
                }
            }

            return { canEnter: true };
        }

        function getStatusText(status) {
            switch (status) {
                case 'active': return 'üü¢ –ê–∫—Ç–∏–≤–µ–Ω';
                case 'vacation': return 'üèñÔ∏è –í –æ—Ç–ø—É—Å–∫–µ';
                case 'sick': return 'ü§í –ù–∞ –±–æ–ª—å–Ω–∏—á–Ω–æ–º';
                default: return '‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            }
        }

        function copyCoordinates(coordinates) {
            navigator.clipboard.writeText(coordinates).then(() => {
                showNotification('‚úÖ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã: ' + coordinates, 'success');
            }).catch(() => {
                const textArea = document.createElement('textarea');
                textArea.value = coordinates;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('‚úÖ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã: ' + coordinates, 'success');
            });
        }

        // üî• –†–ê–ë–û–¢–ê –° –¢–û–ß–ö–ê–ú–ò - –£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
        function markEntry(objectId) {
            const object = objectsData.find(obj => obj.id == objectId); // üî• –ò–°–ü–†–ê–í–õ–ï–ù–û: == –≤–º–µ—Å—Ç–æ ===
            if (!object) {
                showNotification('‚ùå –û–±—ä–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }

            const canMarkEntryExit = (userAccessRights === '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä' || userAccessRights === '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä') ||
                isSameInspector(object.inspector, currentUser);

            if (!canMarkEntryExit) {
                showNotification('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –≤—Ö–æ–¥–∞ –Ω–∞ —á—É–∂–æ–π –æ–±—ä–µ–∫—Ç', 'error');
                return;
            }

            if (userAccessRights === '–ò–Ω—Å–ø–µ–∫—Ç–æ—Ä') {
                const canEnter = canInspectorEnterObject(currentUser, objectId);
                if (!canEnter.canEnter) {
                    showNotification('‚ùå ' + canEnter.message, 'error');
                    if (canEnter.activeObjectId) {
                        setTimeout(() => {
                            const activeObj = objectsData.find(o => o.id == canEnter.activeObjectId); // üî• –ò–°–ü–†–ê–í–õ–ï–ù–û: == –≤–º–µ—Å—Ç–æ ===
                            if (activeObj) {
                                map.setCenter([parseFloat(activeObj.latitude), parseFloat(activeObj.longitude)], 17);
                                showObjectBalloon(activeObj.id);
                            }
                        }, 1000);
                    }
                    return;
                }
            }

            performMarkEntry(objectId);
        }

        function markExit(objectId) {
            const object = objectsData.find(obj => obj.id == objectId); // üî• –ò–°–ü–†–ê–í–õ–ï–ù–û: == –≤–º–µ—Å—Ç–æ ===
            if (!object) {
                showNotification('‚ùå –û–±—ä–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }

            const canMarkEntryExit = (userAccessRights === '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä' || userAccessRights === '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä') ||
                isSameInspector(object.inspector, currentUser);

            if (!canMarkEntryExit) {
                showNotification('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –≤—ã—Ö–æ–¥–∞ –Ω–∞ —á—É–∂–æ–π –æ–±—ä–µ–∫—Ç', 'error');
                return;
            }

            performMarkExit(objectId);
        }

        function performMarkEntry(objectId) {
            showNotification('üîÑ –û—Ç–º–µ—á–∞–µ–º –≤—Ö–æ–¥...', 'success');

            const callbackName = 'entryCallback_' + Date.now();

            const cleanupCallback = function () {
                setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                    }
                }, 10000);
            };

            // üî• –ú–ì–ù–û–í–ï–ù–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–ê–†–¢–´ (OPTIMISTIC UI)
            const object = objectsData.find(obj => obj.id == objectId);
            if (object) {
                object.entryTime = new Date().toISOString();
                updateSinglePointOnMapV2(objectId, 'active');
            }

            window[callbackName] = function (result) {
                cleanupCallback();
                if (result.success && result.updated) {
                    showNotification(`‚úÖ –í—Ö–æ–¥ –æ—Ç–º–µ—á–µ–Ω –¥–ª—è —Ç–æ—á–∫–∏ ${objectId}`, 'success');
                } else {
                    showNotification('‚ùå –û—à–∏–±–∫–∞: ' + (result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ—Ç–∏—Ç—å –≤—Ö–æ–¥'), 'error');
                    // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ - –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è? –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º –∫–∞–∫ –µ—Å—Ç—å, –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤—è—Ç—Å—è –ø—Ä–∏ refresh
                }
            };

            const url = `${SCRIPT_URL}?action=entry&objectId=${objectId}&inspector=${encodeURIComponent(currentUser)}&callback=${callbackName}`;
            const script = document.createElement('script');
            script.src = url;
            script.onerror = function () {
                cleanupCallback();
                showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            };
            document.head.appendChild(script);
            cleanupCallback();
        }

        function performMarkExit(objectId) {
            showNotification('üîÑ –û—Ç–º–µ—á–∞–µ–º –≤—ã—Ö–æ–¥...', 'success');

            const callbackName = 'exitCallback_' + Date.now();

            const cleanupCallback = function () {
                setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                    }
                }, 15000);
            };

            // üî• –ú–ì–ù–û–í–ï–ù–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–ê–†–¢–´ (OPTIMISTIC UI)
            const object = objectsData.find(obj => obj.id == objectId);
            if (object) {
                object.exitTime = new Date().toISOString();
                updateSinglePointOnMapV2(objectId, 'completed');
            }

            window[callbackName] = function (result) {
                cleanupCallback();
                console.log('üü° –û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ:', result);

                if (result.success && result.updated) {
                    showNotification(`‚úÖ –í—ã—Ö–æ–¥ –æ—Ç–º–µ—á–µ–Ω –∏ —Ç–æ—á–∫–∞ ${objectId} –≤—ã–ø–æ–ª–Ω–µ–Ω–∞`, 'success');

                    // üî• –ê–í–¢–û–°–ö–†–´–¢–ò–ï –í–´–ü–û–õ–ù–ï–ù–ù–û–ô –¢–û–ß–ö–ò –ß–ï–†–ï–ó 4 –°–ï–ö–£–ù–î–´
                    setTimeout(() => {
                        const showHiddenCheckbox = document.getElementById('showHidden');
                        const showHidden = showHiddenCheckbox ? showHiddenCheckbox.checked : false;

                        // –ï—Å–ª–∏ "–ü–æ–∫–∞–∑–∞—Ç—å —Å–∫—Ä—ã—Ç—ã–µ" –≤—ã–∫–ª—é—á–µ–Ω–æ, —É–¥–∞–ª—è–µ–º —Ç–æ—á–∫—É —Å –∫–∞—Ä—Ç—ã
                        if (!showHidden) {
                            console.log(`üí® –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π —Ç–æ—á–∫–∏ ${objectId}`);

                            try {
                                // –ò—â–µ–º –∏ —É–¥–∞–ª—è–µ–º –∏–∑ objectManager (–æ–±—ã—á–Ω—ã–µ —Ç–æ—á–∫–∏)
                                const toRemove1 = [];
                                objectManager.objects.each(obj => { if (obj.id == objectId) toRemove1.push(obj); });
                                toRemove1.forEach(obj => objectManager.objects.remove(obj));

                                // –ò—â–µ–º –∏ —É–¥–∞–ª—è–µ–º –∏–∑ activeObjectsLayer (–∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ—á–∫–∏)
                                const toRemove2 = [];
                                activeObjectsLayer.objects.each(obj => { if (obj.id == objectId) toRemove2.push(obj); });
                                toRemove2.forEach(obj => activeObjectsLayer.objects.remove(obj));

                            } catch (e) {
                                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–∏ —Ç–æ—á–∫–∏:', e);
                            }
                        }
                    }, 4000); // 4 —Å–µ–∫—É–Ω–¥—ã –∑–∞–¥–µ—Ä–∂–∫–∞

                } else {
                    showNotification('‚ùå –û—à–∏–±–∫–∞: ' + (result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ—Ç–∏—Ç—å –≤—ã—Ö–æ–¥'), 'error');
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ:', result);
                }
            };

            const timestamp = Date.now();
            const random = Math.random().toString(36).substring(7);
            const url = `${SCRIPT_URL}?action=exit&objectId=${objectId}&inspector=${encodeURIComponent(currentUser)}&_=${timestamp}&r=${random}&callback=${callbackName}`;

            console.log('üü° –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã—Ö–æ–¥:', url);
            const script = document.createElement('script');
            script.src = url;
            script.onerror = function () {
                cleanupCallback();
                showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            };
            document.head.appendChild(script);
            cleanupCallback();
        }

        function cancelEntry(objectId) {
            if (!(userAccessRights === '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä' || userAccessRights === '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä')) {
                showNotification('‚ùå –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –æ—Ç–º–µ–Ω—è—Ç—å –≤—Ö–æ–¥', 'error');
                return;
            }

            const object = objectsData.find(obj => obj.id == objectId); // üî• –ò–°–ü–†–ê–í–õ–ï–ù–û: == –≤–º–µ—Å—Ç–æ ===
            if (!object) {
                showNotification('‚ùå –û–±—ä–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }

            if (!object.entryTime || object.exitTime) {
                showNotification('‚ùå –û–±—ä–µ–∫—Ç –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∞–∫—Ç–∏–≤–Ω–æ–º —Å—Ç–∞—Ç—É—Å–µ', 'error');
                return;
            }

            if (!confirm(`–û—Ç–º–µ–Ω–∏—Ç—å –≤—Ö–æ–¥ –Ω–∞ –æ–±—ä–µ–∫—Ç ${objectId}? –û–±—ä–µ–∫—Ç –≤–µ—Ä–Ω–µ—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å "–ù–æ–≤–∞—è".`)) {
                return;
            }

            showNotification('üîÑ –û—Ç–º–µ–Ω—è–µ–º –≤—Ö–æ–¥...', 'success');

            const callbackName = 'cancelEntryCallback_' + Date.now();

            const cleanupCallback = function () {
                setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                    }
                }, 10000);
            };

            // üî• –ú–ì–ù–û–í–ï–ù–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–ê–†–¢–´ (OPTIMISTIC UI)
            // –û–±—ä–µ–∫—Ç —É–∂–µ –Ω–∞–π–¥–µ–Ω –≤—ã—à–µ
            if (object) {
                object.entryTime = '';
                updateSinglePointOnMapV2(objectId, 'new');
            }

            window[callbackName] = function (result) {
                cleanupCallback();
                if (result.success && result.updated) {
                    showNotification(`‚úÖ –í—Ö–æ–¥ –æ—Ç–º–µ–Ω–µ–Ω –¥–ª—è —Ç–æ—á–∫–∏ ${objectId}`, 'success');
                } else {
                    showNotification('‚ùå –û—à–∏–±–∫–∞: ' + (result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –≤—Ö–æ–¥'), 'error');
                }
            };

            const url = `${SCRIPT_URL}?action=cancelEntry&objectId=${objectId}&inspector=${encodeURIComponent(currentUser)}&callback=${callbackName}`;
            const script = document.createElement('script');
            script.src = url;
            script.onerror = function () {
                cleanupCallback();
                showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            };
            document.head.appendChild(script);
            cleanupCallback();
        }

        // üî• –ü–ï–†–ï–†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ò–ù–°–ü–ï–ö–¢–û–†–ê - –£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
        function reassignInspector(objectId, newInspector) {
            if (!(userAccessRights === '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä' || userAccessRights === '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä')) return;
            if (!newInspector) return;

            console.log('üü° –ü–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ:', objectId, '‚Üí', newInspector);

            // üî• –°–†–ê–ó–£ –ó–ê–ö–†–´–í–ê–ï–ú –û–ö–ù–û –î–ï–¢–ê–õ–ï–ô
            try { closeObjectDetails(); } catch (_) { }
            // üî• –ó–ê–ö–†–´–í–ê–ï–ú –°–¢–ê–†–´–ï –Ø–ù–î–ï–ö–° –ë–ê–õ–õ–£–ù–´
            objectManager.objects.balloon.close();
            activeObjectsLayer.objects.balloon.close();

            const callbackName = 'reassignCallback_' + Date.now();

            const cleanupCallback = function () {
                setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                    }
                }, 10000);
            };

            // üî• –ú–ì–ù–û–í–ï–ù–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–ê–†–¢–´ (OPTIMISTIC UI)
            // –ò—â–µ–º —Å –Ω–µ—Å—Ç—Ä–æ–≥–∏–º —Ä–∞–≤–µ–Ω—Å—Ç–≤–æ–º, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –∏ '1' –∏ 1
            const object = objectsData.find(obj => obj.id == objectId);
            if (object) {
                console.log(`‚ö° LOCAL UPDATE: –ú–µ–Ω—è–º –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–∞ –¥–ª—è —Ç–æ—á–∫–∏ ${objectId} —Å ${object.inspector} –Ω–∞ ${newInspector}`);
                object.inspector = newInspector;
                const isActive = object.entryTime && !object.exitTime;
                updateSinglePointOnMapV2(objectId, isActive ? 'active' : 'new');
            } else {
                console.error(`‚ùå LOCAL UPDATE FAILED: –û–±—ä–µ–∫—Ç ${objectId} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ objectsData`);
            }

            // üî• –°–†–ê–ó–£ –ó–ê–ö–†–´–í–ê–ï–ú –û–ö–ù–û –î–ï–¢–ê–õ–ï–ô
            closeObjectDetails();

            window[callbackName] = function (result) {
                cleanupCallback();
                if (result.success) {
                    showNotification(`‚úÖ –¢–æ—á–∫–∞ ${objectId} –ø–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ ${newInspector}`, 'success');

                    // üî• –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –§–ò–õ–¨–¢–†–û–í –ß–ï–†–ï–ó 3 –°–ï–ö–£–ù–î–´
                    setTimeout(() => {
                        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ç–æ—á–∫–∏
                        deselectAllLists();

                        // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Ç–æ—á–∫–∏
                        setTimeout(() => {
                            selectAllLists();
                            updateMap();
                        }, 100);

                        showNotification('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π', 'success');
                    }, 3000);

                } else {
                    showNotification('‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è: ' + result.message, 'error');
                }
            };

            const url = `${SCRIPT_URL}?action=reassign&objectId=${objectId}&newInspector=${encodeURIComponent(newInspector)}&callback=${callbackName}`;
            const script = document.createElement('script');
            script.src = url;

            script.onerror = function () {
                cleanupCallback();
                showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            };

            document.head.appendChild(script);
            cleanupCallback();
        }

        // üî• –†–ê–ë–û–ß–ò–ô –î–ï–ù–¨
        function checkWorkDayStatus() {
            if (userAccessRights === '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä' || userAccessRights === '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä') return;



            const callbackName = 'checkWorkDayCallback_' + Date.now();

            const cleanupCallback = function () {
                setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                    }
                }, 10000);
            };

            window[callbackName] = function (result) {
                cleanupCallback();
                if (result.success) {
                    isWorkDayOpen = !!result.open;
                    workDayStartTimeServer = result.openTime || null;
                    if (isWorkDayOpen) {
                        saveWorkDayStatus(true, workDayStartTimeServer);
                    } else {
                        saveWorkDayStatus(false);
                    }
                    updateWorkDayButtons();
                    showNotification(isWorkDayOpen ? 'üü¢ –†–∞–±–æ—á–∏–π –¥–µ–Ω—å –æ—Ç–∫—Ä—ã—Ç' : 'üî¥ –†–∞–±–æ—á–∏–π –¥–µ–Ω—å –∑–∞–∫—Ä—ã—Ç', 'success');
                }
            };

            const url = `${SCRIPT_URL}?action=checkWorkDay&inspector=${encodeURIComponent(currentUser)}&callback=${callbackName}`;
            const script = document.createElement('script');
            script.src = url;
            script.onerror = function () {
                cleanupCallback();
            };
            document.head.appendChild(script);
            cleanupCallback();
        }



        // üî• –õ–û–ì–ò–ö–ê –†–ê–ë–û–ß–ï–ì–û –î–ù–Ø –ü–ï–†–ï–ù–ï–°–ï–ù–ê –í –ö–û–ù–ï–¶ –§–ê–ô–õ–ê (startWorkDayExecute, endWorkDayExecute –∏ —Ç.–¥.)
        // –°—Ç–∞—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —É–¥–∞–ª–µ–Ω—ã –≤–æ –∏–∑–±–µ–∂–∞–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤.

        // üî• –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–ò–í–ù–´–ï –§–£–ù–ö–¶–ò–ò (–û–ß–ò–©–ï–ù–û –û–¢ –î–£–ë–õ–ò–ö–ê–¢–û–í)
        // –ù–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —ç—Ç–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∏–∂–µ (—Å—Ç—Ä–æ–∫–∏ 5700+)


        function selectColor(inspector, color) {
            updateInspectorConfig(inspector, 'color', color);

            const accordions = document.querySelectorAll('.accordion');
            accordions.forEach(accordion => {
                const header = accordion.querySelector('.accordion-header');
                if (header && header.textContent.includes(inspector)) {
                    const colorOptions = accordion.querySelectorAll('.color-option');
                    colorOptions.forEach(option => {
                        option.classList.remove('selected');
                        if (option.style.backgroundColor === color) {
                            option.classList.add('selected');
                        }
                    });

                    const colorPreview = accordion.querySelector('.color-preview');
                    if (colorPreview) {
                        colorPreview.style.backgroundColor = color;
                    }
                }
            });
            // –õ–∞–π—Ñ‚Äë–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            const live = { color };
            updateInspectorInFilters(inspector, live);
        }

        function updateInspectorConfig(inspector, field, value) {
            console.log(`üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ${field} –¥–ª—è ${inspector}:`, value);

            if (window.INSPECTORS_CONFIG[inspector]) {
                window.INSPECTORS_CONFIG[inspector][field] = value;
            }
            const live = {}; live[field] = value; updateInspectorInFilters(inspector, live);
        }

        function applyInspectorChanges(inspector) {
            // üî• –ü–û–õ–£–ß–ê–ï–ú –ó–ù–ê–ß–ï–ù–ò–Ø –ù–ê–ü–†–Ø–ú–£–Æ –ò–ó –§–û–†–ú–´, –ê –ù–ï –ò–ó –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò
            const statusSelect = document.getElementById(`status_${inspector}`);
            const iconSelect = document.getElementById(`icon_${inspector}`);

            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ü–≤–µ—Ç –∏–∑ window.INSPECTORS_CONFIG (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ updateInspectorConfig)
            const currentConfig = window.INSPECTORS_CONFIG && window.INSPECTORS_CONFIG[inspector]
                ? window.INSPECTORS_CONFIG[inspector]
                : {};
            const currentStyle = getInspectorStyle(inspector);

            // üî• –ü–†–ò–û–†–ò–¢–ï–¢: —Ç–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è > —Å—Ç–∏–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const config = {
                color: currentConfig.color || currentStyle.color,
                icon: iconSelect && iconSelect.value ? iconSelect.value : (currentConfig.icon || currentStyle.icon),
                status: statusSelect && statusSelect.value ? statusSelect.value : (currentConfig.status || currentStyle.status)
            };

            console.log(`üíæ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è ${inspector}:`, config);
            console.log(`üîç –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:`, currentConfig);
            console.log(`üîç –í—ã–±—Ä–∞–Ω–Ω—ã–π —Ü–≤–µ—Ç –∏–∑ —Ñ–æ—Ä–º—ã:`, currentConfig.color);

            // üî• –ï–°–õ–ò –°–¢–ê–¢–£–° –ò–ó–ú–ï–ù–ò–õ–°–Ø –ù–ê –ù–ï–ê–ö–¢–ò–í–ù–´–ô - –ü–ï–†–ï–î–ê–ï–ú –û–ë–™–ï–ö–¢–´ ADMIN
            if (statusSelect && statusSelect.value !== 'active') {
                if (confirm(`–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–∞ ${inspector} –≤ —Å—Ç–∞—Ç—É—Å "${getStatusText(statusSelect.value)}"? –í—Å–µ –µ–≥–æ –æ–±—ä–µ–∫—Ç—ã –±—É–¥—É—Ç –ø–µ—Ä–µ–¥–∞–Ω—ã –ò–º–ø–µ—Ä–∞—Ç–æ—Ä—É.`)) {
                    saveInspectorConfig(inspector, config, true);
                }
            } else {
                // üî• –ú–ì–ù–û–í–ï–ù–ù–û–ï –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –ù–ê –ö–õ–ò–ï–ù–¢–ï
                // –û–±–Ω–æ–≤–ª—è–µ–º window.INSPECTORS_CONFIG —Å—Ä–∞–∑—É
                if (!window.INSPECTORS_CONFIG) window.INSPECTORS_CONFIG = {};
                window.INSPECTORS_CONFIG[inspector] = {
                    ...(window.INSPECTORS_CONFIG[inspector] || {}),
                    color: config.color,
                    icon: config.icon,
                    status: config.status
                };

                // üî• –°–û–•–†–ê–ù–Ø–ï–ú –ò–ó–ú–ï–ù–ï–ù–ò–Ø –ö–ê–ö –ù–ï–î–ê–í–ù–ò–ï
                if (!window.RECENT_INSPECTOR_CHANGES) window.RECENT_INSPECTOR_CHANGES = {};
                window.RECENT_INSPECTOR_CHANGES[inspector] = {
                    config: { color: config.color, icon: config.icon, status: config.status },
                    timestamp: Date.now()
                };

                updateInspectorInFilters(inspector, config);
                updateMap();
                saveInspectorConfig(inspector, config, true);
            }
        }

        function saveInspectorConfig(inspector, config, applyChanges = false) {
            console.log(`üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è ${inspector}:`, config);

            const callbackName = 'saveConfigCallback_' + Date.now();

            const cleanupCallback = function () {
                setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                        console.log('‚úÖ Callback –æ—á–∏—â–µ–Ω');
                    }
                }, 10000);
            };

            window[callbackName] = function (result) {
                console.log('üü° –û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);
                cleanupCallback();

                if (result.success) {
                    console.log(`‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –¥–ª—è ${inspector}`);
                    console.log(`üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞:`, result.saved || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ');

                    // üî• –ò–°–ü–û–õ–¨–ó–£–ï–ú –î–ê–ù–ù–´–ï –° –°–ï–†–í–ï–†–ê, –ï–°–õ–ò –û–ù–ò –ï–°–¢–¨ (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è)
                    const savedConfig = result.saved || config;

                    // üî• –û–ë–ù–û–í–õ–Ø–ï–ú window.INSPECTORS_CONFIG –ù–ï–ú–ï–î–õ–ï–ù–ù–û
                    if (!window.INSPECTORS_CONFIG) window.INSPECTORS_CONFIG = {};
                    window.INSPECTORS_CONFIG[inspector] = {
                        ...(window.INSPECTORS_CONFIG[inspector] || {}),
                        color: savedConfig.color || config.color,
                        icon: savedConfig.icon || config.icon,
                        status: savedConfig.status || config.status
                    };

                    console.log(`üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è ${inspector}:`, window.INSPECTORS_CONFIG[inspector]);

                    // üî• –°–û–•–†–ê–ù–Ø–ï–ú –ò–ó–ú–ï–ù–ï–ù–ò–Ø –ö–ê–ö –ù–ï–î–ê–í–ù–ò–ï, –ß–¢–û–ë–´ –ù–ï –ü–ï–†–ï–ó–ê–ü–ò–°–´–í–ê–¢–¨ –ò–• –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï –î–ê–ù–ù–´–•
                    if (!window.RECENT_INSPECTOR_CHANGES) window.RECENT_INSPECTOR_CHANGES = {};
                    window.RECENT_INSPECTOR_CHANGES[inspector] = {
                        config: { color: savedConfig.color || config.color, icon: savedConfig.icon || config.icon, status: savedConfig.status || config.status },
                        timestamp: Date.now()
                    };

                    // üî• –£–î–ê–õ–Ø–ï–ú –õ–û–ö–ê–õ–¨–ù–´–ô –ö–≠–®, –ß–¢–û–ë–´ –ü–†–ò–û–†–ò–¢–ï–¢ –ë–´–õ –£ –î–ê–ù–ù–´–• –°–ï–†–í–ï–†–ê
                    try {
                        const cache = loadInspectorsCache();
                        delete cache[inspector];
                        saveInspectorsCache(cache);
                    } catch (_) { }

                    if (applyChanges) {
                        // üî• –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ï –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–ô –ö –í–°–ï–ú–£
                        updateInspectorInFilters(inspector, config);

                        // üî• –ï–°–õ–ò –°–¢–ê–¢–£–° –ù–ï –ê–ö–¢–ò–í–ï–ù ‚Äî –ú–ì–ù–û–í–ï–ù–ù–û –ü–ï–†–ï–î–ê–ï–ú –¢–û–ß–ö–ò ADMIN –ù–ê –ö–õ–ò–ï–ù–¢–ï
                        if (config.status && config.status !== 'active') {
                            const transferred = objectsData.filter(o => o.inspector === inspector);
                            transferred.forEach(o => {
                                o.inspector = 'Admin';
                                const isActive = o.entryTime && !o.exitTime;
                                const isCompleted = !!o.exitTime;
                                updateSinglePointOnMap(o.id, isCompleted ? 'completed' : (isActive ? 'active' : 'new'));
                            });
                        }

                        updateMap();

                        // üî• –û–ë–ù–û–í–õ–Ø–ï–ú –î–û–ú–ê–®–ù–ò–ï –¢–û–ß–ö–ò
                        if (showInspectorsHomes) {
                            toggleInspectorsHomes();
                            setTimeout(() => toggleInspectorsHomes(), 200);
                        }
                    }

                    showNotification(
                        result.transferredObjects > 0
                            ? `‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞. –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –æ–±—ä–µ–∫—Ç–æ–≤: ${result.transferredObjects}`
                            : `‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è ${inspector} –ø—Ä–∏–º–µ–Ω–µ–Ω—ã`,
                        'success'
                    );
                    // üî• –ó–ê–ì–†–£–ñ–ê–ï–ú –î–ê–ù–ù–´–ï –° –°–ï–†–í–ï–†–ê, –ß–¢–û–ë–´ –í–°–ï –£–í–ò–î–ï–õ–ò –ò–ó–ú–ï–ù–ï–ù–ò–Ø
                    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É, —á—Ç–æ–±—ã –¥–∞—Ç—å –≤—Ä–µ–º—è Google Sheets –æ–±–Ω–æ–≤–∏—Ç—å—Å—è
                    // üî• –ù–ï –ü–ï–†–ï–ó–ê–ì–†–£–ñ–ê–ï–ú –î–ê–ù–ù–´–ï –ò –ù–ï –ó–ê–ö–†–´–í–ê–ï–ú –ú–ï–ù–Æ (–ü–û –¢–†–ï–ë–û–í–ê–ù–ò–Æ –Æ–ó–ï–†–ê –ú–ì–ù–û–í–ï–ù–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –õ–û–ö–ê–õ–¨–ù–û)
                    // loadData(); 
                    // closeInspectorManagement();

                } else {
                    showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + result.message, 'error');
                }
            };

            // üî• –ü–ï–†–ï–î–ê–ï–ú –û–¢–î–ï–õ–¨–ù–´–ï –ü–ê–†–ê–ú–ï–¢–†–´ –í–ú–ï–°–¢–û –û–ë–™–ï–ö–¢–ê CONFIG
            const url = `${SCRIPT_URL}?action=saveInspectorConfig&inspector=${encodeURIComponent(inspector)}&color=${encodeURIComponent(config.color || '')}&icon=${encodeURIComponent(config.icon || '')}&status=${encodeURIComponent(config.status || 'active')}&callback=${callbackName}`;
            const script = document.createElement('script');
            script.src = url;

            script.onerror = function () {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞');
                showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                cleanupCallback();
            };

            document.head.appendChild(script);
            cleanupCallback();
        }

        function updateInspectorInFilters(inspector, config) {
            const inspectorCheckbox = document.getElementById(`insp_${inspector}`);
            if (inspectorCheckbox) {
                const parent = inspectorCheckbox.parentNode;
                if (config.color) {
                    const colorDot = parent.querySelector('.color-dot');
                    if (colorDot) {
                        colorDot.style.backgroundColor = config.color;
                    }
                }
                if (config.icon) {
                    const iconSpan = parent.querySelector('.inspector-icon');
                    if (iconSpan) {
                        iconSpan.textContent = config.icon;
                    }
                }
            }
        }

        // üî• LEGACY CODE REMOVED


        // üî• –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
        function selectAllInspectors() {
            const inspectorCheckboxes = document.querySelectorAll('#inspectorsList input[type="checkbox"]');
            inspectorCheckboxes.forEach(checkbox => checkbox.checked = true);
            updateFilters();
            saveFilterState();
        }

        function deselectAllInspectors() {
            const inspectorCheckboxes = document.querySelectorAll('#inspectorsList input[type="checkbox"]');
            inspectorCheckboxes.forEach(checkbox => checkbox.checked = false);
            updateFilters();
            saveFilterState();
        }


        function toggleAllInspectors(checked) {
            const inspectorCheckboxes = document.querySelectorAll('#inspectorsList input[type="checkbox"]');
            inspectorCheckboxes.forEach(checkbox => {
                // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–∏–ª—å—Ç—Ä –ø–æ–∏—Å–∫–∞, –º–æ–∂–Ω–æ –≤—ã–±–∏—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ, –Ω–æ –ø–æ–∫–∞ –≤—ã–±–∏—Ä–∞–µ–º –≤—Å–µ—Ö, –∫–∞–∫ –±—ã–ª–æ
                checkbox.checked = checked;
            });
            updateFilters();
            saveFilterState();
            updateMasterCheckboxes();
        }

        function toggleAllLists(checked) {
            const listCheckboxes = document.querySelectorAll('#listsList input[type="checkbox"]');
            listCheckboxes.forEach(checkbox => checkbox.checked = checked);
            updateFilters();
            saveFilterState();
            updateMasterCheckboxes();
        }

        function updateMasterCheckboxes() {
            // –ò–Ω—Å–ø–µ–∫—Ç–æ—Ä—ã
            const inspectorCheckboxes = Array.from(document.querySelectorAll('#inspectorsList input[type="checkbox"]'));
            const masterInsp = document.getElementById('selectAllInspectors');
            if (masterInsp && inspectorCheckboxes.length > 0) {
                const allChecked = inspectorCheckboxes.every(cb => cb.checked);
                masterInsp.checked = allChecked;
                // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å indeterminate, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                const anyChecked = inspectorCheckboxes.some(cb => cb.checked);
                masterInsp.indeterminate = anyChecked && !allChecked;
            }

            // –°–ø–∏—Å–∫–∏
            const listCheckboxes = Array.from(document.querySelectorAll('#listsList input[type="checkbox"]'));
            const masterList = document.getElementById('selectAllLists');
            if (masterList && listCheckboxes.length > 0) {
                const allChecked = listCheckboxes.every(cb => cb.checked);
                masterList.checked = allChecked;
                const anyChecked = listCheckboxes.some(cb => cb.checked);
                masterList.indeterminate = anyChecked && !allChecked;
            }
        }

        function filterInspectorsList() {
            const searchText = document.getElementById('searchInspectors').value.toLowerCase();
            const inspectorItems = document.querySelectorAll('#inspectorsList .checkbox-item');

            inspectorItems.forEach(item => {
                const label = item.querySelector('label');
                const inspectorName = label.textContent.toLowerCase();
                if (inspectorName.includes(searchText)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function onInspectorChange() {
            updateFilters();
            saveFilterState();
            updateListCounters();
            updateMasterCheckboxes();
        }

        function onListChange() {
            updateFilters();
            saveFilterState();
            updateMasterCheckboxes();
        }

        function updateFilters() {
            updateMap();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));

            document.querySelector(`.tab-button[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');

            if (tabName === 'objects') {
                updateObjectsList();
            }
        }

        function updateObjectsList() {
            const objectsListContent = document.getElementById('objectsListContent');
            const searchText = document.getElementById('searchListInput').value.toLowerCase();
            const filteredObjects = getFilteredObjects().filter(obj => {
                if (!searchText) return true;

                return obj.id.toString().toLowerCase().includes(searchText) ||
                    obj.address.toLowerCase().includes(searchText);
            });

            if (filteredObjects.length === 0) {
                objectsListContent.innerHTML = '<div class="loading">–ù–µ—Ç –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>';
                return;
            }

            objectsListContent.innerHTML = '';

            filteredObjects.forEach(obj => {
                const style = getInspectorStyle(obj.inspector);

                const isNew = !obj.entryTime && !obj.exitTime;
                const isActive = obj.entryTime && !obj.exitTime;
                const isCompleted = !!obj.exitTime;

                let statusClass = 'status-new';
                let statusText = 'üÜï';
                if (isCompleted) {
                    statusClass = 'status-completed';
                    statusText = '‚úÖ';
                } else if (isActive) {
                    statusClass = 'status-active';
                    statusText = 'üîµ';
                }

                const objectItem = document.createElement('div');
                objectItem.className = 'object-item';
                objectItem.onclick = () => {
                    map.setCenter([parseFloat(obj.latitude), parseFloat(obj.longitude)], 17);
                    showObjectBalloon(obj.id);
                };

                objectItem.innerHTML = `
                    <div style="flex: 1;">
                        <div class="object-id">${obj.id}</div>
                        <div class="object-address">${obj.address}</div>
                        <div class="object-inspector">${obj.inspector || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω'}</div>
                    </div>
                    <span class="object-status ${statusClass}">
                        ${statusText}
                    </span>
                `;
                objectsListContent.appendChild(objectItem);
            });
        }



        function showLoading(message) {
            document.getElementById('inspectorsList').innerHTML = `<div class="loading">${message}</div>`;
            document.getElementById('listsList').innerHTML = `<div class="loading">${message}</div>`;
        }

        function showError(message) {
            document.getElementById('inspectorsList').innerHTML = `<div class="error">${message}</div>`;
            document.getElementById('listsList').innerHTML = `<div class="error">${message}</div>`;
        }

        function showNotification(message, type = 'success') {
            let container = document.querySelector('.notification-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'notification-container';
                document.body.appendChild(container);
            }

            // Strict Icon Mapping
            let icon = '‚ö†Ô∏è'; // Default warning
            if (type === 'success' || message.includes('–æ—Ç–∫—Ä—ã—Ç') || message.includes('–ø—Ä–∏–Ω—è—Ç—ã')) icon = '‚úÖ';
            if (type === 'error' || message.includes('–∑–∞–∫—Ä—ã—Ç') || message.includes('–æ—à–∏–±–∫–∞')) icon = '‚ùå';

            // üî• STRIP EXISTING EMOJIS FROM MESSAGE
            let cleanMessage = message
                .replace(/‚úÖ/g, '')
                .replace(/‚ùå/g, '')
                .replace(/‚ö†Ô∏è/g, '')
                .replace(/üü¢/g, '')
                .replace(/üî¥/g, '')
                .replace(/‚ÑπÔ∏è/g, '')
                .replace(/üè∞/g, '')
                .replace(/üè†/g, '')
                .trim();

            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <div class="notification-icon">${icon}</div>
                <div>${cleanMessage}</div>
            `;

            // Swipe Logic
            let startY = 0;
            let currentY = 0;
            let isDragging = false;

            notification.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
                isDragging = true;
                notification.style.transition = 'none';
            }, { passive: true });

            notification.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                currentY = e.touches[0].clientY;
                const diff = currentY - startY;
                if (diff < 0) { // Only swipe UP
                    notification.style.transform = `translateY(${diff}px)`;
                }
            }, { passive: true });

            notification.addEventListener('touchend', (e) => {
                isDragging = false;
                notification.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
                const diff = currentY - startY;
                if (diff < -30) { // Swipe Up Threshold
                    notification.classList.add('swipe-out');
                    setTimeout(() => notification.remove(), 300);
                } else {
                    notification.style.transform = '';
                }
            }, { passive: true });

            container.appendChild(notification);

            // Auto Remove
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.classList.add('swipe-out');
                    setTimeout(() => notification.remove(), 300);
                }
            }, 4000);
        }

        // üî• –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô –î–õ–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –°–ï–°–°–ò–ò
        document.addEventListener('click', function () {
            if (currentUser) {
                saveSession();
            }
        });

        document.addEventListener('visibilitychange', function () {
            if (!document.hidden && currentUser) {
                saveSession();
                try { loadData(); } catch (_) { }
            }
        });

        // üî• –ó–ê–ö–†–´–¢–ò–ï –ú–ï–ù–Æ –ü–û –ö–õ–ò–ö–£ –ù–ê –ö–ê–†–¢–£
        document.getElementById('map').addEventListener('click', function (e) {
            if (activeMenu && e.target.closest('.inspector-management-menu') === null) {
                closeAllMenus();
            }
        });

        // üî• –£–õ–£–ß–®–ï–ù–ù–û–ï –¢–û–ß–ï–ß–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–ê–†–¢–´ V2 (SMART UPDATE)
        function updateSinglePointOnMapV2(objectId, newStatus) {
            const object = objectsData.find(obj => obj.id == objectId);
            if (!object) return;

            console.log(`üîÑ V2: –¢–æ—á–µ—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ—á–∫–∏ ${objectId} -> ${newStatus}`);

            // üî• –°–ú–ê–†–¢-–û–ë–ù–û–í–õ–ï–ù–ò–ï - –í–ú–ï–°–¢–û –£–î–ê–õ–ï–ù–ò–Ø –ü–´–¢–ê–ï–ú–°–Ø –û–ë–ù–û–í–ò–¢–¨ (–ö–ê–ö –í updateMap)
            let targetLayer = null;
            let currentLayer = null;
            let existingObject = null;

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–µ–ª–µ–≤–æ–π —Å–ª–æ–π
            if (newStatus === 'active') targetLayer = activeObjectsLayer;
            else targetLayer = objectManager;

            // –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –æ–±—ä–µ–∫—Ç
            // –ü—Ä–æ–±—É–µ–º –∫–∞–∫ —Å—Ç—Ä–æ–∫—É –∏ –∫–∞–∫ —á–∏—Å–ª–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
            const idAsNum = Number(objectId);
            const searchIds = [objectId, String(objectId)];
            if (!isNaN(idAsNum)) searchIds.push(idAsNum);

            // –ò—â–µ–º –≤ –æ–±—ã—á–Ω–æ–º —Å–ª–æ–µ
            for (let id of searchIds) {
                if (objectManager.objects.getById(id)) {
                    existingObject = objectManager.objects.getById(id);
                    currentLayer = objectManager;
                    break;
                }
            }
            // –ò—â–µ–º –≤ –∞–∫—Ç–∏–≤–Ω–æ–º —Å–ª–æ–µ (–µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏)
            if (!existingObject) {
                for (let id of searchIds) {
                    if (activeObjectsLayer.objects.getById(id)) {
                        existingObject = activeObjectsLayer.objects.getById(id);
                        currentLayer = activeObjectsLayer;
                        break;
                    }
                }
            }

            const style = getInspectorStyle(object.inspector);
            console.log(`üé® –°—Ç–∏–ª—å –¥–ª—è –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–∞ ${object.inspector}: color=${style.color}, icon=${style.icon}`);

            // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ñ–∏—á–∏
            let preset = 'islands#dotIcon';
            let iconContent = undefined;
            let iconColor = style.color;
            let iconSize = [30, 30];

            if (newStatus === 'active') {
                preset = 'islands#circleIcon';
                iconSize = [50, 50];
            } else if (newStatus === 'completed') {
                preset = 'islands#greenMedicalIcon';
                iconContent = undefined;
            } else { // new
                const isImperial = object.inspector === 'Admin' ||
                    (window.INSPECTORS_CONFIG[object.inspector] &&
                        window.INSPECTORS_CONFIG[object.inspector].accessRights === '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä');
                if (isImperial) preset = 'islands#blueStarIcon';
            }

            const properties = {
                hintContent: getHintContent(object), // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å getHintContent
                balloonContent: getBalloonContent(object, style.icon),
                inspector: object.inspector,
                list: object.list,
                address: object.address,
                checklistLink: object.checklistLink,
                yandexDiskLink: object.yandexDiskLink,
                iconContent: iconContent
            };

            const options = {
                preset: preset,
                iconColor: iconColor,
                iconSize: iconSize
            };

            // –õ–û–ì–ò–ö–ê –û–ë–ù–û–í–õ–ï–ù–ò–Ø
            if (existingObject && currentLayer === targetLayer) {
                // –°–ª–æ–π —Ç–æ—Ç –∂–µ - –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                console.log(`‚ú® Smart Update: –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–π—Å—Ç–≤–∞ –æ–±—ä–µ–∫—Ç–∞ ${objectId} –≤ —Ç–µ–∫—É—â–µ–º —Å–ª–æ–µ`);
                try {
                    currentLayer.objects.setObjectProperties(existingObject.id, properties);
                    currentLayer.objects.setObjectOptions(existingObject.id, options);

                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤ –æ–±—ä–µ–∫—Ç–∞:', e);
                }
            } else {
                // –°–ª–æ—è –Ω–µ—Ç –∏–ª–∏ –æ–Ω –∏–∑–º–µ–Ω–∏–ª—Å—è (–±—ã–ª –∞–∫—Ç–∏–≤–Ω—ã–π -> —Å—Ç–∞–ª –æ–±—ã—á–Ω—ã–π –∏–ª–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç) - –ü–ï–†–ï–°–û–ó–î–ê–ï–ú
                console.log(`‚ú® Smart Update: –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ ${objectId} (—Å–º–µ–Ω–∞ —Å–ª–æ—è –∏–ª–∏ –Ω–æ–≤—ã–π)`);

                // –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –µ—Å–ª–∏ –±—ã–ª
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–¥–µ–∂–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
                if (existingObject && currentLayer) {
                    try { currentLayer.objects.remove(existingObject); } catch (_) { }
                }
                // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –∂–µ—Å—Ç–∫–∞—è —á–∏—Å—Ç–∫–∞ –ø–æ –≤—Å–µ–º ID
                // –°—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ —É–¥–∞–ª–µ–Ω–∏—è (just in case)
                try {
                    const removeResult1 = [];
                    const targetId = objectId;
                    objectManager.objects.each(function (obj) { if (obj.id == targetId) removeResult1.push(obj); });
                    removeResult1.forEach(obj => objectManager.objects.remove(obj));

                    const removeResult2 = [];
                    activeObjectsLayer.objects.each(function (obj) { if (obj.id == targetId) removeResult2.push(obj); });
                    removeResult2.forEach(obj => activeObjectsLayer.objects.remove(obj));
                } catch (_) { }

                const feature = {
                    type: 'Feature',
                    id: object.id,
                    geometry: {
                        type: 'Point',
                        coordinates: [parseFloat(object.latitude), parseFloat(object.longitude)]
                    },
                    properties: properties,
                    options: options
                };

                targetLayer.add({ type: 'FeatureCollection', features: [feature] });
            }

            console.log('‚úÖ –¢–æ—á–µ—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ:', objectId, newStatus);

            // üî• –û–ë–ù–û–í–õ–Ø–ï–ú –ë–ê–õ–õ–£–ù/–û–í–ï–†–õ–ï–ô –ï–°–õ–ò –û–ù –û–¢–ö–†–´–¢
            setTimeout(() => {
                // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π –æ–≤–µ—Ä–ª–µ–π
                if (window.CURRENT_OPEN_OBJECT_ID && window.CURRENT_OPEN_OBJECT_ID == objectId) {
                    const overlay = document.getElementById('objectDetailsOverlay');
                    if (overlay && overlay.classList.contains('object-details--visible')) {
                        renderObjectDetails(object);
                    }
                }

                // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –±–∞–ª—É–Ω –Ø–Ω–¥–µ–∫—Å–∞
                try {
                    const activeBalloon = objectManager.objects.balloon.getData() || (activeObjectsLayer && activeObjectsLayer.objects.balloon.getData());
                    if (activeBalloon && activeBalloon.feature && activeBalloon.feature.id == objectId) {
                        showObjectBalloon(objectId);
                    }
                } catch (e) { }
            }, 50);
        }
    </script>
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            try { updateWorkDayButtons(); } catch (e) { }
        });
    </script>
    <script>
        // üî• –ú–û–ë–ò–õ–¨–ù–û–ï –°–í–ê–ô–ü-–ú–ï–ù–Æ
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const handle = document.getElementById('mobileSidebarHandle');

            if (!sidebar) return;

            const isOpen = sidebar.classList.contains('mobile-open');

            if (isOpen) {
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º
                sidebar.classList.remove('mobile-open');
                if (handle) {
                    handle.classList.remove('hidden');
                }
            } else {
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º
                sidebar.classList.add('mobile-open');
                if (handle) {
                    handle.classList.add('hidden');
                }
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∂–µ—Å—Ç–æ–≤
        document.addEventListener('DOMContentLoaded', function () {
            const sidebar = document.getElementById('sidebar');
            let touchStartX = 0;
            let touchEndX = 0;
            let touchStartY = 0;
            let touchEndY = 0;
            let shouldIgnoreSwipe = false;

            function debugLog(msg) {
                console.log('[SWIPE DEBUG]', msg);
            }

            // üî• –ò–°–ü–û–õ–¨–ó–£–ï–ú CAPTURE: TRUE, –ß–¢–û–ë–´ –ü–ï–†–ï–•–í–ê–¢–ò–¢–¨ –°–û–ë–´–¢–ò–Ø –î–û –ö–ê–†–¢–´
            document.addEventListener('touchstart', e => {
                shouldIgnoreSwipe = false;
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å–≤–∞–π–ø, –µ—Å–ª–∏ —Ç—Ä–æ–≥–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å
                if (e.target && e.target.closest && e.target.closest('.workday-iphone-slider')) {
                    shouldIgnoreSwipe = true;
                }

                // üî• –ò–ì–ù–û–†–ò–†–£–ï–ú –ì–õ–û–ë–ê–õ–¨–ù–´–ô –°–í–ê–ô–ü, –ï–°–õ–ò –û–¢–ö–†–´–¢–û –ú–ï–ù–Æ –£–ü–†–ê–í–õ–ï–ù–ò–Ø
                const mgmtMenu = document.getElementById('inspectorManagementMenu');
                if (mgmtMenu && mgmtMenu.classList.contains('active')) {
                    // –ï—Å–ª–∏ —Å–≤–∞–π–ø –≤–Ω—É—Ç—Ä–∏ –º–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è - —Ç–æ –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å–≤–∞–π–ø (—Å–∞–π–¥–±–∞—Ä–∞) –Ω–∞–º –Ω–µ –Ω—É–∂–µ–Ω
                    shouldIgnoreSwipe = true;
                }

                // üî• –ò–ì–ù–û–†–ò–†–£–ï–ú –ì–õ–û–ë–ê–õ–¨–ù–´–ô –°–í–ê–ô–ü, –ï–°–õ–ò –û–¢–ö–†–´–¢ –°–ü–ò–°–û–ö –û–ë–™–ï–ö–¢–û–í
                const addObjDrawer = document.getElementById('addObjectDrawer');
                if (addObjDrawer && addObjDrawer.classList.contains('active')) {
                    shouldIgnoreSwipe = true;
                }

                if (e.changedTouches && e.changedTouches.length > 0) {
                    touchStartX = e.changedTouches[0].clientX;
                    touchStartY = e.changedTouches[0].clientY;
                    // debugLog(`Start: ${touchStartX}, ${touchStartY}`);
                }
            }, { capture: true, passive: true });

            document.addEventListener('touchend', e => {
                if (shouldIgnoreSwipe) return;

                if (e.changedTouches && e.changedTouches.length > 0) {
                    touchEndX = e.changedTouches[0].clientX;
                    touchEndY = e.changedTouches[0].clientY;

                    // debugLog(`End: ${touchEndX}, ${touchEndY}`);
                    handleSwipe();
                }
            }, { capture: true, passive: true });

            function handleSwipe() {
                if (!sidebar) return;

                const swipeX = touchEndX - touchStartX;
                const swipeY = touchEndY - touchStartY;
                const isOpen = sidebar.classList.contains('mobile-open');

                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–∏–ª—å–Ω—ã–π –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª
                if (Math.abs(swipeY) > Math.abs(swipeX) + 50) { // –ß—É—Ç—å —É–≤–µ–ª–∏—á–∏–ª–∏ –¥–æ–ø—É—Å–∫
                    return;
                }

                // –°–≤–∞–π–ø –í–ü–†–ê–í–û (–û—Ç–∫—Ä—ã—Ç–∏–µ)
                // - –£–≤–µ–ª–∏—á–∏–ª–∏ –∑–æ–Ω—É —Å—Ç–∞—Ä—Ç–∞ –¥–æ 80px (—É–¥–æ–±–Ω–µ–µ —Å —á–µ—Ö–æ–º)
                // - –î–ª–∏–Ω–∞ —Å–≤–∞–π–ø–∞ > 40px (—á—É—Ç—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–µ–µ)
                if (!isOpen && swipeX > 40 && touchStartX < 80) {
                    toggleMobileSidebar();
                }

                // –°–≤–∞–π–ø –í–õ–ï–í–û (–ó–∞–∫—Ä—ã—Ç–∏–µ)
                if (isOpen && swipeX < -40) {
                    toggleMobileSidebar();
                }
            }
        });

        // üî• –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –†–ê–ë–û–ß–ï–ì–û –î–ù–Ø –° –ú–û–î–ê–õ–¨–ù–´–ú –û–ö–ù–û–ú

        let pendingWorkDayAction = null;

        function openWorkDayApproval(type) {
            pendingWorkDayAction = type;
            const overlay = document.getElementById('workDayApprovalOverlay');
            const content = document.getElementById('workDayApprovalContent');
            if (!overlay || !content) return;

            // –°–∞–π–¥–±–∞—Ä –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ–º, —á—Ç–æ–±—ã –µ–≥–æ –±—ã–ª–æ –≤–∏–¥–Ω–æ (–ø–æ –ø—Ä–æ—Å—å–±–µ —é–∑–µ—Ä–∞)
            // try {
            //     const sidebar = document.getElementById('sidebar');
            //     if (checkMobileDevice() && sidebar && sidebar.classList.contains('mobile-open')) {
            //         toggleMobileSidebar();
            //     }
            // } catch (_) { }

            const title = type === 'start' ? '–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è' : '–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è';
            const now = new Date();
            const time = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

            content.innerHTML = `
                <div style="font-weight:700; font-size:1rem; color:#2c3e50;">${title}</div>
                <div style="color:#555;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <b>${currentUser}</b></div>
                <div style="color:#555;">–í—Ä–µ–º—è: ${time}</div>
                <textarea id="workDayComment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" style="width:100%; min-height:80px; border:1px solid #dfe6e9; border-radius:8px; padding:8px; font-family:inherit; resize:vertical;"></textarea>
                <div class="workday-actions">
                    <button class="btn btn-primary" onclick="confirmWorkDayApproval()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                    <button class="btn btn-secondary" onclick="closeWorkDayApproval(true)">–û—Ç–º–µ–Ω–∞</button>
                </div>
            `;
            overlay.classList.remove('hidden');
        }

        function closeWorkDayApproval(isCancelled = false) {
            const overlay = document.getElementById('workDayApprovalOverlay');
            if (overlay) overlay.classList.add('hidden');
            pendingWorkDayAction = null;
            // –ï—Å–ª–∏ –æ—Ç–º–µ–Ω–∏–ª–∏ - –≤–µ—Ä–Ω–µ–º –ø–æ–ª–∑—É–Ω–æ–∫ –Ω–∞ –º–µ—Å—Ç–æ
            if (isCancelled) {
                updateWorkDayButtons();
            }
        }

        function confirmWorkDayApproval() {
            const comment = document.getElementById('workDayComment')?.value || '';
            const action = pendingWorkDayAction;
            closeWorkDayApproval(false);

            if (action === 'start') {
                startWorkDayExecute(comment);
            } else if (action === 'end') {
                endWorkDayExecute(comment);
            }
        }

        // –ü–ï–†–ï–û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –°–¢–ê–†–´–• –§–£–ù–ö–¶–ò–ô

        function startWorkDay() {
            if (userAccessRights === '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä' || userAccessRights === '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä') {
                showNotification('‚ùå –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–µ –º–æ–∂–µ—Ç –æ—Ç–∫—Ä—ã–≤–∞—Ç—å —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å', 'error');
                return;
            }

            if (isWorkDayOpen) {
                showNotification('‚ÑπÔ∏è –†–∞–±–æ—á–∏–π –¥–µ–Ω—å —É–∂–µ –æ—Ç–∫—Ä—ã—Ç', 'success');
                return;
            }

            openWorkDayApproval('start');
        }

        function endWorkDay() {
            if (userAccessRights === '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä' || userAccessRights === '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä') {
                showNotification('‚ùå –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–µ –º–æ–∂–µ—Ç –∑–∞–∫—Ä—ã–≤–∞—Ç—å —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å', 'error');
                return;
            }

            if (!isWorkDayOpen) {
                showNotification('‚ÑπÔ∏è –†–∞–±–æ—á–∏–π –¥–µ–Ω—å —É–∂–µ –∑–∞–∫—Ä—ã—Ç', 'success');
                return;
            }
            openWorkDayApproval('end');
        }

        // üî• –û–ü–¢–ò–ú–ò–°–¢–ò–ß–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê (–ú–ì–ù–û–í–ï–ù–ù–û)
        function setWorkDayStateOptimistic(targetOpen, startTime = null) {
            isWorkDayOpen = targetOpen;
            saveWorkDayStatus(targetOpen, startTime);
            updateWorkDayButtons();
        }

        // –û–¢–ö–ê–¢ (–ï–°–õ–ò –û–®–ò–ë–ö–ê)
        function revertWorkDayState(previousOpen, message) {
            isWorkDayOpen = previousOpen;
            saveWorkDayStatus(previousOpen);
            updateWorkDayButtons();
            showNotification(`‚ö†Ô∏è –û—à–∏–±–∫–∞ (–æ—Ç–∫–∞—Ç): ${message}`, 'error');
        }

        function startWorkDayExecute(comment) {
            const previousState = isWorkDayOpen;
            if (previousState) return;

            // 1. –ú–ì–ù–û–í–ï–ù–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï UI
            const startTime = new Date().toISOString();
            setWorkDayStateOptimistic(true, startTime);
            showNotification('üü¢ –†–∞–±–æ—á–∏–π –¥–µ–Ω—å –æ—Ç–∫—Ä—ã—Ç', 'success');

            if (!navigator.geolocation) {
                revertWorkDayState(previousState, '–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                return;
            }

            // 2. –§–û–ù–û–í–ê–Ø –û–¢–ü–†–ê–í–ö–ê
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const latRounded = Number(position.coords.latitude).toFixed(4);
                    const lonRounded = Number(position.coords.longitude).toFixed(4);
                    const coords = `${latRounded}, ${lonRounded}`;

                    const callbackName = 'startWorkDayCallback_' + Date.now();
                    window[callbackName] = function (result) {
                        delete window[callbackName];
                        if (!result.success) {
                            revertWorkDayState(previousState, result.message);
                        } else {
                            console.log('‚úÖ Server confirmed Start');
                        }
                    };

                    const parts = String(coords).split(',');
                    const lat = (parts[0] || '').trim();
                    const lon = (parts[1] || '').trim();
                    const url = `${SCRIPT_URL}?action=startWorkDay&inspector=${encodeURIComponent(currentUser)}&coords=${encodeURIComponent(coords)}&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&open_coordinates=${encodeURIComponent(coords)}&open_comment=${encodeURIComponent(comment)}&time=${encodeURIComponent(startTime)}&note=open&callback=${callbackName}`;

                    const script = document.createElement('script');
                    script.src = url;
                    script.onerror = function () {
                        delete window[callbackName];
                        revertWorkDayState(previousState, '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                    };
                    document.head.appendChild(script);
                },
                (error) => {
                    revertWorkDayState(previousState, '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã');
                },
                { enableHighAccuracy: true, timeout: 20000, maximumAge: 60000 }
            );
        }

        function endWorkDayExecute(comment) {
            const previousState = isWorkDayOpen;
            if (!previousState) return;

            // 1. –ú–ì–ù–û–í–ï–ù–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï UI
            setWorkDayStateOptimistic(false);
            showNotification('üî¥ –†–∞–±–æ—á–∏–π –¥–µ–Ω—å –∑–∞–∫—Ä—ã—Ç', 'success');

            if (!navigator.geolocation) {
                revertWorkDayState(previousState, '–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                return;
            }

            // 2. –§–û–ù–û–í–ê–Ø –û–¢–ü–†–ê–í–ö–ê
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const latRounded = Number(position.coords.latitude).toFixed(4);
                    const lonRounded = Number(position.coords.longitude).toFixed(4);
                    const coords = `${latRounded}, ${lonRounded}`;

                    const callbackName = 'endWorkDayCallback_' + Date.now();
                    window[callbackName] = function (result) {
                        delete window[callbackName];
                        if (!result.success) {
                            revertWorkDayState(previousState, result.message);
                        } else {
                            console.log('‚úÖ Server confirmed End');
                        }
                    };

                    const parts = String(coords).split(',');
                    const lat = (parts[0] || '').trim();
                    const lon = (parts[1] || '').trim();
                    const url = `${SCRIPT_URL}?action=endWorkDay&inspector=${encodeURIComponent(currentUser)}&coords=${encodeURIComponent(coords)}&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&close_coordinates=${encodeURIComponent(coords)}&close_comment=${encodeURIComponent(comment)}&time=${encodeURIComponent(new Date().toISOString())}&note=close&callback=${callbackName}`;

                    const script = document.createElement('script');
                    script.src = url;
                    script.onerror = function () {
                        delete window[callbackName];
                        revertWorkDayState(previousState, '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                    };
                    document.head.appendChild(script);
                },
                (error) => {
                    revertWorkDayState(previousState, '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã');
                },
                { enableHighAccuracy: true, timeout: 20000, maximumAge: 60000 }
            );
        }

        // –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ö–ù–û–ü–û–ö
        // üî• –ú–ï–ù–ï–î–ñ–ï–† –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ò–ù–°–ü–ï–ö–¢–û–†–ê–ú–ò (Admin Mode)
        activeMenu = null;
        window.inspectorHandlers = {};
        window.PENDING_INSPECTOR_CHANGES = {};

        // Default Constants
        availableIcons = {
            'üë§': '–ò–Ω—Å–ø–µ–∫—Ç–æ—Ä',
            'üëÆ': '–û—Ñ–∏—Ü–µ—Ä',
            'üë∑': '–†–∞–±–æ—á–∏–π',
            'üë®‚Äçüíº': '–ú–µ–Ω–µ–¥–∂–µ—Ä',
            'üöú': '–í–æ–¥–∏—Ç–µ–ª—å',
            'üöõ': '–ì—Ä—É–∑–æ–≤–∏–∫',
            '‚ú®': '–ó–≤–µ–∑–¥–∞',
            '‚≠ê': '–ó–≤–µ–∑–¥–∞ 2',
            'üü¢': '–ó–µ–ª–µ–Ω—ã–π –∫—Ä—É–≥',
            'üî¥': '–ö—Ä–∞—Å–Ω—ã–π –∫—Ä—É–≥'
        };

        availableColors = [
            '#e74c3c', '#27ae60', '#3498db', '#f39c12', '#9b59b6', '#95a5a6',
            '#1abc9c', '#2ecc71', '#34495e', '#16a085', '#2980b9', '#8e44ad',
            '#2c3e50', '#f1c40f', '#e67e22', '#d35400', '#c0392b', '#bdc3c7', '#7f8c8d'
        ];

        function toggleInspectorsManagement() {
            const menu = document.getElementById('inspectorManagementMenu');
            if (!menu) return;

            if (menu.classList.contains('active')) {
                menu.classList.remove('active');
                activeMenu = null;
            } else {
                if (window.closeAllMenus) window.closeAllMenus();
                menu.classList.add('active');
                activeMenu = 'management';
                updateInspectorManagementContent();
            }
        }

        // üî• –ü–û–õ–£–ß–ï–ù–ò–ï –°–¢–ò–õ–Ø –ò–ù–°–ü–ï–ö–¢–û–†–ê
        function getInspectorStyle(inspectorName) {
            let style = { color: '#808080', icon: 'üë§', status: 'active' };
            if (window.INSPECTORS_CONFIG && window.INSPECTORS_CONFIG[inspectorName]) {
                style = Object.assign({}, style, window.INSPECTORS_CONFIG[inspectorName]);
            }
            return style;
        }

        function filterManagementInspectors() {
            const input = document.getElementById('searchManagement');
            const filter = input ? input.value.toUpperCase() : '';
            const content = document.getElementById('inspectorManagementContent');
            if (!content) return;
            const accordions = content.getElementsByClassName('accordion');

            for (let i = 0; i < accordions.length; i++) {
                const header = accordions[i].querySelector('.accordion-header');
                const title = header ? header.textContent || header.innerText : "";
                if (title.toUpperCase().indexOf(filter) > -1) {
                    accordions[i].style.display = "";
                } else {
                    accordions[i].style.display = "none";
                }
            }
        }

        function updateInspectorManagementContent() {
            const managementContent = document.getElementById('inspectorManagementContent');
            if (!managementContent) return;

            managementContent.innerHTML = '';
            window.inspectorHandlers = {}; // Clear old handlers

            const inspectors = Object.keys(window.INSPECTORS_CONFIG || {});

            const unavailableInspectors = [];
            const activeInspectors = [];

            inspectors.forEach(inspector => {
                const style = getInspectorStyle(inspector);
                if (style.status === 'vacation' || style.status === 'sick') {
                    unavailableInspectors.push(inspector);
                } else {
                    activeInspectors.push(inspector);
                }
            });

            // Helper to render accordion item
            const renderInspectorItem = (inspector, index) => {
                const style = getInspectorStyle(inspector);
                const inspId = (inspector || '').replace(/[^a-zA-Z0-9_-]/g, '_');
                const handlerId = `h_${index}_${inspId}`; // Unique ID
                window.inspectorHandlers[handlerId] = inspector;

                let statusIcon = '';
                if (style.status === 'active') statusIcon = 'üü¢';
                else if (style.status === 'vacation') statusIcon = 'üèñÔ∏è';
                else if (style.status === 'sick') statusIcon = 'ü§í';

                return `
                    <div class="accordion">
                        <div class="accordion-header" onclick="toggleAccordion(this)">
                            <div class="accordion-title">
                                ${style.icon} ${inspector}
                            </div>
                            <div class="accordion-meta">
                                <span class="status-icon-header">${statusIcon}</span>
                                <span>‚ñº</span>
                            </div>
                        </div>
                        <div class="accordion-content">
                            <div class="management-tabs">
                                <button class="tab-btn" onclick="showManagementTab('${handlerId}','status')">–°—Ç–∞—Ç—É—Å</button>
                                <button class="tab-btn" onclick="showManagementTab('${handlerId}','color')">–¶–≤–µ—Ç</button>
                                <button class="tab-btn" onclick="showManagementTab('${handlerId}','icon')">–ò–∫–æ–Ω–∫–∞</button>
                            </div>
                            <div class="tab-section" id="tab_${handlerId}_status">${createStatusSection(inspector, style, handlerId)}</div>
                            <div class="tab-section hidden" id="tab_${handlerId}_color">${createColorSection(inspector, style, handlerId)}</div>
                            <div class="tab-section hidden" id="tab_${handlerId}_icon">${createIconSection(inspector, style, handlerId)}</div>

                            <button class="apply-changes-btn hidden" id="applyBtn_${handlerId}" onclick="applyInspectorChanges(window.inspectorHandlers['${handlerId}'])">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                        </div>
                    </div>
                `;
            };

            // Render Unavailable Section
            if (unavailableInspectors.length > 0) {
                const unavailableSection = document.createElement('div');
                unavailableSection.className = 'management-group';
                unavailableSection.innerHTML = `<div class="management-group-title">üå¥ –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ</div>`;
                unavailableInspectors.forEach((inspector, i) => {
                    unavailableSection.innerHTML += renderInspectorItem(inspector, 'u' + i);
                });
                managementContent.appendChild(unavailableSection);
            }

            // Render Active Section
            const activeSection = document.createElement('div');
            activeSection.className = 'management-group';
            activeSection.innerHTML = `<div class="management-group-title">‚ö° –ê–∫—Ç–∏–≤–Ω—ã–µ</div>`;
            activeInspectors.forEach((inspector, i) => {
                activeSection.innerHTML += renderInspectorItem(inspector, 'a' + i);
            });
            managementContent.appendChild(activeSection);
        }

        function createStatusSection(inspector, style, handlerId) {
            const statusMap = {
                'active': 'üü¢ –ê–∫—Ç–∏–≤–µ–Ω',
                'vacation': 'üèñÔ∏è –í –æ—Ç–ø—É—Å–∫–µ',
                'sick': 'ü§í –ù–∞ –±–æ–ª—å–Ω–∏—á–Ω–æ–º'
            };
            const currentStatusText = statusMap[style.status] || 'üü¢ –ê–∫—Ç–∏–≤–µ–Ω';

            return `
                <div class="management-section">
                    <div class="custom-select-container" id="customSelect_${handlerId}_status">
                        <div class="select-selected" onclick="window.toggleCustomSelect('${handlerId}', 'status')">
                            ${currentStatusText}
                        </div>
                        <div class="select-items select-hide">
                            <div onclick="window.selectCustomOption('${handlerId}', 'status', 'active', 'üü¢ –ê–∫—Ç–∏–≤–µ–Ω')">üü¢ –ê–∫—Ç–∏–≤–µ–Ω</div>
                            <div onclick="window.selectCustomOption('${handlerId}', 'status', 'vacation', 'üèñÔ∏è –í –æ—Ç–ø—É—Å–∫–µ')">üèñÔ∏è –í –æ—Ç–ø—É—Å–∫–µ</div>
                            <div onclick="window.selectCustomOption('${handlerId}', 'status', 'sick', 'ü§í –ù–∞ –±–æ–ª—å–Ω–∏—á–Ω–æ–º')">ü§í –ù–∞ –±–æ–ª—å–Ω–∏—á–Ω–æ–º</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createColorSection(inspector, style, handlerId) {
            let colorOptions = '';
            availableColors.forEach(color => {
                const isSelected = style.color === color;
                colorOptions += `
                            <div class="color-option ${isSelected ? 'selected' : ''}" 
                                 style="background-color: ${color}"
                                 onclick="selectColor(window.inspectorHandlers['${handlerId}'], '${color}')"
                                 title="${color}">
                            </div>
                        `;
            });

            return `
                        <div class="management-section">
                            <div class="color-palette">
                                ${colorOptions}
                            </div>
                        </div>
                    `;
        }

        function createIconSection(inspector, style, handlerId) {
            let iconOptions = '';
            let currentIconText = '-- –í—ã–±–µ—Ä–∏—Ç–µ –∏–∫–æ–Ω–∫—É --';

            Object.keys(availableIcons).forEach(key => {
                const val = availableIcons[key];
                const isKeyEmoji = key.length <= 2 || /[\u{1F300}-\u{1FAFF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{2B50}]/u.test(key);
                const name = isKeyEmoji ? String(val) : String(key);
                const emoji = isKeyEmoji ? String(key) : String(val);

                if (style.icon === emoji) {
                    currentIconText = `${name} ${emoji}`;
                }

                iconOptions += `<div onclick="window.selectCustomOption('${handlerId}', 'icon', '${emoji}', '${name} ${emoji}')">${name} ${emoji}</div>`;
            });

            return `
                <div class="management-section">
                    <div class="custom-select-container" id="customSelect_${handlerId}_icon">
                        <div class="select-selected" onclick="window.toggleCustomSelect('${handlerId}', 'icon')">
                            ${currentIconText}
                        </div>
                        <div class="select-items select-hide" style="max-height: 200px; overflow-y: auto;">
                            ${iconOptions}
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Helper Functions ---

        // üî• REASSIGN CUSTOM DROPDOWN HELPERS
        window.toggleReassignDropdown = function (objId) {
            const container = document.getElementById(`customReassign_${objId}`);
            if (!container) return;

            const items = container.querySelector('.select-items');
            const selected = container.querySelector('.select-selected');

            // Close any other open dropdowns first (optional but good UI)
            const allItems = document.getElementsByClassName("select-items");
            for (let i = 0; i < allItems.length; i++) {
                if (allItems[i] !== items) {
                    allItems[i].classList.remove("select-show");
                    // remove arrow active from others if needed
                }
            }

            items.classList.toggle('select-show');
            selected.classList.toggle('select-arrow-active');
        };

        window.selectReassignOption = function (objId, newValue, displayText) {
            // Update UI text instantly for feedback
            const container = document.getElementById(`customReassign_${objId}`);
            if (container) {
                const selected = container.querySelector('.select-selected');
                selected.innerHTML = `<span>${displayText}</span>`;

                const items = container.querySelector('.select-items');
                items.classList.remove('select-show');
                selected.classList.remove('select-arrow-active');
            }

            // Call actual reassign logic
            reassignInspector(objId, newValue);
        };

        // Global click to close
        document.addEventListener("click", function (e) {
            if (!e.target.closest('.custom-select-container')) {
                const items = document.getElementsByClassName("select-items");
                const selected = document.getElementsByClassName("select-selected");
                for (let i = 0; i < items.length; i++) {
                    items[i].classList.remove("select-show");
                }
                for (let i = 0; i < selected.length; i++) {
                    selected[i].classList.remove("select-arrow-active");
                }
            }
        });

        // üî• –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–ï –°–û–°–¢–û–Ø–ù–ò–Ø –î–û–ú–û–í –ò–ù–°–ü–ï–ö–¢–û–†–û–í

        window.toggleInspectorsHomes = function () {
            showInspectorsHomes = !showInspectorsHomes;
            console.log('üè† Toggle Homes:', showInspectorsHomes);
            updateInspectorsHomesLayer();
            showNotification(showInspectorsHomes ? 'üè† –î–æ–º–∞ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–æ–≤ –ø–æ–∫–∞–∑–∞–Ω—ã' : 'üè† –î–æ–º–∞ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–æ–≤ —Å–∫—Ä—ã—Ç—ã', 'success');
        };

        window.updateInspectorsHomesLayer = function () {
            // üî• FIX: Access variable directly, not checking window property due to 'let' declaration
            if (!inspectorsHomesLayer) {
                console.error('‚ùå inspectorsHomesLayer variable is undefined');
                return;
            }
            inspectorsHomesLayer.removeAll();

            if (showInspectorsHomes) {
                if (userAccessRights !== '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä' && userAccessRights !== '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä') {
                    console.warn('‚õî Low access rights for homes:', userAccessRights);
                    return;
                }

                const homes = window.INSPECTOR_HOMES || {};
                const keys = Object.keys(homes);
                console.log('üè† Rendering homes for:', keys.length, 'inspectors');

                if (keys.length === 0) {
                    showNotification('‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –¥–æ–º–∞—Ö –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–æ–≤', 'warning');
                    return;
                }

                // üî• –°–æ–∑–¥–∞—ë–º Placemark –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–æ–º–∞ (GeoObjectCollection —Ä–∞–±–æ—Ç–∞–µ—Ç —Å Placemark)
                let addedCount = 0;
                keys.forEach(inspector => {
                    const home = homes[inspector];
                    if (!home || !home.lat || !home.lon) {
                        console.warn('‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω:', inspector);
                        return;
                    }

                    const style = getInspectorStyle(inspector);

                    const placemark = new ymaps.Placemark(
                        [parseFloat(home.lat), parseFloat(home.lon)],
                        {
                            hintContent: `üè† ${inspector}`,
                            balloonContent: `
                                <div style="padding: 10px; min-width: 250px;">
                                    <h3>üè† ${inspector}</h3>
                                    <p><strong>–ê–¥—Ä–µ—Å:</strong> ${home.address}</p>
                                    <p><strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</strong> ${home.lat}, ${home.lon}</p>
                                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${getStatusText(style.status)}</p>
                                </div>
                            `
                        },
                        {
                            preset: 'islands#blueHomeIcon',
                            iconColor: style.color || '#3498db'
                        }
                    );

                    inspectorsHomesLayer.add(placemark);
                    addedCount++;
                });

                console.log('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–æ–º–æ–≤ –Ω–∞ –∫–∞—Ä—Ç—É:', addedCount);
            }
        };

        window.toggleAccordion = function (header) {
            const content = header.nextElementSibling;
            content.classList.toggle('active');

            // üî• AUTO-SCROLL if opened
            if (content.classList.contains('active')) {
                setTimeout(() => {
                    content.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'nearest' });
                }, 300); // Wait for transition
            }
        };

        window.showManagementTab = function (handlerId, tabName) {
            document.getElementById(`tab_${handlerId}_status`).classList.add('hidden');
            document.getElementById(`tab_${handlerId}_color`).classList.add('hidden');
            document.getElementById(`tab_${handlerId}_icon`).classList.add('hidden');
            document.getElementById(`tab_${handlerId}_${tabName}`).classList.remove('hidden');
        };

        window.toggleCustomSelect = function (handlerId, type) {
            const id = `customSelect_${handlerId}_${type}`;
            const container = document.getElementById(id);
            if (!container) return;
            const items = container.querySelector('.select-items');
            const selected = container.querySelector('.select-selected');
            window.closeAllCustomSelects(selected);
            items.classList.toggle('select-show');
            selected.classList.toggle('select-arrow-active');
        };

        window.selectCustomOption = function (handlerId, type, value, text) {
            const container = document.getElementById(`customSelect_${handlerId}_${type}`);
            const selected = container.querySelector('.select-selected');
            selected.innerHTML = text;
            const inspector = window.inspectorHandlers[handlerId];
            updateInspectorConfig(inspector, type, value);
            window.toggleCustomSelect(handlerId, type);
        };

        window.closeAllCustomSelects = function (elmnt) {
            const items = document.getElementsByClassName("select-items");
            const selected = document.getElementsByClassName("select-selected");
            const arrNo = [];
            for (let i = 0; i < selected.length; i++) {
                if (elmnt == selected[i]) {
                    arrNo.push(i);
                } else {
                    selected[i].classList.remove("select-arrow-active");
                }
            }
            for (let i = 0; i < items.length; i++) {
                if (arrNo.indexOf(i)) {
                    items[i].classList.remove("select-show");
                }
            }
        };

        window.selectColor = function (inspector, color) {
            updateInspectorConfig(inspector, 'color', color);
        };

        window.updateInspectorConfig = function (inspector, key, value) {
            if (!window.PENDING_INSPECTOR_CHANGES[inspector]) {
                window.PENDING_INSPECTOR_CHANGES[inspector] = Object.assign({}, window.INSPECTORS_CONFIG[inspector] || { status: 'active', color: '#3498db', icon: 'üë§' });
            }
            window.PENDING_INSPECTOR_CHANGES[inspector][key] = value;
            const handlerId = Object.keys(window.inspectorHandlers).find(id => window.inspectorHandlers[id] === inspector);
            if (handlerId) {
                const btn = document.getElementById(`applyBtn_${handlerId}`);
                if (btn) btn.classList.remove('hidden');
            }
        };

        async function applyInspectorChanges(inspector) {
            const pending = window.PENDING_INSPECTOR_CHANGES[inspector];
            const current = window.INSPECTORS_CONFIG[inspector] || {};
            const config = Object.assign({}, current, pending || {});

            console.log(`üíæ Applying changes for ${inspector} INSTANTLY:`, config);

            // üî• 1. –ú–ì–ù–û–í–ï–ù–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –õ–û–ö–ê–õ–¨–ù–û–ô –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò
            if (!window.INSPECTORS_CONFIG) window.INSPECTORS_CONFIG = {};
            window.INSPECTORS_CONFIG[inspector] = config;

            // üî• 2. –°–û–•–†–ê–ù–Ø–ï–ú –í –ù–ï–î–ê–í–ù–ò–ï
            if (!window.RECENT_INSPECTOR_CHANGES) window.RECENT_INSPECTOR_CHANGES = {};
            window.RECENT_INSPECTOR_CHANGES[inspector] = {
                config: config,
                timestamp: Date.now()
            };

            // üî• 3. –û–ë–ù–û–í–õ–Ø–ï–ú –ò–ù–¢–ï–†–§–ï–ô–° –ú–ì–ù–û–í–ï–ù–ù–û (–ì–†–£–ü–ü–ò–†–û–í–ö–ê)
            delete window.PENDING_INSPECTOR_CHANGES[inspector];
            updateInspectorInFilters(inspector, config);
            updateInspectorManagementContent();

            // üî• 4. –ï–°–õ–ò –°–¢–ê–¢–£–° –í –û–¢–ü–£–°–ö–ï/–ë–û–õ–ï–ï–¢ -> –ü–ï–†–ï–ù–û–°–ò–ú –û–ë–™–ï–ö–¢–´
            if (config.status !== 'active') {
                const transferred = objectsData.filter(o => o.inspector === inspector);
                if (transferred.length > 0) {
                    console.log(`üöÄ Instant Transfer of ${transferred.length} objects to Admin...`);

                    // Local Map Update
                    transferred.forEach(o => {
                        o.inspector = 'Admin';
                        const isActive = o.entryTime && !o.exitTime;
                        const isCompleted = !!o.exitTime;
                        const status = isCompleted ? 'completed' : (isActive ? 'active' : 'new');
                        updateSinglePointOnMapV2(o.id, status);
                    });

                    showNotification(`‚ö° ${transferred.length} –æ–±—ä–µ–∫—Ç–æ–≤ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –∫ Admin`, 'success');

                    // BACKGROUND SERVER SYNC (Batch Loop)
                    (async () => {
                        for (let i = 0; i < transferred.length; i++) {
                            const obj = transferred[i];
                            const url = `${SCRIPT_URL}?action=reassign&objectId=${obj.id}&newInspector=Admin&callback=ignore`;
                            const script = document.createElement('script');
                            script.src = url;
                            document.head.appendChild(script);
                            await new Promise(r => setTimeout(r, 50));
                        }
                    })();
                }
            } else {
                updateMap(); // Refresh map styles if color/icon changed
            }

            // üî• 5. SILENT SERVER CONFIG SAVE
            saveInspectorConfig(inspector, config, true);
        }
        // Expose to window (important since we changed to async function)
        window.applyInspectorChanges = applyInspectorChanges;

        function getStatusIcon(status) {
            const icons = { 'active': 'üü¢', 'vacation': 'üèñÔ∏è', 'sick': 'ü§í' };
            return icons[status] || 'üü¢';
        }

        window.closeAllMenus = function () {
            const mgmt = document.getElementById('inspectorManagementMenu');
            if (mgmt) {
                mgmt.classList.remove('active');
                mgmt.style.transform = ''; // Reset transform if swipe left it dirty
            }
            activeMenu = null;
        };

        window.closeInspectorManagement = function () {
            window.closeAllMenus();
        };


        function closeTopMenu() {
            if (activeMenu === 'management') {
                toggleInspectorsManagement();
            }
        }

        document.addEventListener("click", function (e) {
            if (!e.target.closest('.custom-select-container')) {
                window.closeAllCustomSelects();
            }
        });

        // –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ö–ù–û–ü–û–ö
        function updateWorkDayButtons() {
            const openBtn = document.getElementById('openDayBtn');
            const closeBtn = document.getElementById('closeDayBtn');
            const indicator = document.getElementById('workDayIndicator');
            const bubble = document.getElementById('workDayBubble');

            if (!openBtn || !closeBtn || !indicator || !bubble) return;

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–ª–∞–π–Ω-—Å—Ç–∏–ª–∏, –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–µ–¥—ã–¥—É—â–µ–π –ª–æ–≥–∏–∫–æ–π
            openBtn.style = '';
            closeBtn.style = '';
            openBtn.className = 'workday-btn';
            closeBtn.className = 'workday-btn';

            if (isWorkDayOpen) {
                // –î–ï–ù–¨ –û–¢–ö–†–´–¢: –ü—É–∑—ã—Ä—å –Ω–∞ "–ó–∞–∫—Ä—ã—Ç—å" (–°–ø—Ä–∞–≤–∞) - –ì–æ—Ç–æ–≤ –∫ –∑–∞–∫—Ä—ã—Ç–∏—é
                bubble.style.transform = 'translateX(100%)';

                openBtn.classList.add('inactive-text');
                closeBtn.classList.add('active-text'); // –í–∏–¥–µ–Ω —Ç–µ–∫—Å—Ç "–ó–∞–∫—Ä—ã—Ç—å –¥–µ–Ω—å"

                openBtn.disabled = true; // –£–∂–µ –æ—Ç–∫—Ä—ã—Ç
                closeBtn.disabled = false; // –ú–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å

                indicator.textContent = '–°—Ç–∞—Ç—É—Å: –î–µ–Ω—å –æ—Ç–∫—Ä—ã—Ç';

                // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–µ–ª–µ–Ω—ã–π
                indicator.style.cssText = `
                    background-color: #ffffff;
                    border: 2px solid #27ae60;
                    color: #27ae60;
                    border-radius: 12px;
                    padding: 12px;
                    text-align: center;
                    width: 100%;
                    display: block;
                    margin-top: 10px;
                    font-weight: 600;
                    box-sizing: border-box;
                `;

            } else {
                // –î–ï–ù–¨ –ó–ê–ö–†–´–¢: –ü—É–∑—ã—Ä—å –Ω–∞ "–û—Ç–∫—Ä—ã—Ç—å" (–°–ª–µ–≤–∞) - –ì–æ—Ç–æ–≤ –∫ –æ—Ç–∫—Ä—ã—Ç–∏—é
                bubble.style.transform = 'translateX(0)';

                openBtn.classList.add('active-text'); // –í–∏–¥–µ–Ω —Ç–µ–∫—Å—Ç "–û—Ç–∫—Ä—ã—Ç—å –¥–µ–Ω—å"
                closeBtn.classList.add('inactive-text');

                openBtn.disabled = false; // –ú–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å
                closeBtn.disabled = true; // –£–∂–µ –∑–∞–∫—Ä—ã—Ç

                indicator.textContent = '–°—Ç–∞—Ç—É—Å: –î–µ–Ω—å –∑–∞–∫—Ä—ã—Ç';

                // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–µ–∂–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π
                indicator.style.cssText = `
                    background-color: #ffffff;
                    border: 2px solid #e74c3c;
                    color: #e74c3c;
                    border-radius: 12px;
                    padding: 12px;
                    text-align: center;
                    width: 100%;
                    display: block;
                    margin-top: 10px;
                    font-weight: 600;
                    box-sizing: border-box;
                `;
            }
        }
    </script>
    <script>
        // üî• –°–í–ê–ô–ü –õ–û–ì–ò–ö–ê –î–õ–Ø –†–ê–ë–û–ß–ï–ì–û –î–ù–Ø
        function initWorkDaySwipe() {
            const wrapper = document.getElementById('workDayControlWrapper');
            const bubble = document.getElementById('workDayBubble');
            if (!wrapper || !bubble) return;

            let startX = 0;
            let isDragging = false;
            let startTranslate = 0;

            wrapper.addEventListener('touchstart', (e) => {
                const overlay = document.getElementById('workDayApprovalOverlay');
                if (overlay && !overlay.classList.contains('hidden')) return;

                e.stopPropagation(); // üî• Stop global handlers
                isDragging = true;
                startX = e.touches[0].clientX;
                bubble.style.transition = 'none';

                // Calculate precise max width based on actual elements
                const totalWidth = wrapper.offsetWidth;
                const bubbleWidth = bubble.offsetWidth;
                const maxTranslate = totalWidth - bubbleWidth - 8; // 8px total padding

                // If Open, we start at maxTranslate, else 0
                // Match the visual state more accurately
                startTranslate = isWorkDayOpen ? maxTranslate : 0;
            }, { passive: false });

            wrapper.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                e.stopPropagation(); // üî• Stop global handlers

                const delta = e.touches[0].clientX - startX;
                let newPos = startTranslate + delta;

                const totalWidth = wrapper.offsetWidth;
                const bubbleWidth = bubble.offsetWidth;
                const maxPos = totalWidth - bubbleWidth - 8; // Match start calculation

                if (newPos < 0) newPos = 0;
                if (newPos > maxPos) newPos = maxPos;

                bubble.style.transform = `translateX(${newPos}px)`;

                // –ü—Ä–æ–∂–µ–∫—Ç–æ—Ä
                const progress = newPos / maxPos;
                const openBtn = document.getElementById('openDayBtn');
                const closeBtn = document.getElementById('closeDayBtn');

                if (openBtn && closeBtn) {
                    openBtn.style.opacity = Math.max(0, 1 - (progress * 1.5));
                    closeBtn.style.opacity = Math.max(0, (progress - 0.3) * 1.5);
                }

            }, { passive: false });

            wrapper.addEventListener('touchend', (e) => {
                if (!isDragging) return;
                e.stopPropagation(); // üî• Stop global handlers
                isDragging = false;

                // –í–∫–ª—é—á–∞–µ–º –ø–ª–∞–≤–Ω—É—é –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∂–µ—Å—Ç–∞
                bubble.style.transition = 'transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55)';

                // –°–±—Ä–æ—Å —Ä—É—á–Ω–æ–π –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏
                const openBtn = document.getElementById('openDayBtn');
                const closeBtn = document.getElementById('closeDayBtn');

                // –°–Ω–∞—á–∞–ª–∞ —Å–±—Ä–æ—Å–∏–º
                if (openBtn) openBtn.style.opacity = '';
                if (closeBtn) closeBtn.style.opacity = '';

                const endX = e.changedTouches[0].clientX;
                const delta = endX - startX;
                const threshold = 40;

                if (isWorkDayOpen) {
                    // –ú—ã –°–ü–†–ê–í–ê (–û—Ç–∫—Ä—ã—Ç). –°–≤–∞–π–ø –í–õ–ï–í–û -> –ó–∞–∫—Ä—ã—Ç—å
                    if (delta < -threshold) {
                        bubble.style.transform = 'translateX(0)';

                        // –í–∏–∑—É–∞–ª—å–Ω–æ: —Å—Ç–∞–ª –ó–ê–ö–†–´–¢ (—Ç–µ–∫—Å—Ç "–û—Ç–∫—Ä—ã—Ç—å –¥–µ–Ω—å" –∞–∫—Ç–∏–≤–µ–Ω)
                        if (openBtn) {
                            openBtn.style.opacity = '1';
                            openBtn.style.color = '#2c3e50';
                        }
                        if (closeBtn) closeBtn.style.opacity = '0';

                        setTimeout(() => {
                            endWorkDay();
                        }, 500);
                    } else {
                        // –í–æ–∑–≤—Ä–∞—Ç –≤–ø—Ä–∞–≤–æ (–æ—Å—Ç–∞—Ç—å—Å—è –û—Ç–∫—Ä—ã—Ç—ã–º)
                        bubble.style.transform = 'translateX(100%)';
                    }
                } else {
                    // –ú—ã –°–õ–ï–í–ê (–ó–∞–∫—Ä—ã—Ç). –°–≤–∞–π–ø –í–ü–†–ê–í–û -> –û—Ç–∫—Ä—ã—Ç—å
                    if (delta > threshold) {
                        bubble.style.transform = 'translateX(100%)';

                        // –í–∏–∑—É–∞–ª—å–Ω–æ: —Å—Ç–∞–ª –û–¢–ö–†–´–¢ (—Ç–µ–∫—Å—Ç "–ó–∞–∫—Ä—ã—Ç—å –¥–µ–Ω—å" –∞–∫—Ç–∏–≤–µ–Ω)
                        if (openBtn) openBtn.style.opacity = '0';
                        if (closeBtn) {
                            closeBtn.style.opacity = '1';
                            closeBtn.style.color = '#2c3e50';
                        }

                        setTimeout(() => {
                            startWorkDay();
                        }, 500);
                    } else {
                        // –í–æ–∑–≤—Ä–∞—Ç –≤–ª–µ–≤–æ (–æ—Å—Ç–∞—Ç—å—Å—è –ó–∞–∫—Ä—ã—Ç—ã–º)
                        bubble.style.transform = 'translateX(0)';
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initWorkDaySwipe, 500);
        });
        // üî• SWIPE LOGIC FOR MANAGEMENT MENU
        // üî• SWIPE LOGIC FOR MANAGEMENT MENU
        function initInspectorMenuSwipe() {
            const menu = document.getElementById('inspectorManagementMenu');
            if (!menu) return;

            let startX = 0;
            let currentX = 0;
            let isDragging = false;

            menu.addEventListener('touchstart', (e) => {
                e.stopPropagation(); // Stop bubble
                startX = e.touches[0].clientX;
                currentX = startX; // üî• Initialize currentX
                isDragging = true;
                menu.style.transition = 'none';
            }, { passive: true });

            menu.addEventListener('touchmove', (e) => {
                e.stopPropagation(); // Stop bubble
                if (!isDragging) return;
                currentX = e.touches[0].clientX;
                const deltaX = currentX - startX;

                // Only allow swiping LEFT (negative deltaX) to close
                if (deltaX < 0) {
                    // Limit drag to 100% width
                    menu.style.transform = `translateX(${deltaX}px)`;
                }
            }, { passive: true });

            menu.addEventListener('touchend', (e) => {
                e.stopPropagation(); // Stop bubble
                if (!isDragging) return;
                isDragging = false;
                menu.style.transition = 'transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1)';

                const deltaX = currentX - startX;
                // If swiped left enough (e.g. 75px), close it
                if (deltaX < -75) {
                    toggleInspectorsManagement(); // Close first (remove class)
                    menu.style.transform = '';    // Then clear inline (animate from current to closed)
                } else {
                    menu.style.transform = ''; // Revert
                }
                startX = 0;
                currentX = 0;
            });

            // Stop clicks from reaching sidebar
            menu.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }

        // üî• SWIPE LOGIC FOR ADD OBJECT MENU - Identical to Inspector Menu
        function initAddObjectSwipe() {
            const menu = document.getElementById('addObjectDrawer');
            if (!menu) return;

            let startX = 0;
            let currentX = 0;
            let isDragging = false;

            menu.addEventListener('touchstart', (e) => {
                e.stopPropagation();
                startX = e.touches[0].clientX;
                currentX = startX;
                isDragging = true;
                menu.style.transition = 'none';
            }, { passive: false });

            menu.addEventListener('touchmove', (e) => {
                e.stopPropagation();
                if (!isDragging) return;
                currentX = e.touches[0].clientX;
                const deltaX = currentX - startX;

                // Stop scrolling if swiping horizontally
                if (Math.abs(deltaX) > 5) {
                    if (e.cancelable) e.preventDefault();
                }

                if (deltaX < 0) { // Swipe LEFT to close
                    menu.style.transform = `translateX(${deltaX}px)`;
                }
            }, { passive: false });

            menu.addEventListener('touchend', (e) => {
                e.stopPropagation();
                if (!isDragging) return;
                isDragging = false;
                menu.style.transition = 'transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1)';

                const deltaX = currentX - startX;
                // If swiped LEFT enough (e.g. -75px), close it
                if (deltaX < -75) {
                    closeAddObjectDrawer(); // Remove 'active' class
                    menu.style.transform = ''; // Clear inline transform
                } else {
                    menu.style.transform = ''; // Revert
                }
                startX = 0;
                currentX = 0;
            });

            menu.addEventListener('click', (e) => { e.stopPropagation(); });
        }

        // Call init
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initInspectorMenuSwipe();
                initAddObjectSwipe();
            });
        } else {
            initInspectorMenuSwipe();
            initAddObjectSwipe();
        }
        // üî• ADD OBJECT LIST LOGIC
        window.addedObjects = [];

        function openAddObjectList() {
            console.log('üî• Open Add Object List Clicked!');
            const drawer = document.getElementById('addObjectDrawer');
            if (drawer) {
                console.log('‚úÖ Drawer found, adding active class...');
                drawer.classList.add('active');
                renderAddObjectList();
            } else {
                console.error('‚ùå Drawer element NOT found!');
                alert('–û—à–∏–±–∫–∞: –≠–ª–µ–º–µ–Ω—Ç –º–µ–Ω—é –Ω–µ –Ω–∞–π–¥–µ–Ω!');
            }
        }

        function closeAddObjectDrawer() {
            const drawer = document.getElementById('addObjectDrawer');
            if (drawer) drawer.classList.remove('active');
        }

        function filterAddObjectList(query) {
            renderAddObjectList(query);
        }

        function renderAddObjectList(filter = '') {
            const container = document.getElementById('addObjectListContent');
            if (!container) return;

            const list = window.addedObjects || [];
            if (list.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">–ù–µ—Ç –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤</div>';
                return;
            }

            const lowerFilter = filter.toLowerCase();
            const filtered = list.filter(obj =>
                (obj.id && String(obj.id).toLowerCase().includes(lowerFilter)) ||
                (obj.address && String(obj.address).toLowerCase().includes(lowerFilter))
            );

            if (filtered.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                return;
            }

            container.innerHTML = filtered.map(obj => `
                <div class="add-object-item">
                    <div class="add-object-title">ID: ${obj.id}</div>
                    <div class="add-object-badge">${obj.inspector || 'Admin'} | ${obj.list}</div>
                    <div class="add-object-address">${obj.address}</div>
                    <button class="add-object-btn" onclick="moveObjectToMainMap('${obj.id}')">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            `).join('');
        }

        function moveObjectToMainMap(objectId) {
            console.log('üî• moveObjectToMainMap called for:', objectId);
            openAddObjectConfirmation(objectId);
        }

        let pendingAddObjectId = null;

        function openAddObjectConfirmation(objectId) {
            console.log('Open Confirmation for:', objectId);
            if (window.resetAddObjectCardTransform) window.resetAddObjectCardTransform();

            const object = window.addedObjects.find(o => String(o.id) === String(objectId));
            if (!object) {
                console.error('Object not found in window.addedObjects:', objectId);
                alert('–û–±—ä–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                return;
            }

            pendingAddObjectId = objectId;
            const modal = document.getElementById('addObjectConfirmModal');
            const content = document.getElementById('addObjectConfirmContent');

            if (!modal || !content) {
                console.error('Modal elements missing');
                return;
            }

            // üî• Ensure container is flex to support positioning handle at bottom
            content.style.display = 'flex';
            content.style.flexDirection = 'column';
            content.style.height = '100%';

            let inspectorOptions = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–∞ --</option>';

            // üî• CORRECT WAY TO GET INSPECTORS (matches Reassign logic)
            const allInspectors = Object.keys(window.INSPECTORS_CONFIG || {}).sort();
            const uniqueInspectors = new Set([...allInspectors, 'Admin']);
            if (object.inspector) uniqueInspectors.add(object.inspector);

            uniqueInspectors.forEach(insp => {
                if (!insp) return;

                // Get style using the helper function (handles avatars, status, etc)
                const style = getInspectorStyle(insp);
                const statusText = style.status !== 'active' ? ` (${getStatusText(style.status)})` : '';

                // For Add Object, we typically want to allow valid choices, 
                // but maybe we should mark inactive ones visually? 
                // The reassign logic disables them, let's do the same for consistency.
                const isDisabled = (style.status !== 'active' && insp !== 'Admin') ? 'disabled' : '';

                const isSelected = (insp === object.inspector) ? 'selected' : '';

                inspectorOptions += `<option value="${insp}" ${isSelected} ${isDisabled}>${style.icon} ${insp}${statusText}</option>`;
            });

            content.innerHTML = `
                <div style="flex: 1;">
                    <h2 style="font-size: 1.25rem; font-weight: 700; color: #1f2937; margin-bottom: 15px;">–¢–æ—á–∫–∞ ‚Ññ${object.id}</h2>
                    
                    <div style="margin-bottom: 15px;">
                        <div style="font-size: 0.75rem; color: #9ca3af; font-weight: 600; margin-bottom: 4px;">–ê–î–†–ï–°</div>
                        <div style="font-size: 0.95rem; color: #374151; line-height: 1.4;">${object.address || '–ù–µ—Ç –∞–¥—Ä–µ—Å–∞'}</div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 0.75rem; color: #9ca3af; font-weight: 600; margin-bottom: 4px;">–ò–ù–°–ü–ï–ö–¢–û–†</div>
                        <!-- Hidden input to store value -->
                        <input type="hidden" id="addObjectInspectorValue" value="${object.inspector || ''}">
                        
                        <!-- Custom Dropdown -->
                        <div class="custom-select-container" id="customAddObject_Inspector">
                            <div class="select-selected" onclick="toggleAddObjectDropdown()">
                                ${object.inspector ?
                    (() => {
                        const s = getInspectorStyle(object.inspector);
                        return `<span>${s.icon} ${object.inspector}</span>`;
                    })()
                    : '<span>-- –í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–∞ --</span>'
                }
                            </div>
                            <div class="select-items">
                                ${Array.from(uniqueInspectors).map(inspector => {
                    if (!inspector) return '';
                    const style = getInspectorStyle(inspector);
                    const statusText = style.status !== 'active' ? ` (${getStatusText(style.status)})` : '';
                    const isCurrent = object.inspector === inspector;
                    const isDisabled = (style.status !== 'active' && inspector !== 'Admin');
                    const divClass = isCurrent ? 'same-as-selected' : (isDisabled ? 'disabled-option' : '');
                    const clickAction = isDisabled ? '' : `selectAddObjectOption('${inspector}', '${style.icon} ${inspector}')`;

                    return `
                                        <div class="${divClass}" onclick="${clickAction}">
                                            <span>${style.icon} ${inspector}${statusText}</span>
                                            ${isCurrent ? '<span>‚Üê —Ç–µ–∫—É—â–∏–π</span>' : ''}
                                        </div>`;
                }).join('')}
                            </div>
                        </div>

                    </div>
                </div>

                <div style="margin-top: auto;">
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button onclick="confirmAddObject()" style="width: 100%; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 1rem; cursor: pointer;">–î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>

                    <!-- Swipe Handle -->
                    <div id="addObjectConfirmHandle" class="balloon-handle" style="margin-top: 15px; width: 100%; height: 20px; display: flex; justify-content: center; align-items: center; cursor: grab;">
                        <span style="width: 40px; height: 5px; background: #d1d5db; border-radius: 3px;"></span>
                    </div>
                </div>
            `;

            modal.classList.remove('hidden');

            // üî• DEBUG VISIBILITY & FORCE Z-INDEX (Just in case)
            setTimeout(() => {
                const style = window.getComputedStyle(modal);
                console.log('üîç Modal Visibility Check:', {
                    display: style.display,
                    zIndex: style.zIndex,
                    visibility: style.visibility
                });
                if (style.display === 'none') {
                    modal.style.display = 'flex';
                }
            }, 50);

            // Init swipe logic
            // setTimeout(() => {
            //     const handle = document.getElementById('addObjectConfirmHandle');
            //     // if (handle) initConfirmModalSwipe(handle); // üî• REPLACED WITH GENERIC SWIPE
            // }, 100);
        }

        // üî• ADD OBJECT DROPDOWN HELPERS
        function toggleAddObjectDropdown() {
            const container = document.getElementById('customAddObject_Inspector');
            if (container) {
                const items = container.querySelector('.select-items');
                const selected = container.querySelector('.select-selected');

                // Close others
                const allItems = document.getElementsByClassName("select-items");
                for (let i = 0; i < allItems.length; i++) {
                    if (allItems[i] !== items) {
                        allItems[i].classList.remove("select-show");
                    }
                }

                items.classList.toggle('select-show');
                selected.classList.toggle('select-arrow-active');
            }
        }

        function selectAddObjectOption(value, displayText) {
            const container = document.getElementById('customAddObject_Inspector');
            if (container) {
                const selected = container.querySelector('.select-selected');
                selected.innerHTML = `<span>${displayText}</span>`;

                const items = container.querySelector('.select-items');
                items.classList.remove('select-show');
                selected.classList.remove('select-arrow-active');

                // Update hidden input
                const hiddenInput = document.getElementById('addObjectInspectorValue');
                if (hiddenInput) hiddenInput.value = value;
            }
        }

        // üî• Swipe Logic for Confirm Modal
        function initConfirmModalSwipe(element) {
            let startY = 0;

            element.addEventListener('touchstart', e => {
                if (e.changedTouches.length > 0) {
                    startY = e.changedTouches[0].clientY;
                }
            }, { passive: true });

            element.addEventListener('touchend', e => {
                if (e.changedTouches.length > 0) {
                    const endY = e.changedTouches[0].clientY;
                    const diff = endY - startY;

                    // Swipe UP or DOWN (> 50px) closes modal
                    if (Math.abs(diff) > 50) {
                        closeAddObjectConfirm();
                    }
                }
            }, { passive: true });
        }

        function closeAddObjectConfirm() {
            const modal = document.getElementById('addObjectConfirmModal');
            if (modal) modal.classList.add('hidden');
            pendingAddObjectId = null;
        }

        function confirmAddObject() {
            if (!pendingAddObjectId) return;

            const objectId = pendingAddObjectId;

            // üî• READ FROM HIDDEN INPUT NOW
            const input = document.getElementById('addObjectInspectorValue');
            const newInspector = input ? input.value : '';

            console.log('Confirmed Add Object:', objectId, 'Inspector:', newInspector);

            closeAddObjectConfirm(); // Close immediately

            const callbackName = 'moveObjectCallback_' + Date.now();
            window[callbackName] = function (data) {
                delete window[callbackName];
                if (data.success) {
                    showNotification('‚úÖ –û–±—ä–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω!', 'success');
                    // Remove from local list
                    window.addedObjects = window.addedObjects.filter(o => String(o.id) !== String(objectId));

                    const searchInput = document.getElementById('addObjectSearch');
                    if (searchInput) {
                        renderAddObjectList(searchInput.value);
                    } else {
                        renderAddObjectList();
                    }

                    // Refresh main data
                    loadData();
                } else {
                    showNotification('‚ùå –û—à–∏–±–∫–∞: ' + (data.message || 'Unknown'), 'error');
                }
            };

            // Pass inspector param
            const inspectorParam = newInspector ? `&inspector=${encodeURIComponent(newInspector)}` : '';
            const url = SCRIPT_URL + '?action=moveObjectToMap&objectId=' + encodeURIComponent(objectId) + inspectorParam + '&callback=' + callbackName;
            const script = document.createElement('script');
            script.src = url;
            document.head.appendChild(script);
        }
    </script>
    <!-- üî• –ú–û–î–ê–õ–ö–ê –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø –î–û–ë–ê–í–õ–ï–ù–ò–Ø (Add Object) -->
    <div class="object-details hidden" id="addObjectConfirmModal"
        style="z-index: 2147483647 !important; position: fixed !important;">
        <div class="object-details__backdrop" style="z-index: 2147483646 !important;"></div>
        <div class="object-details__card" role="dialog" aria-modal="true"
            style="max-width: 400px; z-index: 2147483647 !important;">
            <button class="object-details__close" type="button" onclick="closeAddObjectConfirm()">‚úï</button>

            <div id="addObjectConfirmContent">
                <!-- Dynamic Content Here -->
            </div>
        </div>
    </div>

    <!-- üî• –í–´–ï–ó–ñ–ê–Æ–©–ï–ï –ú–ï–ù–Æ –°–ü–ò–°–ö–ê –û–ë–™–ï–ö–¢–û–í (add_object) -->
    <div class="side-drawer" id="addObjectDrawer">
        <div class="side-drawer-header">
            <div class="side-drawer-title">–°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤</div>
            <button class="side-drawer-close" onclick="event.stopPropagation(); closeAddObjectDrawer()">√ó</button>
        </div>
        <div class="side-drawer-search">
            <input type="text" id="addObjectSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É –∏–ª–∏ –∞–¥—Ä–µ—Å—É..."
                oninput="filterAddObjectList(this.value)">
        </div>
        <div class="side-drawer-content" id="addObjectListContent">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤...</div>
        </div>
    </div>
    <script>
        // üî• CUSTOM WORK DAY SLIDER LOGIC

        function initWorkDayControl() {
            const wrapper = document.getElementById('workDayControlWrapper');
            if (!wrapper) return;

            // Handle Click (Toggle)
            wrapper.addEventListener('click', (e) => {
                // Ignore if clicking buttons directly allowed (they are invisible overlays)
                // We just toggle based on current state
                if (isWorkDayOpen) {
                    endWorkDay();
                } else {
                    startWorkDay();
                }
            });
        }

        // üî• GENERIC SWIPE TO DISMISS LOGIC
        function enableSwipeDismiss(card, closeCallback) {
            if (!card) return;

            let startY = 0;
            let currentY = 0;
            let isDragging = false;
            let startTime = 0;

            const resetTransform = () => {
                card.style.transform = '';
                card.style.transition = '';
            };

            // Attach reset to card for easy access
            card._resetTransform = resetTransform;

            card.addEventListener('touchstart', (e) => {
                const content = card.querySelector('.object-details__content, #addObjectConfirmContent');
                // Ignore if scrolling inside content (unless at top)
                if (content && content.scrollTop > 5) return;

                // Ignore inputs
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

                startY = e.touches[0].clientY;
                currentY = startY;
                isDragging = true;
                startTime = Date.now();
                card.style.transition = 'none';
            }, { passive: true });

            card.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                currentY = e.touches[0].clientY;
                const deltaY = currentY - startY;

                if (deltaY > 0) {
                    card.style.transform = `translateY(${deltaY}px)`;
                }
            }, { passive: false });

            card.addEventListener('touchend', (e) => {
                if (!isDragging) return;
                isDragging = false;

                const deltaY = currentY - startY;
                const time = Date.now() - startTime;
                const velocity = deltaY / time;

                // Close if pulled > 150px OR fast flick down
                if (deltaY > 150 || (deltaY > 60 && velocity > 0.5)) {
                    card.style.transition = 'transform 0.3s ease-out';
                    card.style.transform = 'translateY(100vh)';

                    setTimeout(() => {
                        resetTransform();
                        if (closeCallback) closeCallback();
                    }, 300);
                } else {
                    // Bounce back
                    if (deltaY > 0) {
                        card.style.transition = 'transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1)';
                        card.style.transform = '';
                    }
                }
            });
        }

        // üî• INIT SWIPE FOR ALL MODALS
        function initSwipeAnimations() {
            // 1. Main Object Details
            const mainCard = document.querySelector('#objectDetailsOverlay .object-details__card');
            if (mainCard) {
                // Global expose for showObjectBalloon
                window.resetObjectCardTransform = () => {
                    if (mainCard._resetTransform) mainCard._resetTransform();
                    else { mainCard.style.transform = ''; mainCard.style.transition = ''; }
                };
                enableSwipeDismiss(mainCard, closeObjectDetails);
            }

            // 2. Add Object Confirmation
            const confirmCard = document.querySelector('#addObjectConfirmModal .object-details__card');
            if (confirmCard) {
                // Expose reset for openAddObjectConfirmation
                window.resetAddObjectCardTransform = () => {
                    if (confirmCard._resetTransform) confirmCard._resetTransform();
                    else { confirmCard.style.transform = ''; confirmCard.style.transition = ''; }
                };
                enableSwipeDismiss(confirmCard, closeAddObjectConfirm);
            }
        }


        // Initialize when DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initWorkDayControl);
            document.addEventListener('DOMContentLoaded', initSwipeAnimations); // üî• Init Swipe
        } else {
            initWorkDayControl();
            initSwipeAnimations(); // üî• Init Swipe
        }

        // üî• MAP SEARCH LOGIC
        function toggleMapSearch() {
            const bar = document.getElementById('mapSearchBar');
            const input = document.getElementById('mapSearchInput');
            if (!bar) return;

            if (bar.classList.contains('active')) {
                // If input has value, maybe search instead of close?
                // For now: toggle close
                if (input.value.trim() !== '') {
                    performMapSearch(input.value);
                } else {
                    bar.classList.remove('active');
                }
            } else {
                bar.classList.add('active');
                bar.classList.remove('hidden'); // Legacy helper just in case
                setTimeout(() => input.focus(), 100);
            }
        }

        function clearMapSearch() {
            const input = document.getElementById('mapSearchInput');
            const bar = document.getElementById('mapSearchBar');

            if (input.value === '') {
                // If empty, close
                bar.classList.remove('active');
            } else {
                input.value = '';
                input.focus();
                performMapSearch(''); // üî• Clear filter
            }
        }

        function handleMapSearchKey(e) {
            if (e.key === 'Enter') {
                performMapSearch(e.target.value);
                // Hide keyboard on mobile
                e.target.blur();
            }
        }

        // üî• ADD LIVE SEARCH LISTENER
        setTimeout(() => {
            const inp = document.getElementById('mapSearchInput');
            if (inp) inp.addEventListener('input', (e) => performMapSearch(e.target.value));
        }, 1000);

        function performMapSearch_OLD(query) {
            if (!query || !query.trim()) return;
            const term = query.trim().toLowerCase();

            console.log('üîç Searching map for:', term);

            // 1. EXACT ID MATCH (Numbers)
            // Remove "id" prefix if user typed it, though usually they just type number
            const isNumeric = /^\d+$/.test(term);

            let foundObject = null;

            if (isNumeric) {
                // Search for Exact ID
                foundObject = objectsData.find(obj => String(obj.id) === term);
            } else {
                // 2. TEXT MATCH (Address)
                // First try exact match (rare)
                // Then try partial match

                // We'll prioritize: 
                // a) Starts with ID (e.g. "5 Some st" -> ID 5?) - skipped for now unless purely numeric
                // b) Address contains match

                const matches = objectsData.filter(obj =>
                    (obj.address && obj.address.toLowerCase().includes(term)) ||
                    (obj.inspector && obj.inspector.toLowerCase().includes(term)) // Optional: search by inspector too?
                );

                if (matches.length > 0) {
                    // Just take the first one for now
                    foundObject = matches[0];
                    if (matches.length > 1) {
                        showNotification(`üîç –ù–∞–π–¥–µ–Ω–æ –æ–±—ä–µ–∫—Ç–æ–≤: ${matches.length}. –ü–æ–∫–∞–∑–∞–Ω –ø–µ—Ä–≤—ã–π.`, 'success');
                    }
                }
            }

            if (foundObject) {
                // FOUND!
                console.log('‚úÖ Found object:', foundObject.id);

                // Center Map
                if (map) {
                    map.setCenter([parseFloat(foundObject.latitude), parseFloat(foundObject.longitude)], 17, {
                        duration: 300
                    });
                }

                // Open Balloon
                // Use existing logic
                showObjectBalloon(foundObject.id);

                showNotification(`üìç –û–±—ä–µ–∫—Ç ${foundObject.id} –Ω–∞–π–¥–µ–Ω`, 'success');
            } else {
                showNotification('‚ùå –û–±—ä–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
            }
        }

        function performMapSearch(query) {
            // New Strict Filtering Logic
            if (!query || !query.trim()) {
                if (typeof objectManager !== 'undefined' && objectManager) objectManager.setFilter('id != -1');
                if (typeof activeObjectsLayer !== 'undefined' && activeObjectsLayer) activeObjectsLayer.setFilter('id != -1');
                return;
            }

            const term = query.trim().toLowerCase();
            console.log('üîç Filtering map for:', term);

            // 1. Identify matching IDs locally
            const isNumeric = /^\d+$/.test(term);
            const matchedIds = new Set();

            if (isNumeric) {
                const match = objectsData.find(obj => String(obj.id) === term);
                if (match) matchedIds.add(String(match.id));
            } else {
                objectsData.forEach(obj => {
                    const addr = (obj.address || '').toLowerCase();
                    const insp = (obj.inspector || '').toLowerCase();
                    if (addr.includes(term) || insp.includes(term)) {
                        matchedIds.add(String(obj.id));
                    }
                });
            }

            // 2. Apply Filter
            const filterFunction = function (object) {
                return matchedIds.has(String(object.id));
            };

            if (typeof objectManager !== 'undefined' && objectManager) objectManager.setFilter(filterFunction);
            if (typeof activeObjectsLayer !== 'undefined' && activeObjectsLayer) activeObjectsLayer.setFilter(filterFunction);
        }

        // üî• OVERRIDE UPDATE FUNCTION FOR SLIDER
        window.updateWorkDayButtons = function () {
            const wrapper = document.getElementById('workDayControlWrapper');
            const indicator = document.getElementById('workDayIndicator');
            const bubble = document.getElementById('workDayBubble');

            if (wrapper) {
                if (isWorkDayOpen) {
                    wrapper.classList.add('open');
                } else {
                    wrapper.classList.remove('open');
                }

                // üî• CRITICAL: Clear inline styles from swipe logic to let CSS take over
                if (bubble) {
                    bubble.style.transform = '';
                    bubble.style.transition = '';
                }
            }

            if (indicator) {
                indicator.className = 'work-day-indicator ' + (isWorkDayOpen ? 'open' : 'closed');
                indicator.textContent = isWorkDayOpen ? '–°—Ç–∞—Ç—É—Å: –î–µ–Ω—å –æ—Ç–∫—Ä—ã—Ç' : '–°—Ç–∞—Ç—É—Å: –î–µ–Ω—å –∑–∞–∫—Ä—ã—Ç';
            }
        };

        // ==================================================================
        // üî• YANDEX DISK FOLDER CREATION HANDLER
        // ==================================================================

        /**
         * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫
         * –õ–æ–≥–∏–∫–∞: –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫–∏ –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ Yandex API -> –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å -> –û—Ç–∫—Ä—ã—Ç—å –ø–∞–ø–∫—É
         */
        window.handleYandexDiskButton = async function (objectId, yandexLink) {
            if (!objectId || !yandexLink) {
                console.error('‚ùå –ù–µ –ø–µ—Ä–µ–¥–∞–Ω objectId –∏–ª–∏ yandexLink');
                alert('–û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫');
                return;
            }

            // –ò—â–µ–º –∫–Ω–æ–ø–∫—É –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ
            const btn = document.querySelector(`[data-yandex-object="${objectId}"]`);
            if (!btn) {
                console.error('‚ùå –ö–Ω–æ–ø–∫–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è –æ–±—ä–µ–∫—Ç–∞', objectId);
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–∞–ø–æ–∫ –∏–∑ localStorage
            const folderStatus = localStorage.getItem('yndx_folders_' + objectId);

            if (folderStatus === 'created') {
                // –ü–∞–ø–∫–∏ —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã - –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É
                window.open(yandexLink, '_blank');
                return;
            }

            // –ü–∞–ø–∫–∏ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã - –∑–∞–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ
            btn.disabled = true;
            btn.style.opacity = '0.6';

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –∏ —Ç–µ–∫—Å—Ç –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É, –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –ø–æ–¥ —Ç–µ–∫—Å—Ç–æ–º
            btn.innerHTML = `<div style="display: flex; flex-direction: column; align-items: center; gap: 8px; width: 100%;">
                <div style="display: flex; align-items: center; gap: 6px;">
                    <span class="yandex-spinner"></span>
                    <span>–°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–æ–∫...</span>
                </div>
                <div class="yandex-progress-container" style="width: calc(100% - 20px);">
                    <div class="yandex-progress-bar" id="yandex-progress-${objectId}" style="width: 0%;"></div>
                </div>
            </div>`;

            try {
                // –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞–ø–∫–∏
                const now = new Date();
                const dd = String(now.getDate()).padStart(2, '0');
                const mm = String(now.getMonth() + 1).padStart(2, '0');
                const yyyy = now.getFullYear();
                const dateStr = `${dd}.${mm}.${yyyy}`;
                const mainFolderName = `${dateStr} ${currentUser}`;

                // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                console.log('üî• ObjectID:', objectId);
                console.log('üî• CurrentUser:', currentUser);
                console.log('üî• MainFolderName:', mainFolderName);
                console.log('üî• YandexLink:', yandexLink);

                // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ –∏–∑ —Å—Å—ã–ª–∫–∏ Google Sheets
                let folderPath = '';

                if (yandexLink.includes('/client/disk/')) {
                    // –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ - –∏–∑–≤–ª–µ–∫–∞–µ–º –ø—É—Ç—å –ø–æ—Å–ª–µ /client/disk/
                    const pathPart = yandexLink.split('/client/disk/')[1];
                    folderPath = decodeURIComponent(pathPart.split('?')[0]); // —É–±–∏—Ä–∞–µ–º query params –µ—Å–ª–∏ –µ—Å—Ç—å
                    console.log('üìÅ –ü—É—Ç—å –∏–∑ —Å—Å—ã–ª–∫–∏:', folderPath);
                } else {
                    // Fallback - –∏—Å–ø–æ–ª—å–∑—É–µ–º ObjectID
                    console.warn('‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω /client/disk/ –≤ —Å—Å—ã–ª–∫–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º ObjectID');
                    folderPath = `${YANDEX_ROOT_PATH}/${objectId}`;
                }

                // –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å –¥–∞—Ç–æ–π –∏ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–æ–º
                const mainPath = `${folderPath}/${mainFolderName}`;
                console.log('üî• MainPath (–∏—Ç–æ–≥–æ–≤—ã–π –ø—É—Ç—å):', mainPath);

                // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
                const progressBar = document.getElementById('yandex-progress-' + objectId);

                // –ö–æ—Ä–Ω–µ–≤–∞—è –ø–∞–ø–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–∏–∑ Google Sheets)
                // –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É —Å –¥–∞—Ç–æ–π –∏ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–æ–º (20% –ø—Ä–æ–≥—Ä–µ—Å—Å–∞)
                console.log('üî• –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏:', mainPath);
                const mainResult = await createYandexFolder(mainPath);
                if (!mainResult.success && mainResult.code !== 409) {
                    throw new Error(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–ø–∫–∏: ${mainResult.message}`);
                }
                if (progressBar) progressBar.style.width = '20%';

                // –°–ø–∏—Å–æ–∫ –ø–æ–¥–ø–∞–ø–æ–∫
                const subfolders = [
                    '–ê–∫—Ç + —Å–µ–ª—Ñ–∏ + –°–ö–£–î + –û–ñ–†',
                    '–û–±—â–∏–π —Ñ–æ—Ç–æ–æ—Ç—á–µ—Ç',
                    '–ü–µ—Ä–∏–º–µ—Ç—Ä–∞–ª—å–Ω–æ–µ –æ–≥—Ä–∞–∂–¥–µ–Ω–∏–µ + –ü–æ–¥—ä–µ–∑–¥–Ω—ã–µ –ø—É—Ç–∏',
                    '–ë—ã—Ç–æ–≤–æ–π –≥–æ—Ä–æ–¥–æ–∫',
                    '–ó–∞–º–µ—á–∞–Ω–∏—è –∫–æ–Ω—Ç—Ä–æ–ª—è –∫–∞—á–µ—Å—Ç–≤–∞',
                    '–ó–∞–º–µ—á–∞–Ω–∏—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–π –ø–ª–æ—â–∞–¥–∫–∏ + –ì—Ä—É–Ω—Ç'
                ];

                // –°–æ–∑–¥–∞—ë–º –ø–æ–¥–ø–∞–ø–∫–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (–±—ã—Å—Ç—Ä–µ–µ!)
                let created = 0;
                const progressStep = 80 / subfolders.length;

                // –°–æ–∑–¥–∞—ë–º –º–∞—Å—Å–∏–≤ –ø—Ä–æ–º–∏—Å–æ–≤ –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
                const folderPromises = subfolders.map(async (subfolder, index) => {
                    const subPath = `${mainPath}/${subfolder}`;
                    console.log('üî• –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∞–ø–∫–∏:', subPath);

                    try {
                        const result = await createYandexFolder(subPath);

                        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                        if (progressBar) {
                            const currentProgress = 20 + progressStep * (index + 1);
                            progressBar.style.width = currentProgress + '%';
                        }

                        if (result.success || result.code === 409) {
                            if (result.created) created++;
                            return { success: true, subfolder };
                        } else {
                            console.warn(`‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∞–ø–∫–∏ "${subfolder}":`, result.code, result.message);
                            return { success: false, subfolder, error: result.message };
                        }
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–¥–ø–∞–ø–∫–∏ "${subfolder}":`, error);
                        return { success: false, subfolder, error: error.message };
                    }
                });

                // –ñ–¥—ë–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
                await Promise.all(folderPromises);

                // –£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–ª–∏ –ø–∞–ø–∫–∏
                if (progressBar) progressBar.style.width = '100%';

                btn.innerHTML = 'üìÇ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ–æ—Ç—á–µ—Ç';
                btn.disabled = false;
                btn.style.opacity = '1';

                // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ —Å–æ–∑–¥–∞–Ω–Ω—É—é –ø–∞–ø–∫—É
                const directLink = `https://disk.yandex.ru/client/disk/${encodeURIComponent(mainPath)}`;

                // –û–±–Ω–æ–≤–ª—è–µ–º onclick –Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–Ω–æ–π –ø–∞–ø–∫–∏
                btn.onclick = function () {
                    window.open(directLink, '_blank');
                };

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                showNotification(
                    `‚úÖ –ü–∞–ø–∫–∏ —Å–æ–∑–¥–∞–Ω—ã!\n\n–°–æ–∑–¥–∞–Ω–æ: ${mainFolderName}\n–ü–æ–¥–ø–∞–ø–æ–∫: ${created}/${subfolders.length}\n\n–¢–µ–ø–µ—Ä—å –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –ø–∞–ø–∫—É.`,
                    'success'
                );

            } catch (error) {
                // –û—à–∏–±–∫–∞
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–ø–æ–∫:', error);
                btn.innerHTML = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è';
                btn.disabled = false;
                btn.style.opacity = '1';

                const errorMsg = error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫–∏:\n\n' + errorMsg);
            }
        };

        /**
         * –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–µ —á–µ—Ä–µ–∑ REST API
         * @param {string} path - –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "smg_ph/123/26.01.2026 –ò–≤–∞–Ω–æ–≤")
         * @returns {Promise<{success: boolean, created: boolean, code: number, message?: string}>}
         */
        async function createYandexFolder(path) {
            const url = `https://cloud-api.yandex.net/v1/disk/resources?path=${encodeURIComponent(path)}`;

            try {
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `OAuth ${YANDEX_OAUTH_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });

                const code = response.status;

                // 201 = –ø–∞–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∞, 409 = –ø–∞–ø–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)
                if (code === 201 || code === 409) {
                    return { success: true, code: code, created: code === 201 };
                }

                // –î—Ä—É–≥–∏–µ –∫–æ–¥—ã - –æ—à–∏–±–∫–∞
                const errorText = await response.text();
                return { success: false, code: code, message: errorText };

            } catch (error) {
                return { success: false, code: 0, message: error.message };
            }
        }

        /**
         * –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–∞–ø–∫–∏ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–µ
         * @param {string} path - –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
         * @returns {Promise<boolean>} true –µ—Å–ª–∏ –ø–∞–ø–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
         */
        async function checkYandexFolder(path) {
            const url = `https://cloud-api.yandex.net/v1/disk/resources?path=${encodeURIComponent(path)}`;

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `OAuth ${YANDEX_OAUTH_TOKEN}`
                    }
                });

                return response.status === 200;
            } catch (error) {
                console.warn('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞–ø–∫–∏:', error);
                return false;
            }
        }

        // ==================================================================
        // üî• –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ù–û–ü–û–ö –Ø–ù–î–ï–ö–°.–î–ò–°–ö –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï –ë–ê–õ–£–ù–ê
        // ==================================================================

        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –±–∞–ª—É–Ω–∞
         * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–µ
         */
        async function initYandexDiskButtons() {
            // –ò—â–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ —Å data-yandex-object –∞—Ç—Ä–∏–±—É—Ç–æ–º
            const buttons = document.querySelectorAll('[data-yandex-object]');

            for (const btn of buttons) {
                const objectId = btn.getAttribute('data-yandex-object');
                const yandexLink = btn.getAttribute('data-yandex-link');

                if (!objectId || !yandexLink) continue;

                // üî• –ü–†–û–í–ï–†–Ø–ï–ú –°–¢–ê–¢–£–° –û–ë–™–ï–ö–¢–ê
                const object = objectsData.find(obj => obj.id == objectId);
                if (!object) continue;

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å: –∞–∫—Ç–∏–≤–Ω—ã–π –æ–±—ä–µ–∫—Ç = –≤—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω
                const isActive = object.entryTime && !object.exitTime;

                // üî• –ï–°–õ–ò –í–•–û–î –ù–ï –í–´–ü–û–õ–ù–ï–ù - –ü–†–û–°–¢–û –û–¢–ö–†–´–í–ê–ï–ú –°–°–´–õ–ö–£
                if (!isActive) {
                    btn.innerHTML = 'üìÅ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫';
                    btn.onclick = function () {
                        window.open(yandexLink, '_blank');
                    };
                    continue; // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π –∫–Ω–æ–ø–∫–µ
                }

                // üî• –ï–°–õ–ò –í–•–û–î –í–´–ü–û–õ–ù–ï–ù - –ò–°–ü–û–õ–¨–ó–£–ï–ú –°–£–©–ï–°–¢–í–£–Æ–©–£–Æ –õ–û–ì–ò–ö–£ –° –°–û–ó–î–ê–ù–ò–ï–ú –ü–ê–ü–û–ö
                // –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è –ø–∞–ø–∫–∏ —Å —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–æ–π –∏ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–æ–º
                const now = new Date();
                const dd = String(now.getDate()).padStart(2, '0');
                const mm = String(now.getMonth() + 1).padStart(2, '0');
                const yyyy = now.getFullYear();
                const dateStr = `${dd}.${mm}.${yyyy}`;
                const mainFolderName = `${dateStr} ${currentUser}`;

                // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ –∏–∑ —Å—Å—ã–ª–∫–∏ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ handleYandexDiskButton)
                let folderPath = '';

                if (yandexLink.includes('/client/disk/')) {
                    const pathPart = yandexLink.split('/client/disk/')[1];
                    folderPath = decodeURIComponent(pathPart.split('?')[0]);
                } else {
                    folderPath = `${YANDEX_ROOT_PATH}/${objectId}`;
                }

                const folderPathToCheck = `${folderPath}/${mainFolderName}`;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏ —á–µ—Ä–µ–∑ API
                const folderExists = await checkYandexFolder(folderPathToCheck);

                if (folderExists) {
                    // –ü–∞–ø–∫–∞ —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞ —Å–µ–≥–æ–¥–Ω—è —ç—Ç–∏–º –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–æ–º
                    const directLink = `https://disk.yandex.ru/client/disk/${encodeURIComponent(folderPathToCheck)}`;

                    btn.innerHTML = 'üìÇ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ–æ—Ç—á–µ—Ç';
                    btn.onclick = function () {
                        window.open(directLink, '_blank');
                    };
                } else {
                    // –ü–∞–ø–∫–∏ –Ω–µ—Ç - –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å
                    btn.innerHTML = 'üìÅ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫';
                    btn.onclick = function () {
                        handleYandexDiskButton(objectId, yandexLink);
                    };
                }
            }
        }
    </script>
</body>

</html>